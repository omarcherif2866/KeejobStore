{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Validators } from '@angular/forms';\nimport { RDV } from 'src/app/components/models/rdv';\nimport { Expert } from 'src/app/components/models/expert';\nimport { Clients } from 'src/app/components/models/clients';\nimport dayGridPlugin from '@fullcalendar/daygrid';\nimport timeGridPlugin from '@fullcalendar/timegrid';\nimport interactionPlugin from '@fullcalendar/interaction';\nlet RdvComponent = class RdvComponent {\n  constructor(rdvService, messageService, formBuilder, sanitizer, expertService, clientService) {\n    this.rdvService = rdvService;\n    this.messageService = messageService;\n    this.formBuilder = formBuilder;\n    this.sanitizer = sanitizer;\n    this.expertService = expertService;\n    this.clientService = clientService;\n    this.displayDialog = false; // Pour afficher le dialogue\n\n    this.displayModal = false;\n    this.selectedDescription = '';\n    this.rdvs = [];\n    this.selectedRDVs = [];\n    this.rdvDialog = false;\n    this.submitted = false;\n    this.actionLabel = 'Enregistrer';\n    this.cols = [];\n    this.rowsPerPageOptions = [5, 10, 20];\n    this.deleteRDVDialog = false;\n    this.Experts = [];\n    this.clients = [];\n    this.adminId = null;\n    this.showCalendar = false;\n    this.events = [];\n    this.userRole = null;\n  }\n\n  ngOnInit() {\n    this.rdv = new RDV('', '', '', '', new Expert('', '', '', '', '', '', 0, '', ''), new Clients('', '', '', '', '', '', 'PersonnePhysique'));\n    this.getAllRDVs();\n    this.initializeForm();\n    this.initializeCalendarOptions(); // this.getAllExperts()\n\n    this.getAllClients();\n    this.userRole = localStorage.getItem('userRole');\n  }\n\n  showFullDescription(description) {\n    this.selectedDescription = description;\n    this.displayModal = true;\n  }\n\n  initializeForm() {\n    this.rdvForm = this.formBuilder.group({\n      description: [''],\n      date: [null, Validators.required],\n      heure: [null, Validators.required],\n      receiver: [null, Validators.required]\n    });\n  }\n\n  getUserRole() {\n    return localStorage.getItem('userRole');\n  }\n\n  getUserId() {\n    return localStorage.getItem('user_id') || ''; // Retourne l'ID de l'utilisateur connect√©\n  }\n\n  openNew() {\n    this.rdv = new RDV('', '', '', '', new Expert('', '', '', '', '', '', 0, '', ''), new Clients('', '', '', '', '', '', 'PersonnePhysique'));\n    this.submitted = false;\n    this.rdvDialog = true;\n    this.actionLabel = 'Enregistrer';\n  }\n\n  openRDVDialog(rdv) {\n    console.log('rdv re√ßu :', rdv);\n    this.rdv = new RDV(rdv.Id, rdv.Description, rdv.Date, rdv.Heure, rdv.OwnedBy, rdv.Receiver);\n    this.selectedRDVs = [rdv];\n    this.rdvDialog = true;\n  }\n\n  editRDV(rdv) {\n    this.rdv = new RDV(rdv.Id, rdv.Description, rdv.Date, rdv.Heure, rdv.OwnedBy, rdv.Receiver);\n    this.rdvForm.patchValue({\n      description: rdv.Description,\n      date: rdv.Date ? new Date(rdv.Date) : null\n    });\n    this.rdvDialog = true;\n    this.actionLabel = 'Modifier';\n  }\n\n  deleteRDV(rdv) {\n    if (rdv && rdv.Id) {\n      this.deleteRDVDialog = true;\n      this.rdv = new RDV(rdv.Id, rdv.Description, rdv.Date, rdv.Heure, rdv.OwnedBy, rdv.Receiver);\n    } else {\n      console.error('rdv object is missing ID:', rdv);\n    }\n  }\n\n  confirmDelete() {\n    if (this.rdv && this.rdv.Id) {\n      this.rdvService.deleteRDV(this.rdv.Id).subscribe(response => {\n        this.rdvs = this.rdvs.filter(val => val.Id !== this.rdv.Id);\n        this.messageService.add({\n          severity: 'success',\n          summary: 'Successful',\n          detail: 'Rendez-vous √† √©t√© supprim√© avec succes',\n          life: 3000\n        });\n        this.rdv = new RDV('', '', '', '', new Expert('', '', '', '', '', '', 0, '', ''), new Clients('', '', '', '', '', '', 'PersonnePhysique'));\n        this.deleteRDVDialog = false;\n      }, error => {\n        console.error('Error deleting rdv:', error);\n        this.messageService.add({\n          severity: 'error',\n          summary: 'Error',\n          detail: 'Failed to Delete rdv',\n          life: 3000\n        });\n        this.deleteRDVDialog = false;\n      });\n    } else {\n      console.error('Invalid reunion ID:', this.rdv);\n      this.messageService.add({\n        severity: 'error',\n        summary: 'Error',\n        detail: 'Invalid reunion ID',\n        life: 3000\n      });\n      this.deleteRDVDialog = false;\n    }\n  }\n\n  hideDialog() {\n    this.rdvDialog = false;\n    this.submitted = false;\n  }\n\n  saveRDV() {\n    var _a, _b, _c, _d, _e, _f, _g, _h, _j;\n\n    this.submitted = true;\n\n    if (this.rdvForm.invalid) {\n      console.error('Veuillez remplir tous les champs obligatoires.');\n      return;\n    }\n\n    const formData = new FormData();\n    formData.append('description', (_a = this.rdvForm.get('description')) === null || _a === void 0 ? void 0 : _a.value); // ‚úÖ Formatage de l'heure en \"HH:mm\"\n\n    const heure = (_b = this.rdvForm.get('heure')) === null || _b === void 0 ? void 0 : _b.value;\n\n    if (heure instanceof Date) {\n      const formattedHeure = heure.toISOString().split('T')[1].substring(0, 5);\n      formData.append('heure', formattedHeure);\n    } else {\n      console.warn(\"L'heure est invalide ou non d√©finie.\");\n    } // ‚úÖ Formatage de la date en \"YYYY-MM-DD\"\n\n\n    const date = (_c = this.rdvForm.get('date')) === null || _c === void 0 ? void 0 : _c.value;\n\n    if (date) {\n      const formattedDate = date.toISOString().split('T')[0];\n      formData.append('date', formattedDate);\n    } else {\n      console.warn('La date est vide ou non d√©finie.');\n    }\n\n    const userRole = this.getUserRole();\n    const userId = this.getUserId();\n    let ownedBy = '';\n    let receiver = null; // ‚úÖ Attribution des r√¥les\n\n    if (userRole === 'expert') {\n      ownedBy = userId;\n      receiver = ((_e = (_d = this.rdvForm.get('receiver')) === null || _d === void 0 ? void 0 : _d.value) === null || _e === void 0 ? void 0 : _e._id) || ((_f = this.rdvForm.get('receiver')) === null || _f === void 0 ? void 0 : _f.value);\n    } else if (userRole === 'PersonnePhysique' || userRole === 'PersonneMorale') {\n      receiver = userId;\n      ownedBy = ((_h = (_g = this.rdvForm.get('ownedBy')) === null || _g === void 0 ? void 0 : _g.value) === null || _h === void 0 ? void 0 : _h._id) || ((_j = this.rdvForm.get('ownedBy')) === null || _j === void 0 ? void 0 : _j.value);\n    } else {\n      console.error(\"R√¥le utilisateur non valide pour la cr√©ation d'un RDV.\");\n      return;\n    }\n\n    formData.append('ownedBy', ownedBy);\n\n    if (receiver) {\n      formData.append('receiver', receiver);\n    }\n\n    if (this.rdv.Id) {\n      this.rdvService.putRDV(this.rdv.Id, formData).subscribe(res => {\n        console.log('R√©ponse du backend pour la mise √† jour du RDV :', res);\n        this.rdvDialog = false;\n        this.messageService.add({\n          severity: 'success',\n          summary: 'Succ√®s',\n          detail: 'RDV mis √† jour',\n          life: 3000\n        });\n        this.getAllRDVs();\n      }, error => {\n        console.error('Erreur lors de la mise √† jour du RDV :', error);\n        this.messageService.add({\n          severity: 'error',\n          summary: 'Erreur lors de la mise √† jour du RDV',\n          detail: error.message\n        });\n      });\n    } else {\n      this.rdvService.addRDV(ownedBy, formData).subscribe(res => {\n        console.log('R√©ponse du backend pour l\\'ajout du RDV :', res);\n        this.rdvDialog = false;\n        this.messageService.add({\n          severity: 'success',\n          summary: 'Succ√®s',\n          detail: 'RDV ajout√©',\n          life: 3000\n        });\n        this.getAllRDVs();\n      }, error => {\n        console.error('Erreur lors de l\\'ajout du RDV :', error);\n        this.messageService.add({\n          severity: 'error',\n          summary: 'Erreur lors de l\\'ajout du RDV',\n          detail: error.message\n        });\n      });\n    }\n  }\n\n  getAllRDVs() {\n    this.rdvService.getRDVsByCriteria().subscribe(rdvs => {\n      console.log('RDVs r√©cup√©r√©s:', rdvs);\n      this.rdvs = rdvs.map(rdv => RDV.fromJSON(rdv)); // Conversion en instances de RDV\n\n      this.events = this.rdvs.map(rdv => {\n        var _a, _b;\n\n        const eventDate = rdv.Date; // Doit √™tre au format YYYY-MM-DD\n\n        const eventHeure = rdv.Heure; // Doit √™tre au format HH:mm\n\n        const eventDateTime = `${eventDate}T${eventHeure}:00`; // Ajout des secondes pour √©viter les erreurs\n\n        console.log(`√âv√©nement ajout√©: ${eventDateTime}`);\n        return {\n          title: `üïí ${rdv.Heure || 'Rendez-vous'}`,\n          start: eventDateTime,\n          extendedProps: {\n            rdv: rdv,\n            ownerEmail: (_a = rdv.OwnedBy) === null || _a === void 0 ? void 0 : _a.Email,\n            receiverEmail: (_b = rdv.Receiver) === null || _b === void 0 ? void 0 : _b.Email\n          }\n        };\n      });\n      console.log('√âv√©nements du calendrier:', this.events);\n      this.initializeCalendarOptions();\n    }, error => {\n      console.error('Erreur lors de la r√©cup√©ration des RDVs:', error);\n    });\n  }\n\n  onGlobalFilter(table, event) {\n    table.filterGlobal(event.target.value, 'contains');\n  }\n\n  initializeCalendarOptions() {\n    this.calendarOptions = {\n      plugins: [dayGridPlugin, timeGridPlugin, interactionPlugin],\n      headerToolbar: {\n        left: 'prev',\n        center: 'title',\n        right: 'next'\n      },\n      initialView: 'dayGridMonth',\n      locale: 'fr',\n      height: '500px',\n      events: this.events,\n      eventContent: this.renderEventContent.bind(this),\n      eventClick: this.handleEventClick.bind(this),\n      eventDidMount: info => {\n        const el = info.el;\n        el.style.backgroundColor = '#007bff'; // Bleu\n\n        el.style.color = 'white'; // Texte blanc\n\n        el.style.borderRadius = '5px';\n        el.style.padding = '10px';\n        el.style.textAlign = 'center'; // Centrer le texte\n\n        el.style.display = 'flex'; // Flexbox pour occuper tout l'espace\n\n        el.style.alignItems = 'center'; // Centrer verticalement\n\n        el.style.justifyContent = 'center'; // Centrer horizontalement\n\n        el.style.height = '100%'; // Remplir toute la cellule\n\n        el.style.cursor = 'pointer'; // const rdv = info.event.extendedProps.rdv;\n        // const description = rdv?.Description || 'Pas de description';\n        // const heure = rdv?.Heure || 'Heure non d√©finie';\n        //  el.setAttribute('title', `üìÖ RDV: ${description}\\nüïí Heure: ${heure}`);\n\n        el.setAttribute('title', `D√©tails du rendez-vous`);\n      }\n    };\n  }\n\n  handleEventClick(event) {\n    const rdv = event.event.extendedProps.rdv; // Assurez-vous que les d√©tails du rdv sont stock√©s ici\n\n    console.log('RDV s√©lectionn√©:', rdv); // Pour d√©boguer\n\n    this.openDialog(rdv); // Ouvrir le dialog avec le rdv s√©lectionn√©\n  }\n\n  onDialogHide() {\n    this.selectedRDVs = []; // R√©initialiser les d√©tails des rdvs\n  }\n\n  openDialog(rdv) {\n    console.log('Tentative d\\'ouverture du dialog avec le rdv:', rdv); // Avant\n\n    this.selectedRDVs = [rdv]; // Mettre le rdv s√©lectionn√© dans un tableau\n\n    this.displayDialog = true; // Afficher le dialog\n\n    console.log('RDV s√©lectionn√©:', this.selectedRDVs); // Apr√®s\n  }\n\n  renderEventContent(eventInfo) {\n    var _a;\n\n    const rdv = eventInfo.event.extendedProps.rdv;\n    return {\n      html: `<div style=\"font-size: 0.8em; color: white; padding: 5px; border-radius: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\">\n      <b>${eventInfo.event.title}</b>\n      ${rdv ? `<br>Avec: ${((_a = rdv.Receiver) === null || _a === void 0 ? void 0 : _a.Email) || 'N/A'}` : ''}\n    </div>`\n    };\n  }\n\n  toggleCalendar() {\n    this.showCalendar = !this.showCalendar; // Basculer l'affichage du calendrier\n  } // getAllExperts(): void {\n  //   this.expertService.getExpert().subscribe(ss => {\n  //     // Afficher les utilisateurs r√©cup√©r√©s dans la console\n  //     console.log(\"Users r√©cup√©r√©es:\", ss);\n  //     // Afficher les utilisateurs filtr√©s dans la console pour v√©rification\n  //     console.log(\"experts filtr√©s:\", this.Experts);\n  //   }, error => {\n  //     // Gestion des erreurs\n  //     console.error(\"Erreur lors de la r√©cup√©ration des utilisateurs:\", error);\n  //   });\n  // }\n\n\n  getAllClients() {\n    this.clientService.getUser().subscribe(ss => {\n      // Filtrer les utilisateurs pour ne garder que ceux avec userType = 'client'\n      this.clients = ss;\n      console.log(\"clients: \", ss);\n    }, error => {\n      console.error(\"Erreur lors de la r√©cup√©ration des utilisateurs:\", error);\n    });\n  }\n\n};\nRdvComponent = __decorate([Component({\n  selector: 'app-rdv',\n  templateUrl: './rdv.component.html',\n  styleUrl: './rdv.component.scss'\n})], RdvComponent);\nexport { RdvComponent };","map":null,"metadata":{},"sourceType":"module"}