{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport * as XLSX from 'xlsx';\nimport * as FileSaver from 'file-saver';\nimport * as am4core from \"@amcharts/amcharts4/core\";\nimport * as am4maps from \"@amcharts/amcharts4/maps\";\nimport am4geodata_tunisiaHigh from \"@amcharts/amcharts4-geodata/tunisiaHigh\";\nimport am4themes_animated from \"@amcharts/amcharts4/themes/animated\";\nam4core.useTheme(am4themes_animated);\nlet ChartsDemoComponent = class ChartsDemoComponent {\n  constructor(expertService, fournitureService, chartsService, UserService, cdr, documentService) {\n    this.expertService = expertService;\n    this.fournitureService = fournitureService;\n    this.chartsService = chartsService;\n    this.UserService = UserService;\n    this.cdr = cdr;\n    this.documentService = documentService;\n    this.expertsByRegion = [];\n    this.documentsByGouv = [];\n    this.selectedRegion = null;\n    this.displayDialog = false;\n    this.documentsCount = 0;\n    this.ppCount = 0;\n    this.pmCount = 0;\n    this.expertsCount = 0;\n    this.errorMessage = null;\n    this.userRole = null;\n    this.availableYears = [];\n    this.selectedYear = null;\n    this.originalData = []; // pour conserver les donnÃ©es originales\n  }\n\n  ngOnInit() {\n    this.gfg = [{\n      title: \"1. DÃ©clarer votre constat\",\n      Icon: \"pi pi-file-edit\",\n      color: \"#4874ad\",\n      link: \"/constat\"\n    }, {\n      title: \"2. DÃ©poser votre constat\",\n      Icon: \"pi pi-file-pdf\",\n      color: \"#3f70af\",\n      link: \"/documents\"\n    }, {\n      title: \"3. Votre Expert AffectÃ©\",\n      Icon: \"fas fa-user-tie\",\n      color: \"#2863b1\",\n      link: \"/documents\"\n    }, {\n      title: \"4. Rendez-vous avec l'expert\",\n      Icon: \"pi pi-fw pi-calendar-plus\",\n      color: \"#1559b3\",\n      link: \"/rendez-vous\"\n    }, {\n      title: \"5. DÃ©poser vos devis\",\n      Icon: \"pi pi-file-pdf\",\n      color: \"#0550b3\",\n      link: \"/devis_sinistres\"\n    }];\n    this.userRole = this.getUserRole();\n    this.fournitureChart();\n    this.loadChartData(); // pour le graphique\n\n    this.countClients();\n    this.countExperts();\n    this.loadChartFournitureEval();\n    this.countSinistre();\n  }\n\n  ngAfterViewInit() {\n    this.chartsService.getExpertsGroupedByRegion().subscribe(data => {\n      this.expertsByRegion = data;\n      this.createMap(data);\n    });\n    this.chartsService.getDocumentsGroupedByGouvernorat().subscribe(data => {\n      this.documentsByGouv = data;\n      this.createMapSinistre(data);\n    });\n  }\n\n  getUserRole() {\n    return localStorage.getItem('userRole');\n  }\n\n  loadChartData() {\n    this.chartsService.getOrdreMissionStats().subscribe(data => {\n      const labels = data.map(item => item.expert);\n      const counts = data.map(item => item.total);\n      this.chartData = {\n        labels,\n        datasets: [{\n          label: 'Ordres de mission',\n          data: counts,\n          backgroundColor: '#42A5F5'\n        }]\n      };\n      this.chartOptions = {\n        responsive: true,\n        plugins: {\n          legend: {\n            position: 'top'\n          },\n          title: {\n            display: true // text: 'Nombre dâ€™ordres de mission par expert'\n\n          }\n        }\n      };\n    });\n  }\n\n  createMapSinistre(data) {\n    const regionMap = {\n      'Tunis': 'TN-11',\n      'Ariana': 'TN-12',\n      'Ben Arous': 'TN-13',\n      'Manouba': 'TN-14',\n      'Nabeul': 'TN-21',\n      'Zaghouan': 'TN-22',\n      'Bizerte': 'TN-23',\n      'BÃ©ja': 'TN-31',\n      'Jendouba': 'TN-32',\n      'Kef': 'TN-33',\n      'Siliana': 'TN-34',\n      'Kairouan': 'TN-41',\n      'Kasserine': 'TN-42',\n      'Sidi Bouzid': 'TN-43',\n      'Sousse': 'TN-51',\n      'Monastir': 'TN-52',\n      'Mahdia': 'TN-53',\n      'Sfax': 'TN-61',\n      'Gafsa': 'TN-71',\n      'Tozeur': 'TN-72',\n      'Kebili': 'TN-73',\n      'GabÃ¨s': 'TN-82',\n      'MÃ©denine': 'TN-83',\n      'Tataouine': 'TN-84'\n    };\n    const chart = am4core.create(\"chartdivSinistre\", am4maps.MapChart);\n    chart.geodata = am4geodata_tunisiaHigh;\n    chart.projection = new am4maps.projections.Miller();\n    chart.chartContainer.wheelable = false;\n    chart.seriesContainer.draggable = false;\n    chart.seriesContainer.resizable = false;\n    chart.maxZoomLevel = 1;\n    const polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());\n    polygonSeries.useGeodata = true;\n    polygonSeries.data = data.filter(gouvernorat => regionMap[gouvernorat._id]).map(gouvernorat => ({\n      id: regionMap[gouvernorat._id],\n      name: gouvernorat._id,\n      value: gouvernorat.count,\n      customData: gouvernorat.documents\n    }));\n    polygonSeries.mapPolygons.template.tooltipText = \"{name}: {value} sinistres\";\n    polygonSeries.mapPolygons.template.fill = am4core.color(\"#74B266\"); // ðŸŽ¨ DÃ©gradÃ© automatique : clair â†’ foncÃ© selon la valeur\n\n    polygonSeries.heatRules.push({\n      property: \"fill\",\n      target: polygonSeries.mapPolygons.template,\n      min: am4core.color(\"#f58f8f\"),\n      max: am4core.color(\"#ff0000\") // foncÃ© (bcp de sinistres)\n\n    });\n    const hs = polygonSeries.mapPolygons.template.states.create(\"hover\");\n    hs.properties.fill = am4core.color(\"#ff0000\");\n    polygonSeries.mapPolygons.template.events.on(\"hit\", ev => {\n      var _a;\n\n      const data = (_a = ev.target.dataItem) === null || _a === void 0 ? void 0 : _a.dataContext;\n\n      if (data && data.customData && data.customData.length > 0) {\n        this.selectedRegion = {\n          name: data.name,\n          count: data.value,\n          experts: data.customData\n        };\n        this.displayDialog = true;\n      }\n    });\n    this.chart = chart;\n  }\n\n  createMap(data) {\n    const regionMap = {\n      'Tunis': 'TN-11',\n      'Ariana': 'TN-12',\n      'Ben Arous': 'TN-13',\n      'Manouba': 'TN-14',\n      'Nabeul': 'TN-21',\n      'Zaghouan': 'TN-22',\n      'Bizerte': 'TN-23',\n      'BÃ©ja': 'TN-31',\n      'Jendouba': 'TN-32',\n      'Kef': 'TN-33',\n      'Siliana': 'TN-34',\n      'Kairouan': 'TN-41',\n      'Kasserine': 'TN-42',\n      'Sidi Bouzid': 'TN-43',\n      'Sousse': 'TN-51',\n      'Monastir': 'TN-52',\n      'Mahdia': 'TN-53',\n      'Sfax': 'TN-61',\n      'Gafsa': 'TN-71',\n      'Tozeur': 'TN-72',\n      'Kebili': 'TN-73',\n      'GabÃ¨s': 'TN-82',\n      'MÃ©denine': 'TN-83',\n      'Tataouine': 'TN-84'\n    };\n    const chart = am4core.create(\"chartdiv\", am4maps.MapChart);\n    chart.geodata = am4geodata_tunisiaHigh;\n    chart.projection = new am4maps.projections.Miller();\n    chart.chartContainer.wheelable = false;\n    chart.seriesContainer.draggable = false;\n    chart.seriesContainer.resizable = false;\n    chart.maxZoomLevel = 1; // EmpÃªche le zoom\n\n    const polygonSeries = chart.series.push(new am4maps.MapPolygonSeries());\n    polygonSeries.useGeodata = true;\n    polygonSeries.data = data.filter(region => regionMap[region._id]).map(region => ({\n      id: regionMap[region._id],\n      name: region._id,\n      value: region.count,\n      customData: region.experts\n    }));\n    polygonSeries.mapPolygons.template.tooltipText = \"{name}: {value} experts\";\n    polygonSeries.mapPolygons.template.fill = am4core.color(\"#74B266\");\n    const hs = polygonSeries.mapPolygons.template.states.create(\"hover\");\n    hs.properties.fill = am4core.color(\"#367B25\"); // Remplacer alert par un dialog\n\n    polygonSeries.mapPolygons.template.events.on(\"hit\", ev => {\n      var _a;\n\n      const data = (_a = ev.target.dataItem) === null || _a === void 0 ? void 0 : _a.dataContext;\n\n      if (data && data.customData && data.customData.length > 0) {\n        this.selectedRegion = {\n          name: data.name,\n          count: data.value,\n          experts: data.customData\n        };\n        this.displayDialog = true;\n      }\n    });\n    this.chart = chart;\n  }\n\n  ngOnDestroy() {\n    if (this.chart) {\n      this.chart.dispose();\n    }\n  }\n\n  fournitureChart() {\n    this.chartsService.compterFournitures().subscribe(data => {\n      this.prepareChartData(data);\n    });\n  }\n\n  prepareChartData(data) {\n    // PrÃ©parer les donnÃ©es pour le graphique\n    const labels = Object.keys(data); // Les noms des fournitures\n\n    const values = Object.values(data); // Le nombre de chaque fourniture\n    // Fonction pour gÃ©nÃ©rer une couleur alÃ©atoire\n\n    const generateRandomColor = () => {\n      const randomColor = Math.floor(Math.random() * 16777215).toString(16);\n      return `#${randomColor}`;\n    }; // GÃ©nÃ©rer un tableau de couleurs pour chaque option (fourniture)\n\n\n    const colors = labels.map(() => generateRandomColor());\n    this.chartFournitureData = {\n      labels: labels,\n      datasets: [{\n        data: values,\n        label: 'Comptage des fournitures',\n        backgroundColor: colors,\n        borderColor: '#ffffff',\n        borderWidth: 2\n      }]\n    };\n    this.chartFournitureOptions = {\n      responsive: true,\n      maintainAspectRatio: false,\n      plugins: {\n        legend: {\n          position: 'top',\n          onClick: (e, legendItem, legend) => {\n            const index = legendItem.index;\n            const ci = legend.chart;\n            const meta = ci.getDatasetMeta(0);\n            const alreadyActive = meta.data[index].hidden === false; // Masquer tous les autres sauf celui cliquÃ©\n\n            meta.data.forEach((item, i) => {\n              item.hidden = i === index ? false : true;\n            }); // Si l'Ã©lÃ©ment Ã©tait dÃ©jÃ  actif seul, tout rÃ©afficher\n\n            if (alreadyActive) {\n              meta.data.forEach(item => item.hidden = false);\n            }\n\n            ci.update();\n          }\n        }\n      }\n    };\n  }\n\n  countClients() {\n    this.UserService.getClientsCount().subscribe({\n      next: data => {\n        this.ppCount = data.PPCount; // Ensure this matches the API response\n\n        this.pmCount = data.PMCount; // Ensure this matches the API response\n\n        this.cdr.detectChanges(); // Manually trigger change detection\n      },\n      error: err => {\n        console.error('Erreur lors de la rÃ©cupÃ©ration du nombre de clients:', err);\n      }\n    });\n  }\n\n  countExperts() {\n    this.expertService.getExpertsCount().subscribe({\n      next: data => {\n        this.expertsCount = data.expertsCount; // Ensure this matches the API response\n\n        this.cdr.detectChanges(); // Manually trigger change detection\n\n        console.log(this.expertsCount);\n      },\n      error: err => {\n        console.error('Erreur lors de la rÃ©cupÃ©ration du nombre d\\'experts:', err);\n      }\n    });\n  }\n\n  countSinistre() {\n    this.documentService.getDocumentsCount().subscribe({\n      next: data => {\n        this.documentsCount = data.documentsCount; // Ensure this matches the API response\n\n        this.cdr.detectChanges(); // Manually trigger change detection\n\n        console.log(this.documentsCount);\n      },\n      error: err => {\n        console.error('Erreur lors de la rÃ©cupÃ©ration du nombre de sinistres:', err);\n      }\n    });\n  }\n\n  exportOrdresMissionToExcel() {\n    if (!this.chartData || !this.chartData.labels) return;\n    const wsData = [[\"Ordres de mission par expert\"]];\n    this.chartData.labels.forEach((label, index) => {\n      wsData.push([label, this.chartData.datasets[0].data[index]]);\n    });\n    this.generateExcel(wsData, 'ordres-mission-experts.xlsx');\n  }\n\n  exportFournituresToExcel() {\n    if (!this.chartFournitureData || !this.chartFournitureData.labels) return;\n    const wsData = [[\"PiÃ¨ces dÃ©tectÃ©es\"]];\n    this.chartFournitureData.labels.forEach((label, index) => {\n      wsData.push([label, this.chartFournitureData.datasets[0].data[index]]);\n    });\n    this.generateExcel(wsData, 'pieces-detectees.xlsx');\n  }\n\n  generateExcel(data, filename) {\n    const worksheet = XLSX.utils.aoa_to_sheet(data);\n    const workbook = {\n      Sheets: {\n        'Rapport': worksheet\n      },\n      SheetNames: ['Rapport']\n    };\n    const excelBuffer = XLSX.write(workbook, {\n      bookType: 'xlsx',\n      type: 'array'\n    });\n    const blob = new Blob([excelBuffer], {\n      type: 'application/octet-stream'\n    });\n    FileSaver.saveAs(blob, filename);\n  }\n\n  loadChartFournitureEval() {\n    this.fournitureService.getFournituresEval().subscribe(res => {\n      this.originalData = res; // Extraire les annÃ©es disponibles\n\n      this.availableYears = [...new Set(res.map(item => {\n        var _a;\n\n        return new Date(((_a = item.createdAt) === null || _a === void 0 ? void 0 : _a.$date) || item.createdAt).getFullYear();\n      }))].sort((a, b) => a - b); // Grouper les donnÃ©es\n\n      const groupedData = {};\n      res.forEach(item => {\n        var _a, _b;\n\n        const fournitureName = ((_a = item.fourniture) === null || _a === void 0 ? void 0 : _a.nom) || 'Inconnu';\n        const dateStr = ((_b = item.createdAt) === null || _b === void 0 ? void 0 : _b.$date) || item.createdAt;\n        const dateObj = new Date(dateStr);\n        const date = dateObj.toLocaleDateString();\n        const prix = parseFloat(item.prix); // Filtrage par annÃ©e sÃ©lectionnÃ©e\n\n        if (this.selectedYear && dateObj.getFullYear() !== this.selectedYear) {\n          return;\n        }\n\n        if (!groupedData[fournitureName]) {\n          groupedData[fournitureName] = {\n            dates: [],\n            prix: []\n          };\n        }\n\n        groupedData[fournitureName].dates.push(date);\n        groupedData[fournitureName].prix.push(prix);\n      }); // Fusion et tri des dates\n\n      const allDatesSet = new Set();\n      Object.values(groupedData).forEach(group => {\n        group.dates.forEach(date => allDatesSet.add(date));\n      });\n      const sortedLabels = Array.from(allDatesSet).sort((a, b) => new Date(a).getTime() - new Date(b).getTime()); // CrÃ©ation des datasets\n\n      const datasets = Object.entries(groupedData).map(([fournitureName, group]) => {\n        const color = this.getColorFromString(fournitureName);\n        const dataAligned = sortedLabels.map(label => {\n          const indexInGroup = group.dates.indexOf(label);\n          return indexInGroup !== -1 ? group.prix[indexInGroup] : null;\n        });\n        return {\n          label: fournitureName,\n          data: dataAligned,\n          fill: false,\n          borderColor: color,\n          tension: 0.4\n        };\n      });\n      this.fournitureData = {\n        labels: sortedLabels,\n        datasets\n      };\n      this.fournitureOptions = {\n        responsive: true,\n        plugins: {\n          legend: {\n            display: true\n          },\n          tooltip: {\n            mode: 'nearest',\n            intersect: true,\n            callbacks: {\n              label: tooltipItem => {\n                const value = tooltipItem.formattedValue;\n                const label = tooltipItem.dataset.label;\n                return `${label}: ${value} DT`;\n              }\n            }\n          }\n        },\n        scales: {\n          x: {\n            title: {\n              display: true,\n              text: 'Date'\n            }\n          },\n          y: {\n            title: {\n              display: true,\n              text: 'Prix (DT)'\n            }\n          }\n        }\n      };\n    });\n  }\n\n  getColorFromString(str) {\n    let hash = 0;\n\n    for (let i = 0; i < str.length; i++) {\n      hash = str.charCodeAt(i) + ((hash << 5) - hash);\n    }\n\n    let color = '#';\n\n    for (let i = 0; i < 3; i++) {\n      const value = hash >> i * 8 & 0xFF;\n      color += ('00' + value.toString(16)).slice(-2);\n    }\n\n    return color;\n  }\n\n  filterByYear(year) {\n    this.selectedYear = year;\n    const filtered = this.originalData.filter(item => {\n      var _a;\n\n      const date = new Date(((_a = item.createdAt) === null || _a === void 0 ? void 0 : _a.$date) || item.createdAt);\n      return date.getFullYear() === year;\n    });\n    this.buildChartData(filtered);\n  }\n\n  resetFilter() {\n    this.selectedYear = null; // ou undefined selon ton initialisation\n\n    this.buildChartData(this.originalData);\n  }\n\n  buildChartData(data) {\n    const groupedData = {};\n    data.forEach(item => {\n      var _a, _b;\n\n      const fournitureName = ((_a = item.fourniture) === null || _a === void 0 ? void 0 : _a.nom) || 'Inconnu';\n      const dateStr = ((_b = item.createdAt) === null || _b === void 0 ? void 0 : _b.$date) || item.createdAt;\n      const date = new Date(dateStr).toLocaleDateString();\n      const prix = parseFloat(item.prix);\n\n      if (!groupedData[fournitureName]) {\n        groupedData[fournitureName] = {\n          dates: [],\n          prix: []\n        };\n      }\n\n      groupedData[fournitureName].dates.push(date);\n      groupedData[fournitureName].prix.push(prix);\n    });\n    const allDatesSet = new Set();\n    Object.values(groupedData).forEach(group => {\n      group.dates.forEach(date => allDatesSet.add(date));\n    });\n    const sortedLabels = Array.from(allDatesSet).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());\n    const datasets = Object.entries(groupedData).map(([fournitureName, group]) => {\n      const color = this.getColorFromString(fournitureName);\n      const dataAligned = sortedLabels.map(label => {\n        const index = group.dates.indexOf(label);\n        return index !== -1 ? group.prix[index] : null;\n      });\n      return {\n        label: fournitureName,\n        data: dataAligned,\n        fill: false,\n        borderColor: color,\n        tension: 0.4\n      };\n    });\n    this.fournitureData = {\n      labels: sortedLabels,\n      datasets\n    };\n  }\n\n  onYearChange(value) {\n    if (value === '') {\n      this.selectedYear = null;\n      this.buildChartData(this.originalData);\n    } else {\n      this.selectedYear = +value; // convertir en number\n\n      this.filterByYear(this.selectedYear);\n    }\n  }\n\n};\nChartsDemoComponent = __decorate([Component({\n  templateUrl: './chartsdemo.component.html',\n  styleUrl: './chartsdemo.component.scss'\n})], ChartsDemoComponent);\nexport { ChartsDemoComponent };","map":null,"metadata":{},"sourceType":"module"}