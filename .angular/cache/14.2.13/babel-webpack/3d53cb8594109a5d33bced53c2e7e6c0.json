{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { forkJoin } from 'rxjs';\nimport { Clients } from 'src/app/components/models/clients';\nimport { Documents } from 'src/app/components/models/documents';\nimport { Expert } from 'src/app/components/models/expert';\nimport { ImageSinistre } from 'src/app/components/models/image-sinistre';\nlet ImageSinistreComponent = class ImageSinistreComponent {\n  constructor(expertService, authservice, documentService, messageService, imageService, sanitizer) {\n    this.expertService = expertService;\n    this.authservice = authservice;\n    this.documentService = documentService;\n    this.messageService = messageService;\n    this.imageService = imageService;\n    this.sanitizer = sanitizer;\n    this.displayModal = false; // Contrôle la visibilité du modal\n\n    this.imageSinistreDialog = false;\n    this.actionLabel = 'Enregistrer';\n    this.deleteImageDialog = false;\n    this.imageSinistres = [];\n    this.submitted = false;\n    this.selectedImages = [];\n    this.displayDialog = false;\n    this.selectedImage = null;\n    this.imagesList = [];\n    this.currentIndex = 0;\n    this.selectedFiles = [];\n    this.expertId = null;\n    this.clients = [];\n    this.selectedClientId = null;\n    this.documentsCommun = []; // ✅ Correction du type\n\n    this.selectedDocument = null;\n    this.cols = [];\n    this.rowsPerPageOptions = [5, 10, 20];\n    this.expertInfos = {}; // Stocke les infos par document ID\n\n    this.selectedExpert = null;\n    this.displayExpertDialog = false;\n    this.selectedPdf = null;\n    this.selectedPdfName = ''; // Stocke le nom du PDF\n\n    this.displayPdfDialog = false;\n    this.displayClientDialog = false;\n    this.selectedClient = null;\n  }\n\n  ngOnInit() {\n    const userRole = this.getUserRole(); // Récupérer le rôle\n\n    this.expertId = this.getUserId();\n    console.log(\"Expert ID récupéré :\", this.expertId); // Vérifier l'ID récupéré\n\n    if (userRole === \"expert\") {\n      if (this.expertId) {\n        this.getClientsByExpert(this.expertId);\n      }\n    }\n\n    this.getAllImages();\n  }\n\n  getUserRole() {\n    return localStorage.getItem('userRole');\n  }\n\n  openNew() {\n    this.imageSinistre = new ImageSinistre([], [], new Expert('', '', '', '', '', '', 0, '', ''), // Fournir des valeurs par défaut\n    new Clients('', '', '', '', '', '', 'PersonneMorale'), // Fournir des valeurs par défaut\n    new Date(), new Documents('', '', '') // Fournir des valeurs par défaut\n    );\n    this.submitted = false;\n    this.imageSinistreDialog = true;\n    this.actionLabel = 'Enregistrer';\n  }\n\n  getUserId() {\n    return localStorage.getItem('user_id');\n  } // Récupérer la liste des clients liés à l'expert\n\n\n  getClientsByExpert(expertId) {\n    this.expertService.getExpertById(expertId).subscribe(expert => {\n      console.log(\"Réponse API Expert :\", expert);\n\n      if (expert && expert.clients && Array.isArray(expert.clients)) {\n        const clientIds = expert.clients; // Liste des IDs des clients\n\n        this.clients = [];\n        clientIds.forEach(clientId => {\n          this.authservice.getUserProfile(clientId).subscribe(clientData => {\n            this.clients.push(clientData);\n            console.log(\"Client récupéré :\", clientData);\n          }, error => {\n            console.error(\"Erreur lors de la récupération du client :\", error);\n          });\n        });\n      } else {\n        console.warn(\"Aucun client trouvé pour cet expert.\");\n        this.clients = [];\n      }\n    }, error => {\n      console.error(\"Erreur lors de la récupération des clients :\", error);\n    });\n  } // Récupérer les documents communs entre le client et l'expert\n\n\n  getDocumentsCommun() {\n    if (!this.selectedClientId || !this.expertId) return;\n    this.expertService.getExpertById(this.expertId).subscribe(expert => {\n      this.authservice.getUserProfile(this.selectedClientId).subscribe(client => {\n        const expertDocs = expert.documents || [];\n        const clientDocs = client.documents || []; // Trouver les documents en commun (IDs)\n\n        const documentsCommunIds = clientDocs.filter(doc => expertDocs.includes(doc)); // Récupérer les objets `Documents` complets\n\n        const requests = documentsCommunIds.map(id => this.documentService.getDocById(id));\n        forkJoin(requests).subscribe(documents => {\n          // ✅ Convertir en objets pour forcer la détection\n          this.documentsCommun = documents.map(d => Object.assign(new Documents(\"\", \"\", \"\"), d));\n          console.log(\"Documents communs :\", this.documentsCommun);\n        }, error => {\n          console.error(\"Erreur lors de la récupération des documents :\", error);\n        });\n      }, error => {\n        console.error(\"Erreur lors de la récupération des documents du client :\", error);\n      });\n    }, error => {\n      console.error(\"Erreur lors de la récupération des documents de l'expert :\", error);\n    });\n  }\n\n  onFileSelected(event) {\n    this.selectedFiles = Array.from(event.target.files);\n    console.log(\"Fichiers sélectionnés:\", this.selectedFiles);\n  }\n\n  uploadImages() {\n    if (!this.expertId || !this.selectedClientId || !this.selectedDocument) {\n      console.error(\"Veuillez sélectionner un client et un document avant l'envoi !\");\n      return;\n    }\n\n    if (!this.selectedFiles || this.selectedFiles.length === 0) {\n      console.error(\"Erreur : Aucun fichier sélectionné !\");\n      return;\n    }\n\n    console.log(\"Document ID sélectionné :\", this.selectedDocument.Id || this.selectedDocument.Id);\n    const formData = new FormData();\n    this.selectedFiles.forEach(file => {\n      if (file instanceof File) {\n        formData.append('image', file);\n      } else {\n        console.error(\"Fichier invalide détecté :\", file);\n      }\n    }); // Vérification que les fichiers sont bien ajoutés\n\n    if (!formData.has('image')) {\n      console.error(\"Aucun fichier ajouté à FormData !\");\n      return;\n    }\n\n    formData.append('expertId', this.expertId);\n    formData.append('clientId', this.selectedClientId);\n    formData.append('documentId', this.selectedDocument.Id || this.selectedDocument.Id);\n    console.log(\"Données envoyées :\");\n    formData.forEach((value, key) => console.log(`${key}:`, value));\n    this.expertService.addImageSinistre(formData).subscribe(response => {\n      console.log(\"Images envoyées avec succès :\", response);\n      this.selectedFiles = [];\n      this.selectedDocument = null;\n      window.location.reload();\n    }, error => {\n      console.error(\"Erreur lors de l'envoi des images :\", error);\n    });\n  }\n\n  removeFile(file) {\n    this.selectedFiles = this.selectedFiles.filter(f => f !== file);\n  }\n\n  onGlobalFilter(table, event) {\n    table.filterGlobal(event.target.value, 'contains');\n  }\n\n  getAllImages() {\n    if (!this.expertId) {\n      console.error('Aucun ID expert trouvé dans localStorage');\n      return;\n    }\n\n    if (this.getUserRole() === 'expert') {\n      this.expertService.getImagesByExpert(this.expertId).subscribe(images => {\n        console.log(\"Raw API response:\", JSON.stringify(images));\n        this.imageSinistres = images; // Récupérer les détails des experts pour chaque imageSinistre\n\n        this.imageSinistres.forEach((sinistre, index) => {\n          this.expertService.getExpertById(sinistre.Expert).subscribe(expertData => {\n            this.imageSinistres[index].Expert = expertData;\n          }, error => {\n            console.error(`Erreur lors de la récupération de l'expert ${sinistre.Expert}:`, error);\n          });\n        });\n        console.log(\"imageSinistres: \", this.imageSinistres);\n      }, error => {\n        console.error('Erreur lors de la récupération des images:', error);\n      });\n    } else if (this.getUserRole() === 'PersonnePhysique' || this.getUserRole() === 'PersonneMorale') {\n      this.authservice.getImagesByClient(this.expertId).subscribe(images => {\n        this.imageSinistres = images; // Récupérer les détails des experts pour chaque imageSinistre\n\n        this.imageSinistres.forEach((sinistre, index) => {\n          this.authservice.getUserProfile(sinistre.Client).subscribe(expertData => {\n            this.imageSinistres[index].Client = expertData;\n          }, error => {\n            console.error(`Erreur lors de la récupération du client ${sinistre.Client}:`, error);\n          });\n        });\n        console.log(\"imageSinistres: \", this.imageSinistres);\n      }, error => {\n        console.error('Erreur lors de la récupération des images:', error);\n      });\n    } else if (this.getUserRole() === 'admin' || this.getUserRole() === 'gestionnaire_sinistre') {\n      this.imageService.getImagesSinistres().subscribe(images => {\n        console.log(\"Raw API response:\", JSON.stringify(images));\n        this.imageSinistres = images;\n        console.log(\"imageSinistres: \", this.imageSinistres);\n      }, error => {\n        console.error('Erreur lors de la récupération des images:', error);\n      });\n    }\n  }\n\n  openDialog(images, index) {\n    this.imagesList = images;\n    this.currentIndex = index;\n    this.selectedImage = images[index];\n    this.displayDialog = true;\n  }\n\n  previousImage() {\n    if (this.currentIndex > 0) {\n      this.currentIndex--;\n      this.selectedImage = this.imagesList[this.currentIndex];\n    }\n  }\n\n  nextImage() {\n    if (this.currentIndex < this.imagesList.length - 1) {\n      this.currentIndex++;\n      this.selectedImage = this.imagesList[this.currentIndex];\n    }\n  }\n\n  ajouterImageAfterAccident() {\n    console.log('selectedImages:', this.selectedImages);\n\n    if (this.selectedImages && this.selectedImages.length > 0) {\n      const imageSinistre = this.selectedImages[0];\n      console.log('imageSinistre:', imageSinistre);\n\n      if (imageSinistre && imageSinistre.Id) {\n        const formData = new FormData();\n        imageSinistre.ImageAfterAccident.forEach(file => {\n          formData.append('imageAfterAccident', file, file.name); // Ajouter chaque fichier à FormData\n        });\n        this.expertService.ajouterImageAfterAccident(imageSinistre.Id, formData).subscribe(response => {\n          this.messageService.add({\n            severity: 'success',\n            summary: 'Succès',\n            detail: 'Image ajoutée avec succès'\n          });\n        }, error => {\n          this.messageService.add({\n            severity: 'error',\n            summary: 'Erreur',\n            detail: 'Échec de l’ajout de l’image'\n          });\n        });\n      } else {\n        this.messageService.add({\n          severity: 'error',\n          summary: 'Erreur',\n          detail: 'ID du sinistre non défini'\n        });\n      }\n    } else {\n      this.messageService.add({\n        severity: 'error',\n        summary: 'Erreur',\n        detail: 'Veuillez sélectionner une imageSinistre'\n      });\n    }\n  }\n\n  onImageSelect(event, imageSinistre) {\n    const files = event.target.files;\n\n    if (files) {\n      imageSinistre.imageAfterAccident = Array.from(files); // Stocker les fichiers directement\n\n      this.selectedImages = [imageSinistre];\n      this.ajouterImageAfterAccident();\n    }\n  }\n\n  getExpertInfo(expertId, docId) {\n    if (!expertId) {\n      console.error(\"Aucun ID d'expert fourni.\");\n      this.expertInfos[docId] = \"Il n'y a pas encore un expert affecté\";\n      return;\n    }\n\n    this.expertService.getExpertById(expertId).subscribe(expert => {\n      if (expert) {\n        this.expertInfos[docId] = `${expert.nom} ${expert.prenom} `;\n      } else {\n        this.expertInfos[docId] = \"Expert introuvable\";\n      }\n    }, error => {\n      this.expertInfos[docId] = \"Il n'y a pas d'expert affecté pour le moment\";\n    });\n  }\n\n  showExpertInfo(expertId) {\n    console.log(\"ID de l'expert reçu :\", expertId); // Vérification\n\n    if (!expertId) {\n      console.error(\"Aucun ID Expert fourni.\");\n      return;\n    }\n\n    this.expertService.getExpertById(expertId).subscribe(expert => {\n      console.log(\"Données de l'expert reçues :\", expert); // Vérification\n\n      this.selectedExpert = expert;\n      this.displayExpertDialog = true;\n    }, error => {\n      console.error(\"Erreur lors du chargement de l'expert :\", error);\n      this.selectedExpert = {\n        error: \"Erreur lors du chargement du client\"\n      };\n      this.displayExpertDialog = true;\n    });\n  }\n\n  showClientInfo(clientId) {\n    if (!clientId) {\n      console.error(\"Aucun ID client fourni.\");\n      return;\n    }\n\n    this.authservice.getUserProfile(clientId).subscribe(client => {\n      this.selectedClient = client; // Stocker les données du client\n\n      this.displayClientDialog = true; // Ouvrir le dialog\n    }, error => {\n      this.selectedClient = {\n        error: \"Erreur lors du chargement du client\"\n      };\n      this.displayClientDialog = true;\n    });\n  }\n\n  openPdf(pdfPath) {\n    if (!pdfPath) {\n      console.error(\"Aucun chemin de PDF fourni !\");\n      return;\n    }\n\n    const fullPath = `http://localhost:9090/pdf/${pdfPath}`;\n    this.selectedPdf = this.sanitizer.bypassSecurityTrustResourceUrl(fullPath);\n    this.selectedPdfName = pdfPath;\n    this.displayPdfDialog = true;\n  }\n\n};\nImageSinistreComponent = __decorate([Component({\n  selector: 'app-image-sinistre',\n  templateUrl: './image-sinistre.component.html',\n  styleUrls: ['./image-sinistre.component.scss']\n})], ImageSinistreComponent);\nexport { ImageSinistreComponent };","map":null,"metadata":{},"sourceType":"module"}