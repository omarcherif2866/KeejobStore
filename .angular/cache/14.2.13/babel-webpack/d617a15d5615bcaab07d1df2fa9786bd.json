{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, Input, Output, EventEmitter } from '@angular/core';\nimport Swal from 'sweetalert2';\nimport { forkJoin } from 'rxjs';\nlet LogicielComponent = class LogicielComponent {\n  constructor(logicielService, cdr // ‚úÖ Ajout\n  ) {\n    this.logicielService = logicielService;\n    this.cdr = cdr;\n    this.logicielSelected = new EventEmitter();\n    this.loading = false;\n    this.logiciels = [];\n    this.selectedLogiciels = [];\n    this.newLogicielName = '';\n    this.selectedImage = null;\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      name: '',\n      image: ''\n    };\n    this.showModal = false;\n  }\n\n  ngOnInit() {\n    console.log('üöÄ LogicielComponent ngOnInit - sousFormationId:', this.sousFormationId);\n    this.loadLogiciels();\n  }\n\n  ngOnChanges(changes) {\n    if (changes['sousFormationId'] && !changes['sousFormationId'].firstChange) {\n      console.log('üîÑ sousFormationId chang√©:', changes['sousFormationId'].currentValue);\n      this.loadLogiciels();\n    }\n  }\n\n  loadLogiciels() {\n    console.log('üì° Chargement de TOUS les logiciels...');\n    this.loading = true;\n    this.logiciels = []; // ‚úÖ Reset\n\n    this.cdr.detectChanges(); // ‚úÖ Force update\n\n    const allLogiciels$ = this.logicielService.getLogiciel();\n    const associatedLogiciels$ = this.sousFormationId ? this.logicielService.getLogicielBySousFormationKeejob(this.sousFormationId) : Promise.resolve([]);\n    forkJoin({\n      all: allLogiciels$,\n      associated: associatedLogiciels$\n    }).subscribe({\n      next: result => {\n        console.log('‚úÖ R√©sultats combin√©s:', result);\n        this.logiciels = result.all || [];\n        console.log('üìã Tous les logiciels:', this.logiciels);\n        console.log('üìã Premier logiciel:', this.logiciels[0]);\n\n        if (this.sousFormationId && result.associated && result.associated.length > 0) {\n          console.log('‚úÖ Logiciels d√©j√† associ√©s:', result.associated);\n          this.selectedLogiciels = this.logiciels.filter(log => result.associated.some(al => al.id === log.id));\n          console.log('‚úÖ Logiciels pr√©-s√©lectionn√©s:', this.selectedLogiciels);\n          this.logicielSelected.emit(this.selectedLogiciels);\n        } else {\n          console.log('‚ÑπÔ∏è Aucun logiciel pr√©-associ√©');\n          this.selectedLogiciels = [];\n        }\n\n        this.loading = false;\n        console.log('üìä √âtat final:');\n        console.log('  - loading:', this.loading);\n        console.log('  - logiciels.length:', this.logiciels.length);\n        console.log('  - selectedLogiciels.length:', this.selectedLogiciels.length); // ‚úÖ FORCER la mise √† jour de la vue\n\n        this.cdr.detectChanges(); // ‚úÖ V√©rifier que le DOM est bien mis √† jour\n\n        setTimeout(() => {\n          console.log('üîç V√©rification finale - logiciels dans component:', this.logiciels.length);\n        }, 100);\n      },\n      error: err => {\n        console.error('‚ùå Erreur chargement:', err);\n        this.logiciels = [];\n        this.selectedLogiciels = [];\n        this.loading = false;\n        this.cdr.detectChanges(); // ‚úÖ Force update\n\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Impossible de charger les logiciels',\n          timer: 2000\n        });\n      }\n    });\n  }\n\n  handleAdd() {\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      name: '',\n      image: ''\n    };\n    this.selectedImage = null;\n    this.showModal = true;\n  }\n\n  closeModal() {\n    this.showModal = false;\n    this.formData = {\n      id: null,\n      name: '',\n      image: ''\n    };\n    this.selectedImage = null;\n  }\n\n  onFileSelected(event) {\n    const file = event.target.files[0];\n\n    if (file) {\n      if (!file.type.startsWith('image/')) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Veuillez s√©lectionner une image valide',\n          timer: 2000\n        });\n        return;\n      }\n\n      this.selectedImage = file;\n    }\n  }\n\n  addLogiciel() {\n    if (!this.newLogicielName) {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Attention',\n        text: 'Nom du logiciel requis',\n        timer: 2000\n      });\n      return;\n    }\n\n    if (!this.sousFormationId) {\n      console.error('‚ùå sousFormationId manquant');\n      Swal.fire({\n        icon: 'error',\n        title: 'Erreur',\n        text: 'Sous-formation non d√©finie',\n        timer: 2000\n      });\n      return;\n    }\n\n    const fd = new FormData();\n    fd.append('name', this.newLogicielName);\n    fd.append('sousFormationKeejobId', this.sousFormationId.toString());\n\n    if (this.selectedImage) {\n      fd.append('image', this.selectedImage, this.selectedImage.name);\n    }\n\n    this.logicielService.addLogiciel(fd).subscribe({\n      next: res => {\n        console.log('‚úÖ Logiciel ajout√©:', res);\n        this.logiciels.push(res);\n        this.toggleLogiciel(res);\n        this.newLogicielName = '';\n        this.selectedImage = null;\n        Swal.fire({\n          icon: 'success',\n          title: 'Logiciel ajout√©!',\n          timer: 1500,\n          showConfirmButton: false\n        });\n      },\n      error: err => {\n        console.error('‚ùå Erreur ajout:', err);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Impossible d\\'ajouter le logiciel',\n          timer: 2000\n        });\n      }\n    });\n  }\n\n  toggleLogiciel(log) {\n    const index = this.selectedLogiciels.findIndex(l => l.id === log.id);\n\n    if (index > -1) {\n      // Retirer de la s√©lection\n      this.selectedLogiciels.splice(index, 1);\n      console.log('‚ûñ Logiciel retir√©:', log.name);\n    } else {\n      // Ajouter √† la s√©lection\n      this.selectedLogiciels.push(log);\n      console.log('‚ûï Logiciel ajout√©:', log.name);\n    }\n\n    console.log('üìã S√©lection actuelle:', this.selectedLogiciels.map(l => l.name));\n    this.logicielSelected.emit(this.selectedLogiciels);\n  }\n\n  isSelected(log) {\n    return this.selectedLogiciels.some(l => l.id === log.id);\n  }\n\n  editlogicielFromParent(logiciel) {\n    console.log('üìù Edition logiciel:', logiciel);\n    this.modalMode = 'edit';\n    this.formData = {\n      id: logiciel.id,\n      name: logiciel.name,\n      image: logiciel.image\n    };\n\n    if (this.formData.image) {\n      this.selectedImage = {\n        name: 'Image existante'\n      };\n    }\n\n    this.showModal = true;\n  }\n\n};\n\n__decorate([Input()], LogicielComponent.prototype, \"sousFormationId\", void 0);\n\n__decorate([Output()], LogicielComponent.prototype, \"logicielSelected\", void 0);\n\nLogicielComponent = __decorate([Component({\n  selector: 'app-logiciel',\n  templateUrl: './logiciel.component.html',\n  styleUrls: ['./logiciel.component.css']\n})], LogicielComponent);\nexport { LogicielComponent };","map":null,"metadata":{},"sourceType":"module"}