{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, EventEmitter, Input, Output } from '@angular/core';\nimport { SousFormationKeejob } from 'src/app/models/sous-formation-keejob';\nimport { Partenaire } from 'src/app/models/partenaire';\nimport Swal from 'sweetalert2';\nimport { forkJoin } from 'rxjs';\nlet SousFormationKeejobComponent = class SousFormationKeejobComponent {\n  constructor(partenaireservice, sousFormationKeejobService, cdr, logicielService, partenaireService, authService, router) {\n    this.partenaireservice = partenaireservice;\n    this.sousFormationKeejobService = sousFormationKeejobService;\n    this.cdr = cdr;\n    this.logicielService = logicielService;\n    this.partenaireService = partenaireService;\n    this.authService = authService;\n    this.router = router;\n    this.sousFormationSelected = new EventEmitter();\n    this.sidebarOpen = true;\n    this.sousFormationKeejob = [];\n    this.partenaires = [];\n    this.selectedPartenaires = [];\n    this.loading = false; // currentPage = 1;\n\n    this.itemsPerPage = 5;\n    this.showModal = false;\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      formationKeejobId: null,\n      sousFormationPartenaires: [],\n      details: [],\n      titleLogiciel: '' // ‚úÖ Ajout de titleLogiciel\n\n    };\n    this.iconsFiles = []; // ‚¨ÖÔ∏è ic√¥nes envoy√©es au backend\n\n    this.editId = null;\n    this.selectedImage = null;\n  }\n\n  ngOnInit() {\n    console.log('üöÄ SousFormationKeejob - Initialisation');\n    console.log('üìå formationId re√ßu:', this.formationId);\n    console.log('fetchsousFormationKeejob:', this.fetchsousFormationKeejob());\n    this.fetchsousFormationKeejob();\n    this.fetchPartenaires();\n  }\n\n  fetchsousFormationKeejob() {\n    this.loading = true;\n    console.log('üì° R√©cup√©ration des sous-formations...');\n    this.sousFormationKeejobService.getSousFormationKeejob().subscribe(response => {\n      console.log('‚úÖ R√©ponse brute:', response); // On map les sous-formations sans les logiciels pour l'instant\n\n      const sousFormationsTemp = response.map(f => new SousFormationKeejob(f.id, f.title, f.description, f.image, f.titleLogiciel, f.sousFormationPartenaires || [], [], // temporairement vide\n      this.formationId, f.details)); // Cr√©er un tableau d'observables pour r√©cup√©rer les logiciels\n\n      const logicielRequests = sousFormationsTemp.map(sf => this.logicielService.getLogicielBySousFormationKeejob(sf.id)); // forkJoin pour ex√©cuter toutes les requ√™tes en parall√®le\n\n      forkJoin(logicielRequests).subscribe(logicielsArray => {\n        // Assignation des logiciels √† chaque sous-formation\n        sousFormationsTemp.forEach((sf, index) => {\n          sf.sousFormationLogiciel = logicielsArray[index] || [];\n        });\n        this.sousFormationKeejob = sousFormationsTemp;\n        this.loading = false;\n        console.log('‚úÖ Sous-formations avec logiciels:', this.sousFormationKeejob);\n      }, error => {\n        console.error('‚ùå Erreur lors de la r√©cup√©ration des logiciels:', error);\n        this.loading = false;\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur lors du chargement des logiciels',\n          showConfirmButton: false,\n          timer: 1500\n        });\n      });\n    }, error => {\n      console.error('‚ùå Erreur chargement des sous-formations:', error);\n      this.loading = false;\n      Swal.fire({\n        icon: 'error',\n        title: 'Erreur lors du chargement',\n        showConfirmButton: false,\n        timer: 1500\n      });\n    });\n  }\n\n  fetchPartenaires() {\n    this.partenaireservice.getPartenaire().subscribe(response => {\n      this.partenaires = response.map(p => new Partenaire(p.id, p.title, p.description, p.image));\n      console.log('‚úÖ Partenaires charg√©s:', this.partenaires.length);\n    }, error => {\n      console.error('‚ùå Erreur partenaires:', error);\n    });\n  } // get currentItems(): SousFormationKeejob[] {\n  //   const indexOfLastItem = this.currentPage * this.itemsPerPage;\n  //   const indexOfFirstItem = indexOfLastItem - this.itemsPerPage;\n  //   return this.sousFormationKeejob.slice(indexOfFirstItem, indexOfLastItem);\n  // }\n\n\n  get totalPages() {\n    return Math.ceil(this.sousFormationKeejob.length / this.itemsPerPage);\n  }\n\n  get pagesArray() {\n    return Array(this.totalPages).fill(0).map((_, i) => i + 1);\n  } // handlePageChange(pageNumber: number) {\n  //   this.currentPage = pageNumber;\n  // }\n\n\n  handleAdd() {\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      formationKeejobId: this.formationId,\n      sousFormationPartenaires: [],\n      details: [],\n      titleLogiciel: '' // ‚úÖ Ajout\n\n    };\n    this.selectedPartenaires = [];\n    this.selectedImage = null;\n    this.showModal = true;\n  }\n\n  handleEdit(sousFormation) {\n    var _a;\n\n    this.modalMode = 'edit';\n    this.formData = {\n      id: sousFormation.Id,\n      title: sousFormation.Title,\n      description: sousFormation.Description,\n      image: sousFormation.Image,\n      formationKeejobId: ((_a = sousFormation.FormationKeejob) === null || _a === void 0 ? void 0 : _a.Id) || this.formationId,\n      sousFormationPartenaires: sousFormation.Partenaires || [],\n      details: sousFormation.Details ? [...sousFormation.Details] : [],\n      titleLogiciel: sousFormation.TitleLogiciel\n    };\n    this.editId = sousFormation.Id;\n    this.showModal = true;\n  }\n\n  handleDelete(id) {\n    Swal.fire({\n      title: '√ätes-vous s√ªr?',\n      text: \"Cette action est irr√©versible!\",\n      icon: 'warning',\n      showCancelButton: true,\n      confirmButtonColor: '#3085d6',\n      cancelButtonColor: '#d33',\n      confirmButtonText: 'Oui, supprimer!',\n      cancelButtonText: 'Annuler'\n    }).then(result => {\n      if (result.isConfirmed) {\n        this.sousFormationKeejobService.deleteSousFormationKeejob(id).subscribe(() => {\n          this.sousFormationKeejob = this.sousFormationKeejob.filter(item => item.Id !== id);\n          Swal.fire({\n            title: 'Supprim√©!',\n            text: 'Sous-formation supprim√©e avec succ√®s',\n            icon: 'success',\n            timer: 1500,\n            showConfirmButton: false\n          });\n        }, error => {\n          console.error('Erreur suppression:', error);\n          Swal.fire({\n            icon: 'error',\n            title: 'Erreur lors de la suppression',\n            timer: 1500\n          });\n        });\n      }\n    });\n  }\n\n  handleSubmit() {\n    if (!this.formData.title || !this.formData.description) {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Attention',\n        text: 'Veuillez remplir tous les champs obligatoires',\n        timer: 2000\n      });\n      return;\n    }\n\n    const formData = new FormData();\n    formData.append('title', this.formData.title);\n    formData.append('description', this.formData.description);\n\n    if (this.formationId) {\n      formData.append('formationKeejobId', this.formationId.toString());\n    }\n\n    formData.append('titleLogiciel', this.formData.titleLogiciel);\n\n    if (this.selectedImage) {\n      formData.append('image', this.selectedImage, this.selectedImage.name);\n    }\n\n    if (this.selectedPartenaires.length > 0) {\n      this.selectedPartenaires.forEach(p => {\n        formData.append(\"partenairesIds\", p.id.toString());\n      });\n    }\n\n    formData.append('details', JSON.stringify(this.formData.details.map(d => ({\n      titre: d.titre,\n      description: d.description // PAS icon ici car c'est un upload s√©par√© !\n\n    })))); // ‚¨ÖÔ∏è envoi des ic√¥nes (dans le bon ordre)\n\n    this.iconsFiles.forEach(file => {\n      formData.append('icons', file);\n    });\n\n    const afterSuccess = response => {\n      Swal.fire({\n        title: 'Succ√®s!',\n        text: this.modalMode === 'add' ? 'Sous-formation ajout√©e avec succ√®s' : 'Sous-formation modifi√©e avec succ√®s',\n        icon: 'success',\n        timer: 1500,\n        showConfirmButton: false\n      });\n      this.closeModal();\n      this.fetchsousFormationKeejob(); // ‚úÖ √âmettre la sous-formation ajout√©e pour passer automatiquement au Step 3\n\n      if (this.modalMode === 'add') {\n        this.sousFormationSelected.emit(response); // <-- IMPORTANT\n      }\n    };\n\n    if (this.modalMode === 'add') {\n      this.sousFormationKeejobService.addSousFormationKeejob(formData).subscribe(afterSuccess, error => {\n        console.error('Erreur ajout:', error);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur lors de l\\'ajout',\n          timer: 1500\n        });\n      });\n    } else {\n      this.sousFormationKeejobService.putSousFormationKeejob(this.editId, formData).subscribe(afterSuccess, error => {\n        console.error('Erreur modification:', error);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur lors de la modification',\n          timer: 1500\n        });\n      });\n    }\n  }\n\n  addDetail() {\n    this.formData.details.push({\n      titre: '',\n      description: '',\n      icon: '',\n      iconPreview: ''\n    });\n  } // ‚úÖ Supprimer un d√©tail\n\n\n  removeDetail(i) {\n    this.formData.details.splice(i, 1);\n    this.iconsFiles.splice(i, 1);\n  }\n\n  closeModal() {\n    this.showModal = false;\n    this.formData = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      formationKeejobId: null,\n      sousFormationPartenaires: [],\n      details: [],\n      titleLogiciel: '' // ‚úÖ Ajout\n\n    };\n    this.selectedPartenaires = [];\n    this.selectedImage = null;\n  }\n\n  onImageSelected(event) {\n    const file = event.target.files[0];\n\n    if (file) {\n      if (!file.type.startsWith('image/')) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Veuillez s√©lectionner une image valide',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      if (file.size > 5 * 1024 * 1024) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'L\\'image ne doit pas d√©passer 5MB',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      this.selectedImage = file;\n    }\n  }\n\n  sanitizeImage(url) {\n    if (!url) return '';\n\n    if (url.includes(\"https://res.cloudinary.com\") && url.split(\"https://res.cloudinary.com\").length > 2) {\n      const parts = url.split(\"https://res.cloudinary.com/daxkymr4t/image/upload/\");\n      return \"https://res.cloudinary.com/daxkymr4t/image/upload/\" + parts[parts.length - 1];\n    }\n\n    return url;\n  }\n\n  togglePartenaire(p) {\n    const index = this.selectedPartenaires.findIndex(x => x.Id === p.Id);\n\n    if (index > -1) {\n      // Retirer le partenaire\n      this.selectedPartenaires.splice(index, 1);\n    } else {\n      // Ajouter le partenaire\n      this.selectedPartenaires.push(p);\n    } // ‚úÖ Synchroniser avec formData\n\n\n    this.formData.sousFormationPartenaires = [...this.selectedPartenaires];\n    console.log('Partenaires s√©lectionn√©s:', this.selectedPartenaires);\n  }\n\n  isSelected(p) {\n    return this.selectedPartenaires.some(x => x.id === p.Id);\n  }\n\n  editSousFormationFromParent(sf) {\n    var _a;\n\n    console.log('Edition SF:', sf);\n    this.modalMode = 'edit'; // ‚úÖ IMPORTANT: D√©finir editId AVANT tout\n\n    this.editId = sf.id || sf.Id; // Charger les donn√©es de base\n\n    this.formData = {\n      id: sf.id || sf.Id,\n      title: sf.title || sf.Title,\n      description: sf.description || sf.Description,\n      image: sf.image || sf.Image,\n      formationKeejobId: sf.formationKeejobId || ((_a = sf.FormationKeejob) === null || _a === void 0 ? void 0 : _a.Id),\n      sousFormationPartenaires: [],\n      details: sf.details || sf.Details || [],\n      titleLogiciel: sf.titleLogiciel || sf.TitleLogiciel || ''\n    };\n    console.log('‚úÖ editId d√©fini:', this.editId); // ‚Üê V√©rification\n\n    console.log('‚úÖ formData.id:', this.formData.id); // ‚Üê V√©rification\n\n    if (this.formData.image) {\n      this.selectedImage = {\n        name: 'Image existante'\n      };\n    }\n\n    this.showModal = true; // Charger les partenaires associ√©s depuis l'API\n\n    if (this.formData.id) {\n      this.partenaireService.getPartenaireBySousFormationKeejob(this.formData.id).subscribe({\n        next: partenaires => {\n          console.log('Partenaires r√©cup√©r√©s:', partenaires);\n          this.selectedPartenaires = partenaires;\n          this.formData.sousFormationPartenaires = partenaires;\n          this.cdr.detectChanges();\n        },\n        error: error => {\n          console.error('Erreur lors du chargement des partenaires:', error);\n          this.selectedPartenaires = [];\n          this.formData.sousFormationPartenaires = [];\n        }\n      });\n    } else {\n      this.selectedPartenaires = [];\n    }\n  }\n\n  onIconSelected(event, index) {\n    const file = event.target.files[0];\n\n    if (file) {\n      // Stocker dans le tableau des fichiers\n      this.iconsFiles[index] = file; // Pr√©visualisation\n\n      const reader = new FileReader();\n\n      reader.onload = () => {\n        this.formData.details[index].iconPreview = reader.result;\n      };\n\n      reader.readAsDataURL(file);\n    }\n  }\n\n};\n\n__decorate([Input()], SousFormationKeejobComponent.prototype, \"formationId\", void 0);\n\n__decorate([Output()], SousFormationKeejobComponent.prototype, \"sousFormationSelected\", void 0);\n\nSousFormationKeejobComponent = __decorate([Component({\n  selector: 'app-sous-formation-keejob',\n  templateUrl: './sous-formation-keejob.component.html',\n  styleUrls: ['./sous-formation-keejob.component.css']\n})], SousFormationKeejobComponent);\nexport { SousFormationKeejobComponent };","map":null,"metadata":{},"sourceType":"module"}