{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Cv } from 'src/app/models/cv';\nimport { Partenaire } from 'src/app/models/partenaire';\nimport Swal from 'sweetalert2';\nlet CoachingComponent = class CoachingComponent {\n  constructor(coachingservice, partenaireService, authService, router) {\n    this.coachingservice = coachingservice;\n    this.partenaireService = partenaireService;\n    this.authService = authService;\n    this.router = router;\n    this.sidebarOpen = true;\n    this.coachings = [];\n    this.loading = false;\n    this.currentPage = 1;\n    this.itemsPerPage = 5;\n    this.showModal = false;\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      name: '',\n      description: '',\n      image: ''\n    };\n    this.editId = null;\n    this.selectedImage = null;\n    this.currentModalStep = 1;\n    this.sections = []; // NOUVEAU : Gestion des PriceSections\n\n    this.priceSections = []; // Partenaires\n\n    this.allPartenaires = [];\n    this.selectedPartenaires = [];\n  }\n\n  ngOnInit() {\n    this.fetchcoachings();\n    this.fetchPartenaires();\n  }\n\n  fetchPartenaires() {\n    this.loading = true;\n    console.log('üì° R√©cup√©ration des partenaires...');\n    this.partenaireService.getPartenaire().subscribe(response => {\n      console.log('‚úÖ R√©ponse partenaires:', response);\n      this.allPartenaires = response.map(p => new Partenaire(p.id, p.title, p.description, p.image));\n      this.loading = false;\n    }, error => {\n      console.error('‚ùå Erreur lors du chargement des partenaires:', error);\n      this.loading = false;\n      Swal.fire({\n        icon: 'error',\n        title: 'Erreur lors du chargement des partenaires',\n        showConfirmButton: false,\n        timer: 1500\n      });\n    });\n  }\n\n  initializeSections() {\n    // 4 sections normales + 1 section pour les prix\n    this.sections = [{\n      headline: '',\n      subtitle: '',\n      details: []\n    }, {\n      headline: '',\n      subtitle: '',\n      details: []\n    }, {\n      headline: '',\n      subtitle: '',\n      details: []\n    }, {\n      headline: '',\n      subtitle: '',\n      details: []\n    }];\n  } // NOUVEAU : Initialiser les priceSections\n\n\n  initializePriceSections() {\n    this.priceSections = [{\n      title: '',\n      subtitle: '',\n      price: '',\n      details: []\n    }];\n  }\n\n  fetchcoachings() {\n    this.loading = true;\n    this.coachingservice.getCv().subscribe({\n      next: response => {\n        this.coachings = response.map(data => new Cv(data));\n        this.loading = false;\n        console.log('Donn√©es re√ßues: ', this.coachings);\n      },\n      error: error => {\n        console.error('Erreur lors du chargement des CV:', error);\n        this.loading = false;\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur lors du chargement des donn√©es',\n          showConfirmButton: false,\n          timer: 1500\n        });\n      }\n    });\n  }\n\n  get currentItems() {\n    const indexOfLastItem = this.currentPage * this.itemsPerPage;\n    const indexOfFirstItem = indexOfLastItem - this.itemsPerPage;\n    return this.coachings.slice(indexOfFirstItem, indexOfLastItem);\n  }\n\n  get totalPages() {\n    return Math.ceil(this.coachings.length / this.itemsPerPage);\n  }\n\n  get pagesArray() {\n    return Array(this.totalPages).fill(0).map((_, i) => i + 1);\n  }\n\n  handlePageChange(pageNumber) {\n    this.currentPage = pageNumber;\n  }\n\n  handleAdd() {\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      name: '',\n      description: '',\n      image: ''\n    };\n    this.selectedImage = null;\n    this.initializeSections();\n    this.initializePriceSections(); // NOUVEAU\n\n    this.selectedPartenaires = [];\n    this.currentModalStep = 1;\n    this.showModal = true;\n  }\n\n  handleEdit(cv) {\n    this.modalMode = 'edit';\n    this.formData = {\n      id: cv.Id,\n      name: cv.Name || '',\n      description: cv.Description || '',\n      image: cv.Image || ''\n    };\n    this.editId = cv.Id;\n    this.selectedImage = null;\n\n    if (cv.Sections && cv.Sections.length > 0) {\n      this.sections = [...cv.Sections];\n\n      while (this.sections.length < 4) {\n        this.sections.push({\n          headline: '',\n          subtitle: '',\n          details: []\n        });\n      }\n    } else {\n      this.initializeSections();\n    } // NOUVEAU : Charger les priceSections\n\n\n    if (cv.PriceSection && cv.PriceSection.length > 0) {\n      this.priceSections = [...cv.PriceSection];\n    } else {\n      this.initializePriceSections();\n    }\n\n    this.selectedPartenaires = cv.Partenaires ? [...cv.Partenaires] : [];\n    this.currentModalStep = 1;\n    this.showModal = true;\n  }\n\n  closeModal() {\n    this.showModal = false;\n    this.formData = {\n      id: null,\n      name: '',\n      description: '',\n      image: ''\n    };\n    this.selectedImage = null;\n    this.editId = null;\n    this.sections = [];\n    this.priceSections = []; // NOUVEAU\n\n    this.selectedPartenaires = [];\n    this.currentModalStep = 1;\n  }\n\n  handleDelete(id) {\n    Swal.fire({\n      title: '√ätes-vous s√ªr?',\n      text: \"Vous ne pourrez pas revenir en arri√®re!\",\n      icon: 'warning',\n      showCancelButton: true,\n      confirmButtonColor: '#3085d6',\n      cancelButtonColor: '#d33',\n      confirmButtonText: 'Oui, supprimer!',\n      cancelButtonText: 'Annuler'\n    }).then(result => {\n      if (result.isConfirmed) {\n        this.coachingservice.deleteCv(id).subscribe({\n          next: () => {\n            this.coachings = this.coachings.filter(item => item.Id !== id);\n            Swal.fire({\n              title: 'Supprim√©!',\n              text: 'CV supprim√© avec succ√®s',\n              icon: 'success',\n              timer: 1500,\n              showConfirmButton: false\n            });\n          },\n          error: error => {\n            console.error('Erreur lors de la suppression:', error);\n            Swal.fire({\n              icon: 'error',\n              title: 'Erreur lors de la suppression',\n              text: error.message || 'Une erreur est survenue',\n              showConfirmButton: false,\n              timer: 1500\n            });\n          }\n        });\n      }\n    });\n  }\n\n  addDetailToSection(sectionIndex) {\n    if (this.sections[sectionIndex]) {\n      this.sections[sectionIndex].details.push({\n        titre: '',\n        description: '',\n        icon: ''\n      });\n    }\n  }\n\n  removeDetailFromSection(sectionIndex, detailIndex) {\n    if (this.sections[sectionIndex] && this.sections[sectionIndex].details[detailIndex]) {\n      Swal.fire({\n        title: 'Supprimer ce d√©tail?',\n        text: \"Cette action est irr√©versible\",\n        icon: 'warning',\n        showCancelButton: true,\n        confirmButtonColor: '#f44336',\n        cancelButtonColor: '#666',\n        confirmButtonText: 'Oui, supprimer',\n        cancelButtonText: 'Annuler'\n      }).then(result => {\n        if (result.isConfirmed) {\n          this.sections[sectionIndex].details.splice(detailIndex, 1);\n        }\n      });\n    }\n  } // NOUVEAU : M√©thodes pour g√©rer les PriceSections\n\n\n  addPriceSection() {\n    this.priceSections.push({\n      title: '',\n      subtitle: '',\n      price: '',\n      details: []\n    });\n  }\n\n  removePriceSection(index) {\n    Swal.fire({\n      title: 'Supprimer ce pack?',\n      text: \"Cette action est irr√©versible\",\n      icon: 'warning',\n      showCancelButton: true,\n      confirmButtonColor: '#f44336',\n      cancelButtonColor: '#666',\n      confirmButtonText: 'Oui, supprimer',\n      cancelButtonText: 'Annuler'\n    }).then(result => {\n      if (result.isConfirmed) {\n        this.priceSections.splice(index, 1);\n      }\n    });\n  }\n\n  addDetailToPriceSection(priceSectionIndex) {\n    if (this.priceSections[priceSectionIndex]) {\n      this.priceSections[priceSectionIndex].details.push({\n        titre: '',\n        description: '',\n        icon: ''\n      });\n    }\n  }\n\n  removeDetailFromPriceSection(priceSectionIndex, detailIndex) {\n    if (this.priceSections[priceSectionIndex] && this.priceSections[priceSectionIndex].details[detailIndex]) {\n      Swal.fire({\n        title: 'Supprimer cette fonctionnalit√©?',\n        text: \"Cette action est irr√©versible\",\n        icon: 'warning',\n        showCancelButton: true,\n        confirmButtonColor: '#f44336',\n        cancelButtonColor: '#666',\n        confirmButtonText: 'Oui, supprimer',\n        cancelButtonText: 'Annuler'\n      }).then(result => {\n        if (result.isConfirmed) {\n          this.priceSections[priceSectionIndex].details.splice(detailIndex, 1);\n        }\n      });\n    }\n  }\n\n  togglePartenaireSelection(partenaire) {\n    const index = this.selectedPartenaires.findIndex(p => p.Id === partenaire.Id);\n\n    if (index > -1) {\n      this.selectedPartenaires.splice(index, 1);\n    } else {\n      this.selectedPartenaires.push(partenaire);\n    }\n  }\n\n  isPartenaireSelected(partenaire) {\n    return this.selectedPartenaires.some(p => p.Id === partenaire.Id);\n  }\n\n  handleSubmit() {\n    if (!this.formData.name) {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Champs manquants',\n        text: 'Veuillez remplir tous les champs obligatoires',\n        timer: 2000,\n        showConfirmButton: false\n      });\n      this.currentModalStep = 1;\n      return;\n    }\n\n    if (this.modalMode === 'add' && !this.selectedImage) {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Image manquante',\n        text: 'Veuillez s√©lectionner une image',\n        timer: 2000,\n        showConfirmButton: false\n      });\n      this.currentModalStep = 1;\n      return;\n    }\n\n    const formData = new FormData();\n    formData.append('name', this.formData.name);\n    formData.append('description', this.formData.description);\n\n    if (this.selectedImage) {\n      formData.append('image', this.selectedImage, this.selectedImage.name);\n    } // üîç LOG 1: V√©rifier this.sections AVANT mapping\n\n\n    console.log('üîç this.sections AVANT mapping:', this.sections); // Sections normales (4 premi√®res) - avec \"headline\"\n\n    const safeSections = this.sections.map(s => ({\n      headline: s.headline || '',\n      subtitle: s.subtitle || '',\n      details: (s.details || []).map(d => ({\n        titre: d.titre || '',\n        description: d.description || '',\n        icon: d.icon || ''\n      }))\n    })); // üîç LOG 2: V√©rifier safeSections APR√àS mapping\n\n    console.log('üì¶ safeSections (DOIT avoir headline):', JSON.stringify(safeSections, null, 2));\n    formData.append('sections', JSON.stringify(safeSections)); // üîç LOG 3: V√©rifier this.priceSections AVANT mapping\n\n    console.log('üîç this.priceSections AVANT mapping:', this.priceSections); // PriceSections - avec \"title\" (PAS headline)\n\n    const safePriceSections = this.priceSections.map(ps => ({\n      title: ps.title || '',\n      subtitle: ps.subtitle || '',\n      price: ps.price || '',\n      details: (ps.details || []).map(d => ({\n        titre: d.titre || '',\n        description: d.description || '',\n        icon: d.icon || ''\n      }))\n    })); // üîç LOG 4: V√©rifier safePriceSections APR√àS mapping\n\n    console.log('üí∞ safePriceSections (DOIT avoir title):', JSON.stringify(safePriceSections, null, 2));\n    formData.append('priceSections', JSON.stringify(safePriceSections)); // üîç LOG 5: Afficher TOUT le FormData\n\n    console.log('üì§ === CONTENU COMPLET DU FORMDATA ===');\n    formData.forEach((value, key) => {\n      if (key === 'sections') {\n        console.log(`  ‚úÖ sections:`, JSON.parse(value));\n      } else if (key === 'priceSections') {\n        console.log(`  ‚úÖ priceSections:`, JSON.parse(value));\n      } else if (key === 'image') {\n        console.log(`  ‚úÖ ${key}:`, value);\n      } else {\n        console.log(`  ‚úÖ ${key}:`, value);\n      }\n    }); // Partenaires\n\n    (this.selectedPartenaires || []).forEach(p => {\n      if ((p === null || p === void 0 ? void 0 : p.Id) != null) formData.append('partenairesIds', p.Id.toString());\n    });\n    const request$ = this.modalMode === 'add' ? this.coachingservice.addCv(formData) : this.coachingservice.putCv(this.editId, formData);\n    request$.subscribe({\n      next: response => {\n        console.log('‚úÖ R√©ponse backend:', response);\n        const newCv = new Cv({\n          id: response.id,\n          name: response.name,\n          description: response.description,\n          image: response.image,\n          sections: response.sections || [],\n          priceSection: response.priceSections || [],\n          evaluationPartenaires: response.cvPartenaires || []\n        });\n\n        if (this.modalMode === 'add') {\n          this.coachings.push(newCv);\n        } else {\n          const index = this.coachings.findIndex(item => item.Id === this.editId);\n          if (index !== -1) this.coachings[index] = newCv;\n        }\n\n        this.closeModal();\n        Swal.fire({\n          title: 'Succ√®s!',\n          text: this.modalMode === 'add' ? 'CV ajout√© avec succ√®s' : 'CV modifi√© avec succ√®s',\n          icon: 'success',\n          timer: 1500,\n          showConfirmButton: false\n        }).then(() => this.fetchcoachings());\n      },\n      error: error => {\n        var _a, _b;\n\n        console.error('‚ùå === ERREUR D√âTAILL√âE ===');\n        console.error('‚ùå Error object:', error);\n        console.error('‚ùå Error message:', ((_a = error === null || error === void 0 ? void 0 : error.error) === null || _a === void 0 ? void 0 : _a.message) || (error === null || error === void 0 ? void 0 : error.message));\n        console.error('‚ùå Error status:', error === null || error === void 0 ? void 0 : error.status);\n        console.error('‚ùå Full error:', JSON.stringify(error, null, 2));\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: ((_b = error === null || error === void 0 ? void 0 : error.error) === null || _b === void 0 ? void 0 : _b.message) || (error === null || error === void 0 ? void 0 : error.message) || 'Une erreur est survenue',\n          showConfirmButton: false,\n          timer: 1500\n        });\n      }\n    });\n  }\n\n  toggleSidebar() {\n    this.sidebarOpen = !this.sidebarOpen;\n  }\n\n  logout() {\n    this.authService.logout();\n    Swal.fire({\n      icon: 'info',\n      title: 'D√©connexion',\n      text: 'Vous √™tes d√©connect√©',\n      showConfirmButton: false,\n      timer: 1500\n    });\n    this.router.navigate(['/']);\n  }\n\n  onImageSelected(event) {\n    const file = event.target.files[0];\n\n    if (file) {\n      if (!file.type.startsWith('image/')) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Veuillez s√©lectionner une image valide',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      if (file.size > 5 * 1024 * 1024) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'L\\'image ne doit pas d√©passer 5MB',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      this.selectedImage = file;\n    }\n  }\n\n  sanitizeImage(url) {\n    if (!url) return '';\n\n    if (url.includes(\"https://res.cloudinary.com\") && url.split(\"https://res.cloudinary.com\").length > 2) {\n      const parts = url.split(\"https://res.cloudinary.com/daxkymr4t/image/upload/\");\n      return \"https://res.cloudinary.com/daxkymr4t/image/upload/\" + parts[parts.length - 1];\n    }\n\n    return url;\n  }\n\n  nextModalStep() {\n    if (this.currentModalStep === 1) {\n      if (!this.formData.name) {\n        Swal.fire({\n          icon: 'warning',\n          title: 'Champs manquants',\n          text: 'Veuillez remplir le nom',\n          timer: 2000,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      if (this.modalMode === 'add' && !this.selectedImage) {\n        Swal.fire({\n          icon: 'warning',\n          title: 'Image manquante',\n          text: 'Veuillez s√©lectionner une image',\n          timer: 2000,\n          showConfirmButton: false\n        });\n        return;\n      }\n    }\n\n    if (this.currentModalStep < 7) {\n      this.currentModalStep++;\n    }\n  }\n\n  previousModalStep() {\n    if (this.currentModalStep > 1) {\n      this.currentModalStep--;\n    }\n  }\n\n  goToModalStep(step) {\n    if (step <= this.currentModalStep) {\n      this.currentModalStep = step;\n    }\n  }\n\n  countCompletedSections() {\n    return this.sections.filter(s => {\n      if (!s.headline || s.details.length === 0) {\n        return false;\n      }\n\n      return s.details.every(d => d.titre && d.icon);\n    }).length;\n  }\n\n  countCompletedPriceSections() {\n    return this.priceSections.filter(ps => {\n      return ps.title && ps.price;\n    }).length;\n  }\n\n};\nCoachingComponent = __decorate([Component({\n  selector: 'app-coaching',\n  templateUrl: './coaching.component.html',\n  styleUrls: ['./coaching.component.css']\n})], CoachingComponent);\nexport { CoachingComponent };","map":null,"metadata":{},"sourceType":"module"}