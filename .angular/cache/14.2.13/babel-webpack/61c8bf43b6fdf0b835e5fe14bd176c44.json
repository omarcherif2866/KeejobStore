{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, ViewChild } from '@angular/core';\nimport { FormationKeejob } from 'src/app/models/formation-keejob';\nimport { Partenaire } from 'src/app/models/partenaire';\nimport Swal from 'sweetalert2';\nimport { SousFormationKeejobComponent } from '../sous-formation-keejob/sous-formation-keejob.component';\nimport { LogicielComponent } from '../logiciel/logiciel.component';\nlet FormationKeejobComponent = class FormationKeejobComponent {\n  constructor(partenaireservice, formationsKeejobervice, sousFormationService, partenaireService, logicielService, authService, router, sanitizer) {\n    this.partenaireservice = partenaireservice;\n    this.formationsKeejobervice = formationsKeejobervice;\n    this.sousFormationService = sousFormationService;\n    this.partenaireService = partenaireService;\n    this.logicielService = logicielService;\n    this.authService = authService;\n    this.router = router;\n    this.sanitizer = sanitizer;\n    this.selectedLogiciels = [];\n    this.sidebarOpen = true;\n    this.formationsKeejob = [];\n    this.partenaires = [];\n    this.selectedPartenaires = [];\n    this.loading = false;\n    this.currentPage = 1;\n    this.itemsPerPage = 5;\n    this.showModal = false;\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      partenaires: []\n    };\n    this.formDataSF = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      formationKeejobId: null,\n      sousFormationPartenaires: []\n    };\n    this.editId = null;\n    this.selectedImage = null;\n    this.currentStep = 1;\n    this.createdFormation = null;\n    this.selectedSousFormation = null;\n    this.availableSousFormations = [];\n    this.selectedLogiciel = null;\n    this.openedFormationId = null;\n    this.sousFormationsMap = {};\n    this.sousFormationKeejob = [];\n    this.logicielMap = {};\n    this.openedsfId = null;\n  }\n\n  ngAfterViewInit() {\n    // ViewChild est disponible seulement apr√®s cette phase\n    console.log('Child component:', this.sousFormationChild);\n    console.log('Child component:', this.logicielChild);\n  }\n\n  openSousFormationModal(sf) {\n    console.log('Donn√©es SF:', sf); // V√©rifier les donn√©es\n\n    if (this.sousFormationChild) {\n      this.sousFormationChild.editSousFormationFromParent(sf);\n    } else {\n      console.error('Le child component n\\'est pas disponible');\n    }\n  }\n\n  ngOnInit() {\n    console.log('üöÄ Initialisation - currentStep:', this.currentStep);\n    this.fetchformationsKeejob();\n    this.fetchPartenaires();\n  } // R√©cup√©rer les formations depuis le backend\n\n\n  fetchformationsKeejob() {\n    this.loading = true;\n    console.log('üì° R√©cup√©ration des formations...');\n    this.formationsKeejobervice.getFormationKeejob().subscribe(response => {\n      console.log('‚úÖ R√©ponse brute du backend:', response);\n      this.formationsKeejob = response.map(f => new FormationKeejob(f.id, f.title, f.description, f.image, f.partenaires || []));\n      this.loading = false; // console.log('‚úÖ Formations mapp√©es:', this.formationsKeejob);\n      // console.log('üìä Nombre de formations:', this.formationsKeejob.length);\n    }, error => {\n      console.error('‚ùå Erreur lors du chargement des formations:', error);\n      this.loading = false;\n      Swal.fire({\n        icon: 'error',\n        title: 'Erreur lors du chargement des donn√©es',\n        showConfirmButton: false,\n        timer: 1500\n      });\n    });\n  }\n\n  fetchPartenaires() {\n    this.loading = true;\n    console.log('üì° R√©cup√©ration des partenaires...');\n    this.partenaireservice.getPartenaire().subscribe(response => {\n      console.log('‚úÖ R√©ponse partenaires:', response);\n      this.partenaires = response.map(p => new Partenaire(p.id, p.title, p.description, p.image));\n      this.loading = false; // console.log('‚úÖ Partenaires mapp√©s:', this.partenaires);\n    }, error => {\n      console.error('‚ùå Erreur lors du chargement des partenaires:', error);\n      this.loading = false;\n      Swal.fire({\n        icon: 'error',\n        title: 'Erreur lors du chargement des partenaires',\n        showConfirmButton: false,\n        timer: 1500\n      });\n    });\n  } // Pagination\n\n\n  get currentItems() {\n    const indexOfLastItem = this.currentPage * this.itemsPerPage;\n    const indexOfFirstItem = indexOfLastItem - this.itemsPerPage;\n    const items = this.formationsKeejob.slice(indexOfFirstItem, indexOfLastItem); // console.log('üìÑ Items de la page actuelle:', items);\n\n    return items;\n  }\n\n  get totalPages() {\n    return Math.ceil(this.formationsKeejob.length / this.itemsPerPage);\n  }\n\n  get pagesArray() {\n    return Array(this.totalPages).fill(0).map((_, i) => i + 1);\n  }\n\n  handlePageChange(pageNumber) {\n    this.currentPage = pageNumber;\n  } // Ajouter une formation\n\n\n  handleAdd() {\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      partenaires: []\n    };\n    this.selectedPartenaires = [];\n    this.selectedImage = null;\n    this.showModal = true;\n  } // √âditer une formation\n\n\n  handleEdit(formation) {\n    this.modalMode = 'edit';\n    this.editId = formation.Id;\n    this.formData = {\n      id: formation.Id,\n      title: formation.Title,\n      description: formation.Description,\n      image: formation.Image,\n      partenaires: []\n    }; // ‚úÖ Charger les partenaires associ√©s √† cette formation\n\n    this.partenaireService.getPartenaireByFormationKeejob(formation.Id).subscribe(partenaires => {\n      this.selectedPartenaires = partenaires; // ‚úÖ Important !\n\n      this.formData.partenaires = [...partenaires];\n      console.log('Partenaires charg√©s pour √©dition:', partenaires);\n    }, error => {\n      console.error('Erreur chargement partenaires:', error);\n      this.selectedPartenaires = []; // Reset en cas d'erreur\n    });\n    this.showModal = true;\n  } // Supprimer une formation\n\n\n  handleDelete(id) {\n    Swal.fire({\n      title: '√ätes-vous s√ªr?',\n      text: \"Cette action est irr√©versible!\",\n      icon: 'warning',\n      showCancelButton: true,\n      confirmButtonColor: '#3085d6',\n      cancelButtonColor: '#d33',\n      confirmButtonText: 'Oui, supprimer!',\n      cancelButtonText: 'Annuler'\n    }).then(result => {\n      if (result.isConfirmed) {\n        this.formationsKeejobervice.deleteFormationKeejob(id).subscribe(() => {\n          this.formationsKeejob = this.formationsKeejob.filter(item => item.Id !== id);\n          Swal.fire({\n            title: 'Supprim√©!',\n            text: 'Formation supprim√©e avec succ√®s',\n            icon: 'success',\n            timer: 1500,\n            showConfirmButton: false\n          }).then(() => {\n            this.fetchformationsKeejob(); // Recharger au lieu de reload\n          });\n        }, error => {\n          console.error('Erreur suppression:', error);\n          Swal.fire({\n            icon: 'error',\n            title: 'Erreur lors de la suppression',\n            showConfirmButton: false,\n            timer: 1500\n          });\n        });\n      }\n    });\n  } // M√©thode helper pour mapper la r√©ponse backend vers FormationKeejob\n\n\n  mapToFormationKeejob(data) {\n    return new FormationKeejob(data.id || data.Id, // Support des deux formats\n    data.title || data.Title, data.description || data.Description, data.image || data.Image, data.partenaires || data.Partenaires || []);\n  } // Soumettre le formulaire\n\n\n  handleSubmit() {\n    if (!this.formData.title || !this.formData.description) {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Attention',\n        text: 'Veuillez remplir tous les champs obligatoires',\n        timer: 2000\n      });\n      return;\n    }\n\n    if (!this.selectedImage && this.modalMode === 'add') {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Attention',\n        text: 'Veuillez s√©lectionner une image',\n        timer: 2000\n      });\n      return;\n    }\n\n    const fd = new FormData();\n    fd.append('title', this.formData.title);\n    fd.append('description', this.formData.description);\n\n    if (this.selectedImage) {\n      fd.append('image', this.selectedImage, this.selectedImage.name);\n    }\n\n    if (this.selectedPartenaires.length > 0) {\n      this.selectedPartenaires.forEach(p => {\n        fd.append(\"partenairesIds\", p.id.toString());\n      });\n    }\n\n    if (this.modalMode === 'add') {\n      this.formationsKeejobervice.addFormationKeejob(fd).subscribe(res => {\n        console.log('‚úÖ Formation cr√©√©e:', res); // ‚úÖ Utiliser la m√©thode de mapping\n\n        this.createdFormation = this.mapToFormationKeejob(res);\n        console.log('üì¶ createdFormation:', this.createdFormation);\n        console.log('üîë formationId (via getter):', this.createdFormation.Id);\n        this.showModal = false;\n        this.currentStep = 2;\n        Swal.fire({\n          icon: 'success',\n          title: 'Formation cr√©√©e!',\n          text: 'Vous pouvez maintenant ajouter des sous-formations',\n          timer: 2000,\n          showConfirmButton: false\n        });\n      }, error => {\n        console.error('‚ùå Erreur cr√©ation:', error);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Impossible de cr√©er la formation',\n          timer: 2000\n        });\n      });\n    } else {\n      // MODE √âDITION\n      this.formationsKeejobervice.putFormationKeejob(this.editId, fd).subscribe(res => {\n        Swal.fire({\n          icon: 'success',\n          title: 'Formation modifi√©e!',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        this.closeModal();\n        this.fetchformationsKeejob();\n      }, error => {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Impossible de modifier la formation',\n          timer: 2000\n        });\n      });\n    }\n  }\n\n  toggleSidebar() {\n    this.sidebarOpen = !this.sidebarOpen;\n  }\n\n  logout() {\n    this.authService.logout();\n    Swal.fire({\n      icon: 'info',\n      title: 'Vous √™tes d√©connect√©',\n      showConfirmButton: false,\n      timer: 1500\n    });\n    this.router.navigate(['/']);\n  }\n\n  onImageSelected(event) {\n    const file = event.target.files[0];\n\n    if (file) {\n      if (!file.type.startsWith('image/')) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Veuillez s√©lectionner une image valide',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      if (file.size > 5 * 1024 * 1024) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'L\\'image ne doit pas d√©passer 5MB',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      this.selectedImage = file;\n    }\n  }\n\n  sanitizeImage(url) {\n    if (!url) return '';\n\n    if (url.includes(\"https://res.cloudinary.com\") && url.split(\"https://res.cloudinary.com\").length > 2) {\n      const parts = url.split(\"https://res.cloudinary.com/daxkymr4t/image/upload/\");\n      return \"https://res.cloudinary.com/daxkymr4t/image/upload/\" + parts[parts.length - 1];\n    }\n\n    return url;\n  }\n\n  togglePartenaire(p) {\n    const index = this.selectedPartenaires.findIndex(x => x.Id === p.Id);\n\n    if (index > -1) {\n      // Retirer le partenaire\n      this.selectedPartenaires.splice(index, 1);\n    } else {\n      // Ajouter le partenaire\n      this.selectedPartenaires.push(p);\n    } // ‚úÖ Synchroniser avec formData\n\n\n    this.formData.partenaires = [...this.selectedPartenaires];\n    console.log('Partenaires s√©lectionn√©s:', this.selectedPartenaires);\n  }\n\n  isSelected(p) {\n    return this.selectedPartenaires.some(x => x.id === p.Id);\n  } // Fermer le modal\n\n\n  closeModal() {\n    this.showModal = false;\n    this.formData = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      partenaires: []\n    };\n    this.selectedPartenaires = [];\n    this.selectedImage = null;\n  } // Retourner au step 1\n\n\n  backToStep1() {\n    Swal.fire({\n      title: 'Retour √† la liste?',\n      text: \"Les sous-formations ont √©t√© ajout√©es avec succ√®s\",\n      icon: 'success',\n      showCancelButton: true,\n      confirmButtonColor: '#3085d6',\n      cancelButtonColor: '#6c757d',\n      confirmButtonText: 'Oui, retourner',\n      cancelButtonText: 'Rester ici'\n    }).then(result => {\n      if (result.isConfirmed) {\n        // ‚úÖ R√©initialiser compl√®tement\n        this.currentStep = 1;\n        this.createdFormation = null;\n        this.fetchformationsKeejob(); // Recharger la liste\n      }\n    });\n  }\n\n  goToStep3() {\n    this.loadAvailableSousFormations();\n    this.currentStep = 3;\n  }\n\n  backToStep2() {\n    this.currentStep = 2;\n    this.selectedSousFormation = null;\n  } // Charger les sous-formations disponibles\n\n\n  loadAvailableSousFormations() {\n    if (!this.createdFormation) return;\n    this.sousFormationService.getSousFormationKeejobById(this.createdFormation.Id).subscribe({\n      next: data => {\n        this.availableSousFormations = Array.isArray(data) ? data : [data]; // On s√©lectionne automatiquement la premi√®re sous-formation ajout√©e\n\n        this.selectedSousFormation = this.availableSousFormations[0] || null;\n        console.log(\"SousFormationKeejob re√ßu:\", this.selectedSousFormation);\n      },\n      error: err => {\n        console.error('Erreur lors du chargement des sous-formations:', err);\n        this.availableSousFormations = [];\n      }\n    });\n  } // Gestion de la s√©lection d'une sous-formation\n\n\n  onSousFormationSelected(sousFormation) {\n    console.log('SousFormation re√ßue dans step3:', sousFormation); // üëà v√©rifier la structure\n\n    this.selectedSousFormation = sousFormation;\n    this.currentStep = 3;\n  }\n\n  onSousFormationChange() {\n    // Appel√© quand l'utilisateur change de sous-formation dans le select\n    console.log('Sous-formation s√©lectionn√©e:', this.selectedSousFormation);\n  } // Terminer le processus\n\n\n  finishProcess() {\n    if (!this.selectedSousFormation || this.selectedLogiciels.length === 0) {\n      alert(\"Veuillez s√©lectionner au moins un logiciel.\");\n      return;\n    }\n\n    const payload = {\n      sousFormationId: this.selectedSousFormation.id,\n      logiciels: this.selectedLogiciels.map(l => l.id)\n    };\n    this.sousFormationService.assignLogicielsToSousFormation(payload).subscribe({\n      next: () => {\n        alert(\"Logiciels assign√©s avec succ√®s !\");\n      },\n      error: err => {\n        console.error(err);\n      }\n    });\n    this.backToStep1();\n  }\n\n  onLogicielSelected(list) {\n    this.selectedLogiciels = list;\n  }\n\n  toggleSousFormations(formationId) {\n    if (this.openedFormationId === formationId) {\n      // Fermer le tableau si d√©j√† ouvert\n      this.openedFormationId = null;\n      return;\n    }\n\n    this.sousFormationService.getSousFormationKeejobByFormationKeejob(formationId).subscribe(sousFormations => {\n      this.sousFormationsMap[formationId] = sousFormations;\n      this.openedFormationId = formationId;\n    }, error => console.error('Erreur lors de la r√©cup√©ration des sous-formations', error));\n  }\n\n  editSousFormation(sf) {\n    console.log('Edit', sf); // Appeler ton service pour √©diter\n  }\n\n  deleteSousFormation(sfId) {\n    console.log('Delete', sfId); // Appeler ton service pour supprimer\n  }\n\n  handleEditSF(sousFormation) {\n    var _a;\n\n    this.modalMode = 'edit';\n    this.formDataSF = {\n      id: sousFormation.Id,\n      title: sousFormation.Title,\n      description: sousFormation.Description,\n      image: sousFormation.Image,\n      formationKeejobId: (_a = sousFormation.FormationKeejob) === null || _a === void 0 ? void 0 : _a.Id,\n      sousFormationPartenaires: sousFormation.Partenaires || []\n    };\n    this.editId = sousFormation.Id;\n    this.showModal = true;\n  }\n\n  handleDeleteSF(id) {\n    Swal.fire({\n      title: '√ätes-vous s√ªr?',\n      text: \"Cette action est irr√©versible!\",\n      icon: 'warning',\n      showCancelButton: true,\n      confirmButtonColor: '#3085d6',\n      cancelButtonColor: '#d33',\n      confirmButtonText: 'Oui, supprimer!',\n      cancelButtonText: 'Annuler'\n    }).then(result => {\n      if (result.isConfirmed) {\n        this.sousFormationService.deleteSousFormationKeejob(id).subscribe(() => {\n          this.sousFormationKeejob = this.sousFormationKeejob.filter(item => item.Id !== id);\n          Swal.fire({\n            title: 'Supprim√©!',\n            text: 'Sous-formation supprim√©e avec succ√®s',\n            icon: 'success',\n            timer: 1500,\n            showConfirmButton: false\n          });\n        }, error => {\n          console.error('Erreur suppression:', error);\n          Swal.fire({\n            icon: 'error',\n            title: 'Erreur lors de la suppression',\n            timer: 1500\n          });\n        });\n      }\n    });\n  }\n\n  toggleLogiciel(sf) {\n    console.log('üîç Objet sf complet:', sf);\n    const sfId = sf.id; // ‚úÖ ici id et non Id\n\n    if (!sfId) {\n      console.error('‚ùå ID manquant - objet:', sf);\n      return;\n    }\n\n    if (this.openedsfId === sfId) {\n      this.openedsfId = null;\n      return;\n    }\n\n    this.logicielService.getLogicielBySousFormationKeejob(sfId).subscribe(logiciels => {\n      console.log('‚úÖ Logiciels re√ßus:', logiciels);\n      this.logicielMap[sfId] = logiciels;\n      this.openedsfId = sfId;\n    }, error => {\n      console.error('‚ùå Erreur logiciels:', error);\n    });\n  }\n\n  debugSousFormation(sf) {\n    console.log('üîç Structure de sf:', sf);\n    console.log('üîë sf.Id:', sf.Id);\n    console.log('üîë sf.id:', sf.id);\n    console.log('üîë Toutes les cl√©s:', Object.keys(sf));\n  }\n\n  openlogicielModal(log) {\n    console.log('Donn√©es logiciel:', log); // V√©rifier les donn√©es\n\n    if (this.logicielChild) {\n      this.logicielChild.editlogicielFromParent(log);\n    } else {\n      console.error('Le child component n\\'est pas disponible');\n    }\n  }\n\n  editLogiciel(sf) {\n    console.log('Edit', sf); // Appeler ton service pour √©diter\n  }\n\n  deleteLogiciel(sfId) {\n    console.log('Delete', sfId); // Appeler ton service pour supprimer\n  }\n\n};\n\n__decorate([ViewChild(SousFormationKeejobComponent)], FormationKeejobComponent.prototype, \"sousFormationChild\", void 0);\n\n__decorate([ViewChild(LogicielComponent)], FormationKeejobComponent.prototype, \"logicielChild\", void 0);\n\nFormationKeejobComponent = __decorate([Component({\n  selector: 'app-formation-keejob',\n  templateUrl: './formation-keejob.component.html',\n  styleUrls: ['./formation-keejob.component.css']\n})], FormationKeejobComponent);\nexport { FormationKeejobComponent };","map":null,"metadata":{},"sourceType":"module"}