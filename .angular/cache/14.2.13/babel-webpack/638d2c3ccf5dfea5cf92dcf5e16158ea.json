{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Evaluation, Category, EvaluationCategory } from 'src/app/models/evaluation';\nimport { Partenaire } from 'src/app/models/partenaire';\nimport Swal from 'sweetalert2';\nlet EvaluationComponent = class EvaluationComponent {\n  constructor(evaluationservice, partenaireService, authService, router) {\n    this.evaluationservice = evaluationservice;\n    this.partenaireService = partenaireService;\n    this.authService = authService;\n    this.router = router;\n    this.sidebarOpen = true;\n    this.evaluations = [];\n    this.loading = false;\n    this.currentPage = 1;\n    this.itemsPerPage = 5;\n    this.showModal = false;\n    this.modalMode = 'add';\n    this.evaluationCategoryEnum = EvaluationCategory;\n    this.availableEvaluationCategories = Object.values(EvaluationCategory);\n    this.formData = {\n      id: null,\n      name: '',\n      description: '',\n      image: '',\n      evaluationCategory: null // NOUVEAU\n\n    };\n    this.editId = null;\n    this.selectedImage = null;\n    this.currentModalStep = 1;\n    this.sections = []; // Enum et cat√©gories disponibles\n\n    this.categoryEnum = Category;\n    this.availableCategories = Object.values(Category);\n    this.customCategories = []; // Partenaires\n\n    this.allPartenaires = [];\n    this.selectedPartenaires = []; // Catalogues\n\n    this.catalogues = [];\n  }\n\n  ngOnInit() {\n    this.fetchEvaluations();\n    this.fetchPartenaires();\n  }\n\n  fetchPartenaires() {\n    this.loading = true;\n    console.log('üì° R√©cup√©ration des partenaires...');\n    this.partenaireService.getPartenaire().subscribe(response => {\n      console.log('‚úÖ R√©ponse partenaires:', response);\n      this.allPartenaires = response.map(p => new Partenaire(p.id, p.title, p.description, p.image));\n      this.loading = false;\n    }, error => {\n      console.error('‚ùå Erreur lors du chargement des partenaires:', error);\n      this.loading = false;\n      Swal.fire({\n        icon: 'error',\n        title: 'Erreur lors du chargement des partenaires',\n        showConfirmButton: false,\n        timer: 1500\n      });\n    });\n  }\n\n  initializeSections() {\n    this.sections = [{\n      headline: '',\n      subtitle: '',\n      details: []\n    }, {\n      headline: '',\n      subtitle: '',\n      details: []\n    }, {\n      headline: '',\n      subtitle: '',\n      details: []\n    }, {\n      headline: '',\n      subtitle: '',\n      details: []\n    }];\n  }\n\n  fetchEvaluations() {\n    this.loading = true;\n    this.evaluationservice.getEvaluation().subscribe({\n      next: response => {\n        this.evaluations = response.map(data => new Evaluation(data));\n        this.loading = false;\n        console.log('Donn√©es re√ßuesss: ', this.evaluations);\n      },\n      error: error => {\n        console.error('Erreur lors du chargement des √©valuations:', error);\n        this.loading = false;\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur lors du chargement des donn√©es',\n          showConfirmButton: false,\n          timer: 1500\n        });\n      }\n    });\n  }\n\n  get currentItems() {\n    const indexOfLastItem = this.currentPage * this.itemsPerPage;\n    const indexOfFirstItem = indexOfLastItem - this.itemsPerPage;\n    return this.evaluations.slice(indexOfFirstItem, indexOfLastItem);\n  }\n\n  get totalPages() {\n    return Math.ceil(this.evaluations.length / this.itemsPerPage);\n  }\n\n  get pagesArray() {\n    return Array(this.totalPages).fill(0).map((_, i) => i + 1);\n  }\n\n  handlePageChange(pageNumber) {\n    this.currentPage = pageNumber;\n  }\n\n  handleAdd() {\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      name: '',\n      description: '',\n      image: '',\n      evaluationCategory: null // NOUVEAU\n\n    };\n    this.selectedImage = null;\n    this.initializeSections();\n    this.selectedPartenaires = [];\n    this.catalogues = [];\n    this.currentModalStep = 1;\n    this.showModal = true;\n  }\n\n  handleEdit(evaluation) {\n    this.modalMode = 'edit';\n    this.formData = {\n      id: evaluation.Id,\n      name: evaluation.Name || '',\n      description: evaluation.Description || '',\n      image: evaluation.Image || '',\n      evaluationCategory: evaluation.Category || null // NOUVEAU\n\n    };\n    this.editId = evaluation.Id;\n    this.selectedImage = null;\n\n    if (evaluation.Sections && evaluation.Sections.length > 0) {\n      this.sections = [...evaluation.Sections];\n\n      while (this.sections.length < 4) {\n        this.sections.push({\n          headline: '',\n          subtitle: '',\n          details: []\n        });\n      }\n    } else {\n      this.initializeSections();\n    }\n\n    this.selectedPartenaires = evaluation.Partenaires ? [...evaluation.Partenaires] : [];\n\n    if (evaluation.Catalogues && evaluation.Catalogues.length > 0) {\n      this.catalogues = evaluation.Catalogues.map(cat => ({\n        title: cat.Title,\n        image: null,\n        imagePreview: cat.Image\n      }));\n    } else {\n      this.catalogues = [];\n    }\n\n    this.currentModalStep = 1;\n    this.showModal = true;\n  }\n\n  closeModal() {\n    this.showModal = false;\n    this.formData = {\n      id: null,\n      name: '',\n      description: '',\n      image: '',\n      evaluationCategory: null // NOUVEAU\n\n    };\n    this.selectedImage = null;\n    this.editId = null;\n    this.sections = [];\n    this.selectedPartenaires = [];\n    this.catalogues = [];\n    this.currentModalStep = 1;\n  }\n\n  handleDelete(id) {\n    Swal.fire({\n      title: '√ätes-vous s√ªr?',\n      text: \"Vous ne pourrez pas revenir en arri√®re!\",\n      icon: 'warning',\n      showCancelButton: true,\n      confirmButtonColor: '#3085d6',\n      cancelButtonColor: '#d33',\n      confirmButtonText: 'Oui, supprimer!',\n      cancelButtonText: 'Annuler'\n    }).then(result => {\n      if (result.isConfirmed) {\n        this.evaluationservice.deleteEvaluation(id).subscribe({\n          next: () => {\n            this.evaluations = this.evaluations.filter(item => item.Id !== id);\n            Swal.fire({\n              title: 'Supprim√©!',\n              text: '√âvaluation supprim√©e avec succ√®s',\n              icon: 'success',\n              timer: 1500,\n              showConfirmButton: false\n            });\n          },\n          error: error => {\n            console.error('Erreur lors de la suppression:', error);\n            Swal.fire({\n              icon: 'error',\n              title: 'Erreur lors de la suppression',\n              text: error.message || 'Une erreur est survenue',\n              showConfirmButton: false,\n              timer: 1500\n            });\n          }\n        });\n      }\n    });\n  }\n\n  addDetailToSection(sectionIndex) {\n    if (this.sections[sectionIndex]) {\n      this.sections[sectionIndex].details.push({\n        titre: '',\n        description: '',\n        icon: '',\n        category: null\n      });\n    }\n  }\n\n  removeDetailFromSection(sectionIndex, detailIndex) {\n    if (this.sections[sectionIndex] && this.sections[sectionIndex].details[detailIndex]) {\n      Swal.fire({\n        title: 'Supprimer ce d√©tail?',\n        text: \"Cette action est irr√©versible\",\n        icon: 'warning',\n        showCancelButton: true,\n        confirmButtonColor: '#f44336',\n        cancelButtonColor: '#666',\n        confirmButtonText: 'Oui, supprimer',\n        cancelButtonText: 'Annuler'\n      }).then(result => {\n        if (result.isConfirmed) {\n          this.sections[sectionIndex].details.splice(detailIndex, 1);\n        }\n      });\n    }\n  }\n\n  addCustomCategory(sectionIndex, detailIndex) {\n    Swal.fire({\n      title: 'Ajouter une cat√©gorie',\n      input: 'text',\n      inputPlaceholder: 'Nom de la cat√©gorie',\n      showCancelButton: true,\n      confirmButtonText: 'Ajouter',\n      cancelButtonText: 'Annuler',\n      inputValidator: value => {\n        if (!value) {\n          return 'Veuillez entrer un nom de cat√©gorie!';\n        }\n\n        return null;\n      }\n    }).then(result => {\n      if (result.isConfirmed && result.value) {\n        const newCategory = result.value.trim();\n\n        if (!this.customCategories.includes(newCategory)) {\n          this.customCategories.push(newCategory);\n        }\n\n        this.sections[sectionIndex].details[detailIndex].category = newCategory;\n      }\n    });\n  }\n\n  getAllCategories() {\n    return [...this.availableCategories, ...this.customCategories];\n  } // Gestion des partenaires\n\n\n  togglePartenaireSelection(partenaire) {\n    const index = this.selectedPartenaires.findIndex(p => p.Id === partenaire.Id);\n\n    if (index > -1) {\n      this.selectedPartenaires.splice(index, 1);\n    } else {\n      this.selectedPartenaires.push(partenaire);\n    }\n  }\n\n  isPartenaireSelected(partenaire) {\n    return this.selectedPartenaires.some(p => p.Id === partenaire.Id);\n  } // Gestion des catalogues\n\n\n  addCatalogue() {\n    this.catalogues.push({\n      title: '',\n      image: null,\n      imagePreview: null\n    });\n  }\n\n  removeCatalogue(index) {\n    Swal.fire({\n      title: 'Supprimer ce catalogue?',\n      text: \"Cette action est irr√©versible\",\n      icon: 'warning',\n      showCancelButton: true,\n      confirmButtonColor: '#f44336',\n      cancelButtonColor: '#666',\n      confirmButtonText: 'Oui, supprimer',\n      cancelButtonText: 'Annuler'\n    }).then(result => {\n      if (result.isConfirmed) {\n        this.catalogues.splice(index, 1);\n      }\n    });\n  }\n\n  onCatalogueImageSelected(event, index) {\n    const file = event.target.files[0];\n\n    if (file) {\n      if (!file.type.startsWith('image/')) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Veuillez s√©lectionner une image valide',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      if (file.size > 5 * 1024 * 1024) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'L\\'image ne doit pas d√©passer 5MB',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      this.catalogues[index].image = file; // Preview\n\n      const reader = new FileReader();\n\n      reader.onload = e => {\n        this.catalogues[index].imagePreview = e.target.result;\n      };\n\n      reader.readAsDataURL(file);\n    }\n  }\n\n  handleSubmit() {\n    // V√©rification des champs obligatoires\n    if (!this.formData.name || !this.formData.description || !this.formData.evaluationCategory) {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Champs manquants',\n        text: 'Veuillez remplir tous les champs obligatoires (nom, description et cat√©gorie)',\n        timer: 2000,\n        showConfirmButton: false\n      });\n      this.currentModalStep = 1;\n      return;\n    }\n\n    if (this.modalMode === 'add' && !this.selectedImage) {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Image manquante',\n        text: 'Veuillez s√©lectionner une image',\n        timer: 2000,\n        showConfirmButton: false\n      });\n      this.currentModalStep = 1;\n      return;\n    } // Cr√©ation de FormData\n\n\n    const formData = new FormData();\n    formData.append('name', this.formData.name);\n    formData.append('description', this.formData.description);\n    formData.append('evaluationCategory', this.formData.evaluationCategory); // NOUVEAU\n\n    if (this.selectedImage) {\n      formData.append('image', this.selectedImage, this.selectedImage.name);\n    } // Sections s√©curis√©es\n\n\n    const safeSections = this.sections.map(s => ({\n      headline: s.headline || '',\n      subtitle: s.subtitle || '',\n      details: (s.details || []).map(d => ({\n        titre: d.titre || '',\n        description: d.description || '',\n        icon: d.icon || '',\n        category: d.category || null\n      }))\n    }));\n    formData.append('sections', JSON.stringify(safeSections)); // Partenaires s√©curis√©s\n\n    (this.selectedPartenaires || []).forEach(p => {\n      if ((p === null || p === void 0 ? void 0 : p.Id) != null) formData.append('partenairesIds', p.Id.toString());\n    }); // Catalogues s√©curis√©s\n\n    (this.catalogues || []).forEach(cat => {\n      if (cat.title) formData.append('catalogueTitles', cat.title);\n\n      if (cat.image instanceof File) {\n        formData.append('catalogueImages', cat.image, cat.image.name);\n      }\n    }); // Envoi au service\n\n    const request$ = this.modalMode === 'add' ? this.evaluationservice.addEvaluation(formData) : this.evaluationservice.putEvaluation(this.editId, formData);\n    request$.subscribe({\n      next: response => {\n        const newEvaluation = new Evaluation({\n          id: response.id,\n          name: response.name,\n          description: response.description,\n          image: response.image,\n          sections: response.sections || [],\n          evaluationPartenaires: response.evaluationPartenaires || [],\n          evaluationCatalogues: response.evaluationCatalogues || [],\n          evaluationCategory: response.evaluationCategory || null // NOUVEAU\n\n        });\n\n        if (this.modalMode === 'add') {\n          this.evaluations.push(newEvaluation);\n        } else {\n          const index = this.evaluations.findIndex(item => item.Id === this.editId);\n          if (index !== -1) this.evaluations[index] = newEvaluation;\n        }\n\n        this.closeModal();\n        Swal.fire({\n          title: 'Succ√®s!',\n          text: this.modalMode === 'add' ? '√âvaluation ajout√©e avec succ√®s' : '√âvaluation modifi√©e avec succ√®s',\n          icon: 'success',\n          timer: 1500,\n          showConfirmButton: false\n        }).then(() => this.fetchEvaluations());\n      },\n      error: error => {\n        console.error('Erreur:', error);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: (error === null || error === void 0 ? void 0 : error.message) || 'Une erreur est survenue',\n          showConfirmButton: false,\n          timer: 1500\n        });\n      }\n    });\n  }\n\n  toggleSidebar() {\n    this.sidebarOpen = !this.sidebarOpen;\n  }\n\n  logout() {\n    this.authService.logout();\n    Swal.fire({\n      icon: 'info',\n      title: 'D√©connexion',\n      text: 'Vous √™tes d√©connect√©',\n      showConfirmButton: false,\n      timer: 1500\n    });\n    this.router.navigate(['/']);\n  }\n\n  onImageSelected(event) {\n    const file = event.target.files[0];\n\n    if (file) {\n      if (!file.type.startsWith('image/')) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Veuillez s√©lectionner une image valide',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      if (file.size > 5 * 1024 * 1024) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'L\\'image ne doit pas d√©passer 5MB',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      this.selectedImage = file;\n    }\n  }\n\n  sanitizeImage(url) {\n    if (!url) return '';\n\n    if (url.includes(\"https://res.cloudinary.com\") && url.split(\"https://res.cloudinary.com\").length > 2) {\n      const parts = url.split(\"https://res.cloudinary.com/daxkymr4t/image/upload/\");\n      return \"https://res.cloudinary.com/daxkymr4t/image/upload/\" + parts[parts.length - 1];\n    }\n\n    return url;\n  } // Modifications dans le component TypeScript\n  // Dans la m√©thode handleSubmit(), remplacer la condition finale:\n  // Ligne: if (this.currentModalStep === 5)\n  // Par: if (this.currentModalStep === 7)\n  // 1. Modifier la progression pour inclure 7 steps au lieu de 5\n\n\n  nextModalStep() {\n    if (this.currentModalStep === 1) {\n      if (!this.formData.name || !this.formData.description || !this.formData.evaluationCategory) {\n        Swal.fire({\n          icon: 'warning',\n          title: 'Champs manquants',\n          text: 'Veuillez remplir le nom, la description et s√©lectionner une cat√©gorie',\n          timer: 2000,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      if (this.modalMode === 'add' && !this.selectedImage) {\n        Swal.fire({\n          icon: 'warning',\n          title: 'Image manquante',\n          text: 'Veuillez s√©lectionner une image',\n          timer: 2000,\n          showConfirmButton: false\n        });\n        return;\n      }\n    } // ... reste de la validation ...\n\n\n    if (this.currentModalStep < 7) {\n      this.currentModalStep++;\n    }\n  }\n\n  previousModalStep() {\n    if (this.currentModalStep > 1) {\n      this.currentModalStep--;\n    }\n  }\n\n  goToModalStep(step) {\n    if (step <= this.currentModalStep) {\n      this.currentModalStep = step;\n    }\n  }\n\n  countCompletedSections() {\n    return this.sections.filter((s, index) => {\n      // V√©rifier seulement headline et details (subtitle est optionnel)\n      if (!s.headline || s.details.length === 0) {\n        return false;\n      } // V√©rifier seulement titre et icon (description et category sont optionnels)\n\n\n      return s.details.every(d => d.titre && d.icon);\n    }).length;\n  }\n\n};\nEvaluationComponent = __decorate([Component({\n  selector: 'app-evaluation',\n  templateUrl: './evaluation.component.html',\n  styleUrls: ['./evaluation.component.css']\n})], EvaluationComponent);\nexport { EvaluationComponent };","map":null,"metadata":{},"sourceType":"module"}