{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Documents } from 'src/app/components/models/documents';\nimport { Sinistre } from 'src/app/components/models/sinistre';\nlet SinistreComponent = class SinistreComponent {\n  constructor(sinistreService, messageService, documentService, sanitizer) {\n    this.sinistreService = sinistreService;\n    this.messageService = messageService;\n    this.documentService = documentService;\n    this.sanitizer = sanitizer;\n    this.sinistres = []; // Define the sinistres property as an array\n\n    this.selectedSinistres = [];\n    this.submitted = false;\n    this.cols = [];\n    this.rowsPerPageOptions = [5, 10, 20];\n    this.selectedStatuses = {}; // Tableau pour stocker les statuts sélectionnés par commande\n\n    this.statusOptions = [{\n      label: 'déclaration',\n      value: 'déclaration'\n    }, {\n      label: 'expertise',\n      value: 'expertise'\n    }, {\n      label: 'reglement',\n      value: 'reglement'\n    }];\n    this.selectedPdfName = ''; // Stocke le nom du PDF\n\n    this.selectedPdf = null;\n    this.displayPdfDialog = false;\n    this.sinistresValides = [];\n  }\n\n  ngOnInit() {\n    this.getAllSinistre();\n  } // getAllSinistre(): void {\n  //   this.sinistreService.getAllSinistre().subscribe(\n  //     (data: any[]) => {\n  //       this.sinistres = data.map(doc => new Sinistre(\n  //         doc._id,\n  //         doc.date_survenance,\n  //         doc.date_declaration,\n  //         doc.num_police,\n  //         doc.objet_assure,\n  //         doc.description,\n  //         doc.status,  // Vérifiez que status existe dans les données\n  //         doc.reference,\n  //         doc.documents,\n  //       ));\n  //       console.log('Sinistres:', this.sinistres);  // Vérifiez les données ici\n  //       // Initialisez selectedStatuses\n  //       this.sinistres.forEach(sinistre => {\n  //         this.selectedStatuses[sinistre.Id] = sinistre.Status;\n  //         if (sinistre.Documents) { // Vérifier si documents existe\n  //           this.loadDocuments(sinistre);\n  //         }\n  //       });\n  //     },\n  //     (error) => {\n  //       console.error('Erreur lors de la récupération des documents :', error);\n  //     }\n  //   );\n  // }\n\n\n  getAllSinistre() {\n    this.sinistreService.getAllSinistre().subscribe(data => {\n      // Mapper les sinistres\n      this.sinistres = data.map(doc => new Sinistre(doc._id, doc.date_survenance, doc.date_declaration, doc.num_police, doc.objet_assure, doc.description, doc.status, doc.reference, doc.documents));\n      console.log('Tous les sinistres:', this.sinistres); // Charger les documents pour chaque sinistre\n\n      this.sinistres.forEach(sinistre => {\n        this.selectedStatuses[sinistre.Id] = sinistre.Status;\n\n        if (sinistre.Documents) {\n          this.loadDocuments(sinistre);\n        }\n      });\n    }, error => {\n      console.error('Erreur lors de la récupération des sinistres :', error);\n    });\n  }\n\n  loadDocuments(sinistre) {\n    this.documentService.getDocById(sinistre.Documents).subscribe(doc => {\n      console.log(`Document brut reçu pour le sinistre ${sinistre.Id}:`, doc); // Vérifier si doc est bien une instance de Documents\n\n      if (!(doc instanceof Documents)) {\n        doc = new Documents(doc._id, doc.doc, doc.description, doc.status, doc.client, doc.expert);\n      }\n\n      sinistre.Documents = doc; // Assigner l'objet correctement typé\n\n      console.log(`Document converti pour le sinistre ${sinistre.Id}:`, doc);\n      console.log(`Statut du document récupéré : ${doc.Status}`); // Vérifier si le document a le statut \"Validé\"\n\n      if (doc.Status === 'Validé') {\n        this.sinistresValides.push(sinistre);\n      }\n\n      console.log('Sinistres avec documents validés:', this.sinistresValides);\n    }, error => {\n      console.error('Erreur lors du chargement des documents :', error);\n    });\n  }\n\n  getUserRole() {\n    return localStorage.getItem('userRole');\n  }\n\n  onStatusChange(document, event) {\n    const newStatus = event.value; // Loggez l'objet document pour vérifier la présence de l'ID\n\n    console.log('Document:', document);\n    console.log('Document ID:', document.Id); // Utilisez le getter Id\n\n    if (!document.Id) {\n      console.error('Erreur : L\\'ID du document est manquant');\n      return;\n    }\n\n    this.sinistreService.updateDocStatus(document.Id, newStatus).subscribe(updatedDocument => {\n      console.log('Document mis à jour avec succès :', updatedDocument);\n      const index = this.sinistres.findIndex(o => o.Id === updatedDocument.Id);\n\n      if (index !== -1) {\n        this.sinistres[index] = updatedDocument;\n        this.selectedStatuses[updatedDocument.Id] = updatedDocument.Status; // Swal.fire({\n        //   icon: 'success',\n        //   title: 'Statut modifié',\n        //   showConfirmButton: false,\n        //   timer: 1500\n        // }) \n      }\n\n      this.messageService.add({\n        severity: 'success',\n        summary: 'Succès',\n        detail: 'Statut modifié',\n        life: 1000\n      });\n      window.location.reload();\n    }, error => {\n      console.error('Erreur lors de la mise à jour du statut du document :', error);\n      this.messageService.add({\n        severity: 'error',\n        summary: 'Erreur lors de la mise à jour du statut'\n      });\n    });\n  }\n\n  onGlobalFilter(table, event) {\n    table.filterGlobal(event.target.value, 'contains');\n  }\n\n  openPdf(pdfPath) {\n    this.selectedPdfName = pdfPath; // Stocke le nom du PDF\n\n    const fullPath = `http://localhost:9090/pdf/${pdfPath}`; // Remplace par ton chemin correct\n\n    this.selectedPdf = this.sanitizer.bypassSecurityTrustResourceUrl(fullPath);\n    this.displayPdfDialog = true;\n  }\n\n};\nSinistreComponent = __decorate([Component({\n  selector: 'app-sinistre',\n  templateUrl: './sinistre.component.html',\n  styleUrl: './sinistre.component.scss'\n})], SinistreComponent);\nexport { SinistreComponent };","map":null,"metadata":{},"sourceType":"module"}