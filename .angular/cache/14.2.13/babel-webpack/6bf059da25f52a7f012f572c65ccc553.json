{"ast":null,"code":"import { __awaiter, __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Validators } from '@angular/forms';\nimport { PDFDocument, rgb, StandardFonts } from 'pdf-lib'; // Importez StandardFonts pour les polices standard\n\nimport html2canvas from 'html2canvas';\nimport Swal from 'sweetalert2';\nimport { Sinistre } from 'src/app/components/models/sinistre';\nlet ConstatComponent = class ConstatComponent {\n  constructor(fb, cdr, sharedService, sinistreService) {\n    this.fb = fb;\n    this.cdr = cdr;\n    this.sharedService = sharedService;\n    this.sinistreService = sinistreService;\n    this.elements = [{\n      name: 'Voiture A',\n      img: 'assets/img/croqui/voitureJaune.png'\n    }, {\n      name: 'Voiture B ',\n      img: 'assets/img/croqui/voitureVert.png'\n    }, {\n      name: 'Feu',\n      img: 'assets/img/croqui/feu.png'\n    }, {\n      name: 'Rond point',\n      img: 'assets/img/croqui/rond point.png'\n    }, {\n      name: 'Stop',\n      img: 'assets/img/croqui/stop.png'\n    }, {\n      name: 'Paneau rond point',\n      img: 'assets/img/croqui/panneau rond point.png'\n    }, {\n      name: 'panneau ceder le passage',\n      img: 'assets/img/croqui/ceder le passage.png'\n    }, {\n      name: 'panneau interdit',\n      img: 'assets/img/croqui/interdit.png'\n    }];\n    this.droppedElements = [];\n    this.dragPosition = {\n      x: 0,\n      y: 0\n    };\n    this.vehiclesZones = {\n      vehicleA_car: [{\n        x: 0,\n        y: 40,\n        clicked: false\n      }, {\n        x: 70,\n        y: 40,\n        clicked: false\n      }, {\n        x: 140,\n        y: 40,\n        clicked: false\n      }, {\n        x: 0,\n        y: 120,\n        clicked: false\n      }, {\n        x: 140,\n        y: 120,\n        clicked: false\n      }, {\n        x: 0,\n        y: 200,\n        clicked: false\n      }, {\n        x: 70,\n        y: 200,\n        clicked: false\n      }, {\n        x: 140,\n        y: 200,\n        clicked: false\n      }],\n      vehicleA_moto: [{\n        x: 0,\n        y: 40,\n        clicked: false\n      }, {\n        x: 75,\n        y: 40,\n        clicked: false\n      }, {\n        x: 149,\n        y: 40,\n        clicked: false\n      }, {\n        x: 0,\n        y: 120,\n        clicked: false\n      }, {\n        x: 149,\n        y: 120,\n        clicked: false\n      }, {\n        x: 0,\n        y: 200,\n        clicked: false\n      }, {\n        x: 75,\n        y: 200,\n        clicked: false\n      }, {\n        x: 149,\n        y: 200,\n        clicked: false\n      }],\n      vehicleB_car: [{\n        x: 0,\n        y: 40,\n        clicked: false\n      }, {\n        x: 70,\n        y: 40,\n        clicked: false\n      }, {\n        x: 140,\n        y: 40,\n        clicked: false\n      }, {\n        x: 0,\n        y: 120,\n        clicked: false\n      }, {\n        x: 140,\n        y: 120,\n        clicked: false\n      }, {\n        x: 0,\n        y: 200,\n        clicked: false\n      }, {\n        x: 70,\n        y: 200,\n        clicked: false\n      }, {\n        x: 140,\n        y: 200,\n        clicked: false\n      }],\n      vehicleB_moto: [{\n        x: 5,\n        y: 40,\n        clicked: false\n      }, {\n        x: 75,\n        y: 40,\n        clicked: false\n      }, {\n        x: 148,\n        y: 40,\n        clicked: false\n      }, {\n        x: 5,\n        y: 120,\n        clicked: false\n      }, {\n        x: 148,\n        y: 120,\n        clicked: false\n      }, {\n        x: 5,\n        y: 200,\n        clicked: false\n      }, {\n        x: 75,\n        y: 200,\n        clicked: false\n      }, {\n        x: 148,\n        y: 200,\n        clicked: false\n      }]\n    };\n    this.today = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD\n    // Cr√©ation du formulaire avec les champs n√©cessaires\n\n    this.accidentForm = this.fb.group({\n      // Champs g√©n√©raux\n      date: ['', Validators.required],\n      time: ['', Validators.required],\n      location: ['', Validators.required],\n      blesse: ['', Validators.required],\n      // D√©g√¢ts mat√©riels\n      otherDamages: ['', Validators.required],\n      // T√©moins\n      witnessName: [''],\n      witnessAddress: [''],\n      witnessPhone: [''],\n      // V√©hicule A\n      insuranceCompanyA: ['', Validators.required],\n      agencyA: ['', Validators.required],\n      contractNumberA: ['', Validators.required],\n      validFromA: ['', Validators.required],\n      validToA: ['', Validators.required],\n      // Informations sur le conducteur du v√©hicule A\n      driverNameA: ['', Validators.required],\n      driverFirstNameA: ['', Validators.required],\n      driverAddressA: ['', Validators.required],\n      driverPhoneA: ['', Validators.required],\n      driverLicenseNumberA: ['', Validators.required],\n      driverLicenseIssuedDateA: ['', Validators.required],\n      // Informations sur le v√©hicule A\n      vehicleRegistrationA: ['', Validators.required],\n      vehicleBrandA: ['', [Validators.required, this.containsCommaValidator]],\n      vehicleModelA: ['', Validators.required],\n      vehicleColorA: ['', Validators.required],\n      // Informations sur l'assur√©\n      insuredNameA: ['', Validators.required],\n      insuredFirstNameA: ['', Validators.required],\n      insuredAddressA: ['', Validators.required],\n      insuredPhoneA: ['', Validators.required],\n      venantA: ['', Validators.required],\n      allantA: ['', Validators.required],\n      degatsApparentsA: ['', Validators.required],\n      observationsA: ['', Validators.required],\n      // V√©hicule B\n      insuranceCompanyB: ['', Validators.required],\n      agencyB: ['', Validators.required],\n      contractNumberB: ['', Validators.required],\n      validFromB: ['', Validators.required],\n      validToB: ['', Validators.required],\n      // Informations sur le conducteur du v√©hicule A\n      driverNameB: ['', Validators.required],\n      driverFirstNameB: ['', Validators.required],\n      driverAddressB: ['', Validators.required],\n      driverPhoneB: ['', Validators.required],\n      driverLicenseNumberB: ['', Validators.required],\n      driverLicenseIssuedDateB: ['', Validators.required],\n      // Informations sur le v√©hicule A\n      vehicleRegistrationB: ['', Validators.required],\n      vehicleBrandB: ['', [Validators.required, this.containsCommaValidator]],\n      vehicleModelB: ['', Validators.required],\n      vehicleColorB: ['', Validators.required],\n      // Informations sur l'assur√©\n      insuredNameB: ['', Validators.required],\n      insuredFirstNameB: ['', Validators.required],\n      insuredAddressB: ['', Validators.required],\n      insuredPhoneB: ['', Validators.required],\n      venantB: ['', Validators.required],\n      allantB: ['', Validators.required],\n      degatsApparentsB: ['', Validators.required],\n      observationsB: ['', Validators.required]\n    }, {\n      validators: this.dateValidator\n    }); // Ajout du validateur ici\n  }\n\n  ngOnInit() {\n    console.log(\"Elements disponibles:\", this.elements);\n    console.log(\"onDrop function:\", this.onDrop); // ‚úÖ V√©rifiez que la fonction est bien reconnue\n  }\n\n  convertRGB(r, g, b) {\n    return rgb(r / 255, g / 255, b / 255); // Retourne un objet RGB\n  } // Fonction pour activer/d√©sactiver la croix sur la zone cliqu√©e\n\n\n  toggleCross(vehicleKey, index) {\n    if (this.vehiclesZones[vehicleKey] && this.vehiclesZones[vehicleKey][index]) {\n      this.vehiclesZones[vehicleKey][index].clicked = !this.vehiclesZones[vehicleKey][index].clicked;\n    }\n  }\n\n  createPdf() {\n    return __awaiter(this, void 0, void 0, function* () {\n      const pdfDoc = yield PDFDocument.create();\n      const page = pdfDoc.addPage([600, 800]);\n      const font = yield pdfDoc.embedFont(StandardFonts.Helvetica);\n      const boldFont = yield pdfDoc.embedFont(StandardFonts.HelveticaBold); // Police en gras\n      // Ajouter le logo en haut √† gauche\n\n      const logoUrl = 'assets/img/logo_ftusa.png';\n      const logoImage = yield fetch(logoUrl).then(res => res.blob()).then(blob => blob.arrayBuffer());\n      const logo = yield pdfDoc.embedPng(logoImage);\n      page.drawImage(logo, {\n        x: 20,\n        y: 750,\n        width: 100,\n        height: 50\n      }); // Ajouter le titre en gras et en grand\n\n      const title = \"Constat amiable d'accident automobile\";\n      page.drawText(title, {\n        x: 120,\n        y: 760,\n        size: 16,\n        font: boldFont,\n        color: rgb(0, 0, 0) // Couleur noire\n\n      }); // Texte sous le titre √† gauche (petit)\n\n      page.drawText(\"√Ä signer obligatoirement par les DEUX conducteurs\", {\n        x: 320,\n        y: 748,\n        size: 4.3,\n        font: font,\n        color: rgb(0, 0, 0) // Noir\n\n      }); // Texte sous le titre √† droite (petit)\n\n      page.drawText(\"Ne constitue pas une reconnaissance de responsabilit√©, mais un relev√© des identit√©s et des faits, servant √† l‚Äôacc√©l√©ration du r√®glement\", {\n        x: 20,\n        y: 748,\n        size: 4.3,\n        font: font,\n        color: rgb(0, 0, 0),\n        maxWidth: 260 // Ajuster la largeur pour √©viter le chevauchement\n\n      }); // Laisser un espace avant le tableau\n\n      const startX = 50,\n            startY = 711,\n            cellWidth = 130,\n            cellHeight = 30; // Dessiner le tableau avec les infos de l'accident\n\n      const headers = [\"Date\", \"Heure\", \"Lieu\", \"Bless√©\", \"D√©g√¢ts\", \"T√©moin\", \"Adresse\", \"T√©l√©phone\"];\n      const values = [this.accidentForm.value.date || \"N/A\", this.accidentForm.value.time || \"N/A\", this.accidentForm.value.location || \"N/A\", this.accidentForm.value.blesse || \"N/A\", this.accidentForm.value.otherDamages || \"N/A\", this.accidentForm.value.witnessName || \"N/A\", this.accidentForm.value.witnessAddress || \"N/A\", this.accidentForm.value.witnessPhone || \"N/A\"];\n      this.drawTable(page, font, headers, values, startX, startY, cellWidth, cellHeight); // Ajouter les infos des v√©hicules\n\n      const endTableY = startY - Math.floor(headers.length / 4) * cellHeight;\n      const vehiculeY = endTableY - 2;\n      this.addVehicleInfo(page, font, pdfDoc, 'A', 80, vehiculeY);\n      this.addVehicleInfo(page, font, pdfDoc, 'B', 280, vehiculeY); // Ajouter les checkboxes et les textes entre les v√©hicules\n\n      const textsBetween = [{\n        text: \"en statlonnement\",\n        marginTop: -7\n      }, {\n        text: \"quittait un stationnement\",\n        marginTop: -9\n      }, {\n        text: \"prenait un stationnement\",\n        marginTop: -9\n      }, {\n        text: \"sortait d'un parking, d'un lieu priv√©, d'un chemin de terre\",\n        marginTop: -9\n      }, {\n        text: \"s'engageait dans un parking, un lieu priv√© un chemin de terre\",\n        marginTop: -18\n      }, {\n        text: \"arr√™t de circulation\",\n        marginTop: -9\n      }, {\n        text: \"frottement sans changement de file\",\n        marginTop: -11\n      }, {\n        text: \"heurtait √† l'arriere, en roulant dans le m√™me sens et sur une m√™me file\",\n        marginTop: -21\n      }, {\n        text: \"roulait dans le m√™me sens et sur une file diff√©rente\",\n        marginTop: -23\n      }, {\n        text: \"changeait de file\",\n        marginTop: -18\n      }, {\n        text: \"doublait\",\n        marginTop: 10\n      }, {\n        text: \"virait √† droite\",\n        marginTop: -9\n      }, {\n        text: \"virait √† gauche\",\n        marginTop: -10\n      }, {\n        text: \"reculait\",\n        marginTop: -8\n      }, {\n        text: \"empi√©tait sur la partie de chauss√© r√©servee √† la circulation en sens inverse\",\n        marginTop: 7.5\n      }, {\n        text: \"venait de droite (dans un carrefour)\",\n        marginTop: -19\n      }, {\n        text: \"n'avait pas observ√© le signal de priorit√©\",\n        marginTop: -6\n      }];\n      let checkboxY = vehiculeY - 20;\n      textsBetween.forEach((item, index) => {\n        checkboxY -= item.marginTop; // Case √† cocher √† gauche\n\n        const textParts = this.wrapText(item.text, 103, font, 8);\n        page.drawRectangle({\n          x: 230,\n          y: checkboxY,\n          width: 10,\n          height: 10,\n          borderColor: rgb(0, 0, 0),\n          borderWidth: 1\n        }); // Texte centr√©\n\n        textParts.forEach((line, i) => {\n          page.drawText(line, {\n            x: 250,\n            y: checkboxY + 2 - i * 10,\n            size: 8,\n            font: font,\n            color: rgb(0, 0, 0)\n          });\n        }); // Case √† cocher √† droite\n\n        page.drawRectangle({\n          x: 357,\n          y: checkboxY,\n          width: 10,\n          height: 10,\n          borderColor: rgb(0, 0, 0),\n          borderWidth: 1\n        });\n        checkboxY -= textParts.length * 10 + 5; // V√©rifier si la case est coch√©e et dessiner une marque de coche\n\n        const checkboxLeft = document.querySelectorAll('.input-group-A .left-checkbox')[index];\n        const checkboxRight = document.querySelectorAll('.input-group-B .right-checkbox')[index];\n        console.log(`Index: ${index}, checkboxLeft: ${checkboxLeft}, checkboxRight: ${checkboxRight}`);\n\n        if (checkboxLeft && checkboxLeft.checked) {\n          page.drawText('X', {\n            x: 232,\n            y: checkboxY + 2,\n            size: 8,\n            font: font,\n            color: rgb(0, 0, 0)\n          });\n        }\n\n        if (checkboxRight && checkboxRight.checked) {\n          page.drawText('X', {\n            x: 372,\n            y: checkboxY + 2,\n            size: 8,\n            font: font,\n            color: rgb(0, 0, 0)\n          });\n        }\n\n        checkboxY -= 15; // Ajuster l'espacement entre les lignes\n      }); // Capture d‚Äô√©cran des v√©hicules avec les croix\n\n      yield this.captureVehicleImage(page, pdfDoc);\n      yield new Promise(resolve => setTimeout(resolve, 500));\n      yield this.captureCroquiImage(page, pdfDoc);\n      yield new Promise(resolve => setTimeout(resolve, 500));\n      const croquiY = vehiculeY - 628; // Ajustez selon la disposition souhait√©e\n\n      yield this.addCroquiInfo(page, font, pdfDoc, 'A', 80, croquiY);\n      yield this.addCroquiInfo(page, font, pdfDoc, 'B', 280, croquiY);\n      const sinistreData = {\n        date_survenance: this.accidentForm.value.date,\n        date_declaration: new Date().toISOString().split('T')[0],\n        num_police: this.accidentForm.value.contractNumberA,\n        objet_assure: this.accidentForm.value.vehicleBrandA,\n        description: this.accidentForm.value.observationsA,\n        documents: null\n      };\n      this.sinistreService.addSinistre(sinistreData).subscribe(response => {\n        console.log('Sinistre cr√©√© avec succ√®s', response); // Mapper la r√©ponse API √† une instance de Sinistre\n\n        const sinistre = this.mapApiResponseToSinistre(response); // Utiliser les getters pour acc√©der aux valeurs\n\n        const reference = sinistre.Reference;\n        Swal.fire({\n          icon: 'success',\n          title: 'Votre constat a √©t√© t√©l√©charg√© avec succ√®s',\n          html: `A partir de la date d'aujourd'hui, vous avez 5 jours pour d√©poser votre constat.<br><br>\n                     <strong>R√©f√©rence sinistre : ${reference}</strong><br>\n                     Conservez cette r√©f√©rence pour ajouter des documents ult√©rieurement.`\n        });\n      }, error => {\n        console.error('Erreur lors de la cr√©ation du sinistre', error);\n      }); // G√©n√©rer et t√©l√©charger le PDF\n\n      const pdfBytes = yield pdfDoc.save();\n      const blob = new Blob([pdfBytes], {\n        type: 'application/pdf'\n      });\n      const link = document.createElement('a');\n      link.href = window.URL.createObjectURL(blob);\n      const {\n        insuredNameA,\n        insuredFirstNameA\n      } = this.accidentForm.value;\n      const fileName = `constat-accident-${insuredNameA} ${insuredFirstNameA}.pdf`;\n      link.download = fileName;\n      link.click();\n    });\n  }\n\n  drawTable(page, font, headers, values, startX, startY, cellWidth, cellHeight) {\n    const rowCount = headers.length;\n\n    for (let i = 0; i < rowCount; i++) {\n      const x = startX + i % 4 * cellWidth; // 4 colonnes max\n\n      const y = startY - Math.floor(i / 4) * cellHeight; // Nouvelle ligne toutes les 4 colonnes\n      // Dessiner la cellule\n\n      page.drawRectangle({\n        x: x,\n        y: y,\n        width: cellWidth,\n        height: cellHeight,\n        borderWidth: 1,\n        color: rgb(0.9, 0.9, 0.9) // Fond gris clair\n\n      }); // Ajouter le texte de l'en-t√™te\n\n      page.drawText(headers[i], {\n        x: x + 5,\n        y: y + cellHeight - 15,\n        size: 10,\n        font: font,\n        color: rgb(0, 0, 0)\n      }); // Ajouter la valeur correspondante\n\n      page.drawText(values[i], {\n        x: x + 5,\n        y: y + 5,\n        size: 10,\n        font: font,\n        color: rgb(0, 0, 0)\n      });\n    }\n  }\n\n  addCommonInfo(page, font) {\n    return __awaiter(this, void 0, void 0, function* () {\n      // Ajouter des champs de texte pour chaque section\n      this.addTextField(page, 'Date: ', 50, 700, 100, 30, this.accidentForm.value.date, font);\n      this.addTextField(page, 'Heure: ', 160, 700, 100, 30, this.accidentForm.value.time, font);\n      this.addTextField(page, 'Lieu: ', 270, 700, 100, 30, this.accidentForm.value.location, font);\n      this.addTextField(page, 'Bless√©: ', 380, 700, 100, 30, this.accidentForm.value.blesse, font);\n      let currentY = 270; // Position de d√©part\n\n      this.addTextField(page, 'D√©g√¢ts mat√©riels: ', 50, currentY, 150, 30, this.accidentForm.value.otherDamages, font);\n      currentY -= 30;\n      this.addTextField(page, 'Nom du t√©moin: ', 50, currentY, 150, 30, this.accidentForm.value.witnessName, font);\n      currentY -= 30;\n      this.addTextField(page, 'Adresse du t√©moin: ', 50, currentY, 150, 30, this.accidentForm.value.witnessAddress, font);\n      currentY -= 30;\n      this.addTextField(page, 'T√©l√©phone du t√©moin: ', 50, currentY, 150, 30, this.accidentForm.value.witnessPhone, font);\n      currentY -= 30; // R√©duire l'espace avant de passer aux informations des v√©hicules\n\n      return currentY; // Retourne la position Y apr√®s avoir ajout√© les informations communes\n    });\n  }\n\n  addVehicleInfo(page, font, pdfDoc, vehicleType, x, y) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const color = vehicleType === 'A' ? this.convertRGB(253, 252, 232) : this.convertRGB(224, 251, 238);\n      const xOffset = vehicleType === 'A' ? -70 : 90;\n      let currentY = y; // Position de d√©part pour le v√©hicule\n\n      const boldFont = yield pdfDoc.embedFont(StandardFonts.HelveticaBold); // Informations sur la soci√©t√© d'assurance\n\n      this.addStyledBox(page, `Soci√©t√© d'Assurances`, x + xOffset, currentY, 250, 30, '', boldFont, color);\n      currentY -= 21;\n      this.addStyledBox(page, `V√©hicule assur√© par  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`insuranceCompany${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Contrat d'Assurance  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`contractNumber${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Agence Assurance  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`agency${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Validit√© Assurance (D√©but)  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`validFrom${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Validit√© Assurance (Fin)  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`validTo${vehicleType}`], font, color); // Informations sur l'identit√© du conducteur\n\n      currentY -= 21;\n      this.addStyledBox(page, `Identit√©     `, x + xOffset, currentY, 250, 30, '', boldFont, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Nom    : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`driverName${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Pr√©nom    : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`driverFirstName${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Adresse    : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`driverAddress${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Num√©ro Permis de Conduire  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`driverLicenseNumber${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `D√©livr√© le  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`driverLicenseIssuedDate${vehicleType}`], font, color); // Informations sur l'assur√©\n\n      currentY -= 21;\n      this.addStyledBox(page, `Assur√©   `, x + xOffset, currentY, 250, 30, '', boldFont, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Nom de l'Assur√©  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`insuredName${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Pr√©nom de l'Assur√©  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`insuredFirstName${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Adresse de l'Assur√©  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`insuredAddress${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `T√©l√©phone de l'Assur√©  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`insuredPhone${vehicleType}`], font, color); // Informations sur le v√©hicule\n\n      currentY -= 21;\n      this.addStyledBox(page, `Identit√© du v√©hicule   `, x + xOffset, currentY, 250, 30, '', boldFont, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Marque et type du  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`vehicleBrand${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Immatriculation  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`vehicleRegistration${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Sens suivi   `, x + xOffset, currentY, 250, 30, '', boldFont, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Venant de  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`venant${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Allant √†  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`allant${vehicleType}`], font, color);\n      return currentY; // Retourne la position Y apr√®s avoir ajout√© toutes les informations sur le v√©hicule\n    });\n  }\n\n  addCroquiInfo(page, font, pdfDoc, vehicleType, x, y) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const color = vehicleType === 'A' ? this.convertRGB(253, 252, 232) : this.convertRGB(224, 251, 238);\n      const xOffset = vehicleType === 'A' ? -70 : 90;\n      let currentY = y; // Position de d√©part pour le v√©hicule\n\n      const boldFont = yield pdfDoc.embedFont(StandardFonts.HelveticaBold);\n      console.log(\"currentY addCroquiInfo : \", currentY);\n      this.addStyledBox(page, `D√©gats Apparents  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`degatsApparents${vehicleType}`], font, color);\n      currentY -= 21;\n      this.addStyledBox(page, `Observations  : `, x + xOffset, currentY, 250, 30, this.accidentForm.value[`observations${vehicleType}`], font, color);\n      return currentY; // Retourne la position Y apr√®s avoir ajout√© toutes les informations sur le v√©hicule\n    });\n  } // Fonction pour ajouter un champ de texte simple dans le PDF\n\n\n  addTextField(page, label, x, y, width, height, value, font) {\n    // Afficher le label et la valeur dans le m√™me champ\n    page.drawText(`${label} ${value}`, {\n      x: x,\n      y: y + 10,\n      size: 12,\n      font: font,\n      color: rgb(0, 0, 0)\n    });\n  } // Fonction pour ajouter un champ de texte stylis√© (avec fond color√© et ombre)\n\n\n  addStyledBox(page, label, x, y, width, height, value, font, color) {\n    // Fond color√© avec bordure\n    page.drawRectangle({\n      x: x,\n      y: y,\n      width: 220,\n      height: height,\n      color: color,\n      // borderWidth: 1,\n      borderColor: rgb(0, 0, 0) // Ajout d'une bordure noire pour mieux visualiser\n\n    }); // Ajustement du texte pour √©viter qu'il d√©passe\n\n    const text = `${label} ${value}`;\n    const textWidth = font.widthOfTextAtSize(text, 10); // Calculer la largeur du texte avec une police r√©duite\n\n    const maxTextWidth = 220 - 10; // R√©duire pour ne pas toucher les bords du rectangle\n\n    let displayText = text;\n\n    if (textWidth > maxTextWidth) {\n      displayText = text.slice(0, 30) + \"...\"; // Tronquer le texte s'il d√©passe la bo√Æte\n    } // Affichage du texte avec un l√©ger d√©calage pour centrer\n\n\n    page.drawText(displayText, {\n      x: x + 5,\n      y: y + height / 2 - 5,\n      size: 10,\n      font: font // color: rgb(0, 0, 0)\n\n    });\n  }\n\n  captureVehicleImage(page, pdfDoc) {\n    return __awaiter(this, void 0, void 0, function* () {\n      // S√©lection des containers de v√©hicules A et B\n      const vehicleAContainers = document.querySelectorAll('.vehiclesA-container .car-container, .vehiclesA-container .moto-container');\n      const vehicleBContainers = document.querySelectorAll('.vehiclesB-container .car-containerB, .vehiclesB-container .moto-containerB');\n\n      function captureAndDrawImage(container, x, y) {\n        return __awaiter(this, void 0, void 0, function* () {\n          const crosses = container.querySelectorAll('.cross');\n\n          if (crosses.length === 0) {\n            console.warn(`‚ö†Ô∏è Aucune croix trouv√©e dans ${container.className}, capture ignor√©e.`);\n            return;\n          }\n\n          try {\n            console.log(`üì∏ Capture en cours pour: ${container.className} avec ${crosses.length} croix.`);\n            yield new Promise(resolve => setTimeout(resolve, 1000)); // Augmenter le d√©lai si n√©cessaire\n\n            const canvas = yield html2canvas(container, {\n              backgroundColor: null\n            });\n            const imgData = canvas.toDataURL('image/png'); // Ajout de l'image au PDF avec les coordonn√©es dynamiques\n\n            const img = yield pdfDoc.embedPng(imgData);\n            const {\n              width,\n              height\n            } = img.scale(0.5); // Ajouter l'image avec les coordonn√©es dynamiques\n\n            page.drawImage(img, {\n              x,\n              y,\n              width,\n              height\n            });\n            console.log(`‚úÖ Image ajout√©e aux coordonn√©es x: ${x}, y: ${y}`);\n          } catch (error) {\n            console.error(\"‚ùå Erreur lors de la capture d'√©cran:\", error);\n          }\n        });\n      } // Capture et ajout des images pour les containers A\n\n\n      for (const container of Array.from(vehicleAContainers)) {\n        yield captureAndDrawImage(container, 58, 24); // Coordonn√©es pour A\n      } // Capture et ajout des images pour les containers B\n\n\n      for (const container of Array.from(vehicleBContainers)) {\n        yield captureAndDrawImage(container, 420, 24); // Coordonn√©es pour B\n      }\n    });\n  }\n\n  wrapText(text, maxWidth, font, fontSize) {\n    const words = text.split(' ');\n    let lines = [];\n    let currentLine = '';\n    words.forEach(word => {\n      const width = font.widthOfTextAtSize(currentLine + ' ' + word, fontSize);\n\n      if (width > maxWidth && currentLine !== '') {\n        lines.push(currentLine);\n        currentLine = word;\n      } else {\n        currentLine += (currentLine === '' ? '' : ' ') + word;\n      }\n    });\n\n    if (currentLine) {\n      lines.push(currentLine);\n    }\n\n    return lines;\n  }\n\n  dateValidator(form) {\n    var _a, _b, _c, _d, _e;\n\n    const date = new Date((_a = form.get('date')) === null || _a === void 0 ? void 0 : _a.value);\n    const validFromA = new Date((_b = form.get('validFromA')) === null || _b === void 0 ? void 0 : _b.value);\n    const validToA = new Date((_c = form.get('validToA')) === null || _c === void 0 ? void 0 : _c.value);\n    const validFromB = new Date((_d = form.get('validFromB')) === null || _d === void 0 ? void 0 : _d.value);\n    const validToB = new Date((_e = form.get('validToB')) === null || _e === void 0 ? void 0 : _e.value);\n\n    if (!date || !validFromA || !validToA || !validFromB || !validToB) {\n      return null; // Si une date est manquante, on ne fait pas la validation\n    }\n\n    const isValid = date >= validFromA && date <= validToA && date >= validFromB && date <= validToB;\n    return isValid ? null : {\n      invalidDateRange: true\n    };\n  }\n\n  onDragStart(event) {\n    console.log(\"Drag started:\", event);\n    this.draggedElement = event.source.data;\n  }\n\n  onDrop(event) {\n    var _a;\n\n    console.log(\"‚úÖ onDrop d√©clench√© !\", event);\n\n    if (!event.item || !event.item.data) {\n      console.warn(\"‚ö†Ô∏è Aucune donn√©e trouv√©e dans l'√©l√©ment drag & drop !\");\n      return;\n    }\n\n    const dropZone = document.querySelector('.elements-panel');\n    const dropRect = dropZone.getBoundingClientRect();\n    const draggedElement = event.item.element.nativeElement;\n    const elementRect = draggedElement.getBoundingClientRect(); // R√©cup√®re les dimensions de l'image\n\n    const mouseEvent = event.event;\n    const x = mouseEvent.clientX - dropRect.left - elementRect.width / 2;\n    const y = mouseEvent.clientY - dropRect.top - elementRect.height / 2;\n    const droppedData = event.item.data; // V√©rifier si l'image existe d√©j√† dans droppedElements\n\n    const existingItemIndex = this.droppedElements.findIndex(el => el.name === droppedData.name);\n\n    if (existingItemIndex !== -1) {\n      // Mettre √† jour les coordonn√©es en conservant la rotation\n      this.droppedElements[existingItemIndex] = Object.assign(Object.assign({}, this.droppedElements[existingItemIndex]), {\n        x,\n        y\n      });\n    } else {\n      // Ajouter l'√©l√©ment avec la position centr√©e\n      this.droppedElements.push(Object.assign(Object.assign({}, droppedData), {\n        x,\n        y,\n        rotation: (_a = droppedData.rotation) !== null && _a !== void 0 ? _a : 0,\n        position: 'absolute'\n      }));\n    }\n\n    console.log(\"üìå √âl√©ments apr√®s ajout ou mise √† jour :\", this.droppedElements);\n  }\n\n  onDragMoved(event) {\n    const {\n      x,\n      y\n    } = event.pointerPosition;\n    this.dragPosition = {\n      x,\n      y\n    }; // Mettez √† jour la position en temps r√©el\n\n    console.log('D√©placement en cours:', this.dragPosition);\n  }\n\n  onDragReleased(event) {\n    console.log('√âl√©ment rel√¢ch√©:', event);\n    const draggedElement = event.source.element.nativeElement;\n    const parentElement = draggedElement.parentElement;\n    if (!parentElement) return;\n    const parentRect = parentElement.getBoundingClientRect();\n    const elementRect = draggedElement.getBoundingClientRect();\n    const newX = elementRect.left - parentRect.left + elementRect.width / 2;\n    const newY = elementRect.top - parentRect.top + elementRect.height / 2;\n    const item = this.droppedElements.find(el => el === this.draggedElement);\n\n    if (item) {\n      item.x = newX;\n      item.y = newY;\n    }\n\n    console.log(\"üìå Nouvelle position apr√®s rel√¢chement :\", {\n      x: newX,\n      y: newY\n    }); // D√©clencher la d√©tection des changements\n\n    this.cdr.detectChanges();\n  }\n\n  rotateLeft(item) {\n    console.log(\"Avant rotation\"); // Log de l'√©tat du formulaire avant la rotation\n\n    item.rotation -= 90; // Rotation de 90¬∞ √† gauche\n\n    console.log(\"Apr√®s rotation\"); // Log de l'√©tat du formulaire apr√®s la rotation\n  }\n\n  removeItem(item) {\n    const index = this.droppedElements.indexOf(item);\n\n    if (index > -1) {\n      this.droppedElements.splice(index, 1); // Suppression de l'√©l√©ment de la zone de d√©p√¥t\n    }\n  }\n\n  trackByFn(index, item) {\n    return item.id; // Assurez-vous que chaque √©l√©ment a un identifiant unique\n  }\n\n  captureCroquiImage(page, pdfDoc) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const Croqui = document.querySelectorAll('.elements-panel');\n\n      function captureAndDrawImage(container, x, y) {\n        return __awaiter(this, void 0, void 0, function* () {\n          try {\n            console.log(`üì∏ D√©but de capture pour: ${container.className}`); // Capture de l'image avec html2canvas\n\n            const canvas = yield html2canvas(container, {\n              scale: 1,\n              backgroundColor: null,\n              useCORS: true,\n              logging: true\n            }); // R√©cup√©ration des donn√©es de l'image en PNG\n\n            const imgData = canvas.toDataURL('image/png', 1);\n            const img = yield pdfDoc.embedPng(imgData); // Largeur et Hauteur cibles\n\n            const targetWidth = 225; // Largeur cible\n\n            const targetHeight = 100; // Hauteur cible\n            // Calcul des facteurs de mise √† l'√©chelle pour largeur et hauteur\n\n            const widthScale = targetWidth / img.width;\n            const heightScale = targetHeight / img.height; // Appliquer les √©chelles respectives\n\n            const width = img.width * widthScale;\n            const height = img.height * heightScale; // Calculer la position X pour centrer l'image sur la page (600px est la largeur de la page)\n            // Placer l'image sur la page, plus haut avec y ajust√©\n\n            page.drawImage(img, {\n              x: 190,\n              y: 70,\n              width,\n              height\n            });\n          } catch (error) {\n            console.error(\"‚ùå Erreur d√©taill√©e lors de la capture:\", error);\n          }\n        });\n      } // Capture et dessin de toutes les images des √©l√©ments trouv√©s\n\n\n      for (const container of Array.from(Croqui)) {\n        yield captureAndDrawImage(container, 10, 25);\n      }\n    });\n  }\n\n  mapApiResponseToSinistre(data) {\n    return new Sinistre(data._id, data.date_survenance, data.date_declaration, data.num_police, data.objet_assure, data.description, data.status, data.reference, data.documents || null);\n  }\n\n  containsCommaValidator(control) {\n    const value = control.value;\n\n    if (value && !value.includes(',')) {\n      return {\n        missingComma: true\n      };\n    }\n\n    return null;\n  }\n\n  get vehicleBrandB() {\n    return this.accidentForm.get('vehicleBrandB');\n  }\n\n  get vehicleBrandA() {\n    return this.accidentForm.get('vehicleBrandA');\n  }\n\n};\nConstatComponent = __decorate([Component({\n  selector: 'app-constat',\n  templateUrl: './constat.component.html',\n  styleUrls: ['./constat.component.scss']\n})], ConstatComponent);\nexport { ConstatComponent };","map":null,"metadata":{},"sourceType":"module"}