{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component, EventEmitter, Input, Output } from '@angular/core';\nimport { SousFormationKeejob } from 'src/app/models/sous-formation-keejob';\nimport { Partenaire } from 'src/app/models/partenaire';\nimport Swal from 'sweetalert2';\nlet SousFormationKeejobComponent = class SousFormationKeejobComponent {\n  constructor(partenaireservice, sousFormationKeejobService, cdr, authService, router) {\n    this.partenaireservice = partenaireservice;\n    this.sousFormationKeejobService = sousFormationKeejobService;\n    this.cdr = cdr;\n    this.authService = authService;\n    this.router = router;\n    this.sousFormationSelected = new EventEmitter();\n    this.sidebarOpen = true;\n    this.sousFormationKeejob = [];\n    this.partenaires = [];\n    this.selectedPartenaires = [];\n    this.loading = false; // currentPage = 1;\n\n    this.itemsPerPage = 5;\n    this.showModal = false;\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      formationKeejobId: null,\n      sousFormationPartenaires: []\n    };\n    this.editId = null;\n    this.selectedImage = null;\n  }\n\n  ngOnInit() {\n    console.log('üöÄ SousFormationKeejob - Initialisation');\n    console.log('üìå formationId re√ßu:', this.formationId);\n    this.fetchsousFormationKeejob();\n    this.fetchPartenaires();\n  }\n\n  fetchsousFormationKeejob() {\n    this.loading = true;\n    console.log('üì° R√©cup√©ration des sous-formations...');\n    this.sousFormationKeejobService.getSousFormationKeejob().subscribe(response => {\n      console.log('‚úÖ R√©ponse brute:', response); // Filtrer par formationId si fourni\n\n      let filteredResponse = response;\n\n      if (this.formationId) {\n        filteredResponse = response.filter(sf => sf.formationKeejob && sf.formationKeejob.id === this.formationId);\n        console.log('üîç Sous-formations filtr√©es:', filteredResponse);\n      }\n\n      this.sousFormationKeejob = filteredResponse.map(f => new SousFormationKeejob(f.id, f.title, f.description, f.image, f.sousFormationPartenaires || [], f.formationKeejob, f.sousFormationLogiciel || []));\n      this.loading = false;\n      console.log('‚úÖ Sous-formations mapp√©es:', this.sousFormationKeejob);\n    }, error => {\n      console.error('‚ùå Erreur chargement:', error);\n      this.loading = false;\n      Swal.fire({\n        icon: 'error',\n        title: 'Erreur lors du chargement',\n        showConfirmButton: false,\n        timer: 1500\n      });\n    });\n  }\n\n  fetchPartenaires() {\n    this.partenaireservice.getPartenaire().subscribe(response => {\n      this.partenaires = response.map(p => new Partenaire(p.id, p.title, p.description, p.image));\n      console.log('‚úÖ Partenaires charg√©s:', this.partenaires.length);\n    }, error => {\n      console.error('‚ùå Erreur partenaires:', error);\n    });\n  } // get currentItems(): SousFormationKeejob[] {\n  //   const indexOfLastItem = this.currentPage * this.itemsPerPage;\n  //   const indexOfFirstItem = indexOfLastItem - this.itemsPerPage;\n  //   return this.sousFormationKeejob.slice(indexOfFirstItem, indexOfLastItem);\n  // }\n\n\n  get totalPages() {\n    return Math.ceil(this.sousFormationKeejob.length / this.itemsPerPage);\n  }\n\n  get pagesArray() {\n    return Array(this.totalPages).fill(0).map((_, i) => i + 1);\n  } // handlePageChange(pageNumber: number) {\n  //   this.currentPage = pageNumber;\n  // }\n\n\n  handleAdd() {\n    this.modalMode = 'add';\n    this.formData = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      formationKeejobId: this.formationId,\n      sousFormationPartenaires: []\n    };\n    this.selectedPartenaires = [];\n    this.selectedImage = null;\n    this.showModal = true;\n  }\n\n  handleEdit(sousFormation) {\n    var _a;\n\n    this.modalMode = 'edit';\n    this.formData = {\n      id: sousFormation.Id,\n      title: sousFormation.Title,\n      description: sousFormation.Description,\n      image: sousFormation.Image,\n      formationKeejobId: ((_a = sousFormation.FormationKeejob) === null || _a === void 0 ? void 0 : _a.Id) || this.formationId,\n      sousFormationPartenaires: sousFormation.Partenaires || []\n    };\n    this.editId = sousFormation.Id;\n    this.showModal = true;\n  }\n\n  handleDelete(id) {\n    Swal.fire({\n      title: '√ätes-vous s√ªr?',\n      text: \"Cette action est irr√©versible!\",\n      icon: 'warning',\n      showCancelButton: true,\n      confirmButtonColor: '#3085d6',\n      cancelButtonColor: '#d33',\n      confirmButtonText: 'Oui, supprimer!',\n      cancelButtonText: 'Annuler'\n    }).then(result => {\n      if (result.isConfirmed) {\n        this.sousFormationKeejobService.deleteSousFormationKeejob(id).subscribe(() => {\n          this.sousFormationKeejob = this.sousFormationKeejob.filter(item => item.Id !== id);\n          Swal.fire({\n            title: 'Supprim√©!',\n            text: 'Sous-formation supprim√©e avec succ√®s',\n            icon: 'success',\n            timer: 1500,\n            showConfirmButton: false\n          });\n        }, error => {\n          console.error('Erreur suppression:', error);\n          Swal.fire({\n            icon: 'error',\n            title: 'Erreur lors de la suppression',\n            timer: 1500\n          });\n        });\n      }\n    });\n  }\n\n  handleSubmit() {\n    if (!this.formData.title || !this.formData.description) {\n      Swal.fire({\n        icon: 'warning',\n        title: 'Attention',\n        text: 'Veuillez remplir tous les champs obligatoires',\n        timer: 2000\n      });\n      return;\n    }\n\n    const formData = new FormData();\n    formData.append('title', this.formData.title);\n    formData.append('description', this.formData.description);\n\n    if (this.formationId) {\n      formData.append('formationKeejobId', this.formationId.toString());\n    }\n\n    if (this.selectedImage) {\n      formData.append('image', this.selectedImage, this.selectedImage.name);\n    }\n\n    if (this.selectedPartenaires.length > 0) {\n      this.selectedPartenaires.forEach(p => {\n        formData.append(\"partenairesIds\", p.id.toString());\n      });\n    }\n\n    const afterSuccess = response => {\n      Swal.fire({\n        title: 'Succ√®s!',\n        text: this.modalMode === 'add' ? 'Sous-formation ajout√©e avec succ√®s' : 'Sous-formation modifi√©e avec succ√®s',\n        icon: 'success',\n        timer: 1500,\n        showConfirmButton: false\n      });\n      this.closeModal();\n      this.fetchsousFormationKeejob(); // ‚úÖ √âmettre la sous-formation ajout√©e pour passer automatiquement au Step 3\n\n      if (this.modalMode === 'add') {\n        this.sousFormationSelected.emit(response); // <-- IMPORTANT\n      }\n    };\n\n    if (this.modalMode === 'add') {\n      this.sousFormationKeejobService.addSousFormationKeejob(formData).subscribe(afterSuccess, error => {\n        console.error('Erreur ajout:', error);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur lors de l\\'ajout',\n          timer: 1500\n        });\n      });\n    } else {\n      this.sousFormationKeejobService.putSousFormationKeejob(this.editId, formData).subscribe(afterSuccess, error => {\n        console.error('Erreur modification:', error);\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur lors de la modification',\n          timer: 1500\n        });\n      });\n    }\n  }\n\n  closeModal() {\n    this.showModal = false;\n    this.formData = {\n      id: null,\n      title: '',\n      description: '',\n      image: '',\n      formationKeejobId: null,\n      sousFormationPartenaires: []\n    };\n    this.selectedPartenaires = [];\n    this.selectedImage = null;\n  }\n\n  onImageSelected(event) {\n    const file = event.target.files[0];\n\n    if (file) {\n      if (!file.type.startsWith('image/')) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'Veuillez s√©lectionner une image valide',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      if (file.size > 5 * 1024 * 1024) {\n        Swal.fire({\n          icon: 'error',\n          title: 'Erreur',\n          text: 'L\\'image ne doit pas d√©passer 5MB',\n          timer: 1500,\n          showConfirmButton: false\n        });\n        return;\n      }\n\n      this.selectedImage = file;\n    }\n  }\n\n  sanitizeImage(url) {\n    if (!url) return '';\n\n    if (url.includes(\"https://res.cloudinary.com\") && url.split(\"https://res.cloudinary.com\").length > 2) {\n      const parts = url.split(\"https://res.cloudinary.com/daxkymr4t/image/upload/\");\n      return \"https://res.cloudinary.com/daxkymr4t/image/upload/\" + parts[parts.length - 1];\n    }\n\n    return url;\n  }\n\n  togglePartenaire(p) {\n    const index = this.selectedPartenaires.findIndex(x => x.id === p.Id);\n\n    if (index >= 0) {\n      this.selectedPartenaires.splice(index, 1);\n    } else {\n      this.selectedPartenaires.push({\n        id: p.Id,\n        title: p.Name,\n        image: p.Image\n      });\n    }\n  }\n\n  isSelected(p) {\n    return this.selectedPartenaires.some(x => x.id === p.Id);\n  }\n\n  editSousFormationFromParent(sf) {\n    var _a;\n\n    this.modalMode = 'edit';\n    this.formData = {\n      id: sf.Id,\n      title: sf.Title,\n      description: sf.Description,\n      image: sf.Image,\n      formationKeejobId: (_a = sf.FormationKeejob) === null || _a === void 0 ? void 0 : _a.Id,\n      sousFormationPartenaires: sf.Partenaires || []\n    };\n    this.showModal = true;\n    this.cdr.detectChanges(); // Forcer la d√©tection des changements\n  }\n\n};\n\n__decorate([Input()], SousFormationKeejobComponent.prototype, \"formationId\", void 0);\n\n__decorate([Output()], SousFormationKeejobComponent.prototype, \"sousFormationSelected\", void 0);\n\nSousFormationKeejobComponent = __decorate([Component({\n  selector: 'app-sous-formation-keejob',\n  templateUrl: './sous-formation-keejob.component.html',\n  styleUrls: ['./sous-formation-keejob.component.css']\n})], SousFormationKeejobComponent);\nexport { SousFormationKeejobComponent };","map":null,"metadata":{},"sourceType":"module"}