{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { MessageService } from 'primeng/api';\nimport { PersonnePhysique } from 'src/app/components/models/personne-physique';\nimport { PersonneMorale } from 'src/app/components/models/personne-morale';\nimport { Expert } from 'src/app/components/models/expert';\nlet ProfilComponent = class ProfilComponent {\n  constructor(userService, messageService, expertService, changeDetectorRef) {\n    this.userService = userService;\n    this.messageService = messageService;\n    this.expertService = expertService;\n    this.changeDetectorRef = changeDetectorRef;\n    this.uploadedFiles = [];\n    this.form = {};\n    this.clientId = null;\n    this.messages = [];\n  }\n\n  ngOnInit() {\n    this.clientId = this.getUserId();\n    const userRole = this.getUserRole(); // Récupérer le rôle\n\n    console.log(\"userRole:\", userRole);\n\n    if (this.clientId) {\n      if (userRole === 'expert') {\n        console.log('Calling getExpertById with ID:', this.clientId);\n        this.expertService.getExpertById(this.clientId).subscribe({\n          next: data => {\n            console.log('API Response (Expert):', data);\n            this.expert = this.mapExpertToModel(data);\n            console.log('Mapped expert object:', this.expert);\n            this.fillFormWithUserData();\n          },\n          error: err => {\n            console.error('Error fetching expert profile:', err);\n            this.messageService.add({\n              severity: 'error',\n              summary: 'Erreur',\n              detail: 'Impossible de charger le profil de l\\'expert'\n            });\n          }\n        });\n      } else {\n        // Sinon, utiliser getUserProfile\n        this.userService.getUserProfile(this.clientId).subscribe({\n          next: data => {\n            console.log('API Response (Client):', data);\n            this.client = this.mapApiResponseToModel(data);\n            this.fillFormWithUserData();\n          },\n          error: err => {\n            console.error('Error fetching user profile:', err);\n            this.messageService.add({\n              severity: 'error',\n              summary: 'Erreur',\n              detail: 'Impossible de charger le profil utilisateur'\n            });\n          }\n        });\n      }\n    }\n  }\n\n  mapApiResponseToModel(data) {\n    const userRole = this.getUserRole();\n\n    if (userRole === 'PersonneMorale') {\n      return new PersonneMorale(data._id, data.email, '', data.image || '', data.phoneNumber, data.adresse, data.raisonSociale, data.activite, data.matricule_fiscal, 'PersonneMorale');\n    } else {\n      return new PersonnePhysique(data._id, data.email, '', data.image || '', data.phoneNumber, data.adresse, data.nom, data.prenom, data.birthDate, data.numeroPermis, data.identifiant_national, data.CIN_Pass, data.sex, data.nationalite, data.profession, 'PersonnePhysique');\n    }\n  }\n\n  mapExpertToModel(data) {\n    const expert = new Expert(data._id, data.email, \"\", data.image || '', data.phoneNumber, data.region, data.taux, data.nom, data.prenom);\n    console.log('Mapped expert data:', expert);\n    return expert;\n  }\n\n  fillFormWithUserData() {\n    console.log('Current client data:', this.client);\n    console.log('Current expert data:', this.expert); // Initialize form with empty values\n\n    this.form = {\n      email: '',\n      phoneNumber: '',\n      image: '',\n      nom: '',\n      prenom: '',\n      region: '',\n      taux: 0\n    };\n    const userRole = this.getUserRole();\n    console.log('User Role:', userRole);\n\n    if (userRole === 'expert' && this.expert) {\n      console.log('Filling form with expert data:', this.expert); // Debug logging to see which properties are accessible\n\n      console.log('Expert email direct:', this.expert.Email);\n      console.log('Expert email getter:', this.expert.Email); // Try both property access methods\n\n      this.form = {\n        email: this.expert.Email,\n        nom: this.expert.Nom,\n        prenom: this.expert.Prenom,\n        phoneNumber: this.expert.PhoneNumber,\n        taux: this.expert.Taux,\n        region: this.expert.Region,\n        image: this.expert.Image\n      };\n    } else if (this.client) {\n      // Common fields for client\n      this.form = {\n        email: this.client.Email,\n        phoneNumber: this.client.PhoneNumber,\n        adresse: this.client.Adresse,\n        image: this.client.Image\n      };\n\n      if (userRole === 'PersonnePhysique') {\n        const physique = this.client;\n        Object.assign(this.form, {\n          nom: physique.Nom,\n          prenom: physique.Prenom,\n          birthDate: physique.BirthDate,\n          numeroPermis: physique.NumeroPermis,\n          identifiant_national: physique.IdentifiantNational,\n          CIN_Pass: physique.CINPass,\n          sex: physique.Sex,\n          nationalite: physique.Nationalite,\n          profession: physique.Profession\n        });\n      } else if (userRole === 'PersonneMorale') {\n        const morale = this.client;\n        Object.assign(this.form, {\n          raisonSociale: morale.RaisonSociale,\n          activite: morale.Activite,\n          matricule_fiscal: morale.MatriculeFiscal\n        });\n      }\n    }\n\n    console.log('Form data after filling:', this.form);\n    this.changeDetectorRef.detectChanges();\n  }\n\n  onSubmit() {\n    console.log('Form data being submitted:', this.form);\n\n    if (this.clientId) {\n      const formData = new FormData();\n      Object.keys(this.form).forEach(key => {\n        if (key !== 'image' && this.form[key] !== undefined && this.form[key] !== null) {\n          formData.append(key, this.form[key]);\n        }\n      });\n\n      if (this.uploadedFiles && this.uploadedFiles.length > 0) {\n        formData.append('image', this.uploadedFiles[0]);\n      }\n\n      const userRole = this.getUserRole();\n\n      if (userRole === 'expert') {\n        // Use expert service for experts\n        this.expertService.putExpert(this.clientId, formData).subscribe({\n          next: updatedExpert => {\n            console.log('Updated expert data:', updatedExpert);\n            this.messageService.add({\n              severity: 'success',\n              summary: 'Succès',\n              detail: 'Profil expert mis à jour avec succès',\n              life: 3000\n            });\n            this.expert = this.mapExpertToModel(updatedExpert);\n            this.fillFormWithUserData();\n          },\n          error: error => {\n            console.error('Error updating expert profile:', error);\n            this.messageService.add({\n              severity: 'error',\n              summary: 'Error',\n              detail: 'Profil expert n\\'est pas mis à jour',\n              life: 3000\n            });\n          }\n        });\n      } else {\n        // Use user service for clients\n        this.userService.updateUserProfile(this.clientId, formData).subscribe({\n          next: updatedUser => {\n            console.log('Updated user data:', updatedUser);\n            this.messageService.add({\n              severity: 'success',\n              summary: 'Succès',\n              detail: 'Profil utilisateur mis à jour avec succès',\n              life: 3000\n            });\n            this.client = this.mapApiResponseToModel(updatedUser);\n            this.fillFormWithUserData();\n          },\n          error: error => {\n            console.error('Error updating profile:', error);\n            this.messageService.add({\n              severity: 'error',\n              summary: 'Error',\n              detail: 'Profil utilisateur n\\'est pas mis à jour',\n              life: 3000\n            });\n          }\n        });\n      }\n    }\n  }\n\n  getUserId() {\n    return localStorage.getItem('user_id');\n  }\n\n  getUserRole() {\n    return localStorage.getItem('userRole');\n  }\n\n  onFileSelected(event) {\n    var _a;\n\n    if ((_a = event.files) === null || _a === void 0 ? void 0 : _a[0]) {\n      this.uploadedFiles = [event.files[0]];\n    }\n  }\n\n  getImageUrl(imageName) {\n    return imageName || '/assets/default-profile.png';\n  }\n\n};\nProfilComponent = __decorate([Component({\n  providers: [MessageService],\n  selector: 'app-profil',\n  templateUrl: './profil.component.html',\n  styleUrls: ['./profil.component.scss']\n})], ProfilComponent);\nexport { ProfilComponent };","map":null,"metadata":{},"sourceType":"module"}