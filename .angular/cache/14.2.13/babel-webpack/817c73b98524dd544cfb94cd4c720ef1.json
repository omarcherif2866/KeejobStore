{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Validators } from '@angular/forms';\nimport { switchMap } from 'rxjs';\nimport { Gouvernorat } from 'src/app/components/models/agence';\nimport { Documents } from 'src/app/components/models/documents';\nlet DocumentsComponent = class DocumentsComponent {\n  constructor(fb, documentService, sinistreService, clientService, expertService, messageService, sanitizer, sharedService) {\n    this.fb = fb;\n    this.documentService = documentService;\n    this.sinistreService = sinistreService;\n    this.clientService = clientService;\n    this.expertService = expertService;\n    this.messageService = messageService;\n    this.sanitizer = sanitizer;\n    this.sharedService = sharedService;\n    this.clients = [];\n    this.experts = [];\n    this.displayPdfDialog = false;\n    this.selectedPdf = null;\n    this.displayModal = false; // Contrôle la visibilité du modal\n\n    this.documentDialog = false;\n    this.actionLabel = 'Enregistrer';\n    this.deleteDocumentsDialog = false;\n    this.documents = [];\n    this.sinistres = []; // Define the sinistres property as an array\n\n    this.selectedDocuments = [];\n    this.submitted = false;\n    this.clientInfos = {}; // Information du client à afficher\n\n    this.expertInfos = {}; // Stocke les infos par document ID\n\n    this.cols = [];\n    this.rowsPerPageOptions = [5, 10, 20];\n    this.selectedPdfName = ''; // Stocke le nom du PDF\n\n    this.selectedStatuses = {}; // Tableau pour stocker les statuts sélectionnés par commande\n\n    this.statusOptions = [{\n      label: 'En attente',\n      value: 'En attente'\n    }, {\n      label: 'Validé',\n      value: 'Validé'\n    }, {\n      label: 'Non validé',\n      value: 'Non Validé'\n    }];\n    this.displayClientDialog = false;\n    this.selectedClient = null;\n    this.displayExpertDialog = false;\n    this.selectedExpert = null;\n    this.selectedExperts = {}; // Stocke les experts sélectionnés par document\n\n    this.referenceSinistres = {};\n    this.gouvernoratOptions = []; // or fetch the sinistres from a service\n  }\n\n  ngOnInit() {\n    const userId = this.getUserId(); // Récupérer l'ID du client connecté\n\n    this.documentForm = this.fb.group({\n      client: [userId, Validators.required],\n      description: ['', Validators.required],\n      reference: ['', Validators.required],\n      gouvernorat: ['', Validators.required]\n    }); // this.accidentFormData = this.sharedService.getFormDataFromLocalStorage();\n    // console.log('Données récupérées dans DocumentsComponent:', this.accidentFormData); // Journal de débogage\n    // this.sharedService.currentFormData.subscribe(data => {\n    //   this.accidentFormData = data;\n    //   console.log('Données récupérées dans DocumentsComponent après mise à jour:', this.accidentFormData); // Journal de débogage\n    // });\n\n    this.document = new Documents('', '', '');\n    this.getAllDocuments(); // this.getClientInfo();\n    // this.loadClients();\n\n    this.getAllExperts();\n    this.getGouvernaurat();\n  }\n\n  openNew() {\n    this.document = new Documents('', '', '');\n    this.submitted = false;\n    this.documentDialog = true;\n    this.actionLabel = 'Enregistrer';\n  }\n\n  hideDialog() {\n    this.documentDialog = false;\n    this.submitted = false;\n  }\n\n  getClientInfo(clientId, docId) {\n    if (clientId) {\n      this.clientService.getUserProfile(clientId).subscribe(client => {\n        if (client.typeClient === 'PersonnePhysique') {\n          this.clientInfos[docId] = `${client.nom} ${client.prenom} ${client.phoneNumber} `;\n        } else if (client.typeClient === 'PersonneMorale') {\n          this.clientInfos[docId] = `Matricule Fiscal: ${client.matricule_fiscal}`;\n        } else {\n          this.clientInfos[docId] = 'Client inconnu';\n        }\n      }, error => {\n        console.error('Erreur lors de la récupération du client:', error);\n        this.clientInfos[docId] = 'Erreur lors du chargement du client';\n      });\n    } else {\n      console.error('Aucun ID utilisateur trouvé dans le localStorage.');\n      this.clientInfos[docId] = 'Aucun client trouvé';\n    }\n  }\n\n  getExpertInfo(expertId, docId) {\n    if (!expertId) {\n      console.error(\"Aucun ID d'expert fourni.\");\n      this.expertInfos[docId] = \"Il n'y a pas encore un expert affecté\";\n      return;\n    }\n\n    this.expertService.getExpertById(expertId).subscribe(expert => {\n      if (expert) {\n        this.expertInfos[docId] = `${expert.nom} ${expert.prenom} `;\n      } else {\n        this.expertInfos[docId] = \"Expert introuvable\";\n      }\n    }, error => {\n      this.expertInfos[docId] = \"Il n'y a pas d'expert affecté pour le moment\";\n    });\n  }\n\n  getAllDocuments() {\n    this.documentService.getAllDocuments().subscribe(data => {\n      console.log(\"Données récupérées avant mapping :\", data); // Vérification\n\n      this.documents = data.map(doc => {\n        var _a, _b, _c;\n\n        return new Documents(((_a = doc._id) === null || _a === void 0 ? void 0 : _a.$oid) || doc._id, // Extraction de l'ID du document\n        doc.doc, doc.description, doc.status, ((_b = doc.client) === null || _b === void 0 ? void 0 : _b.$oid) || doc.client, // Extraction de l'ID du client\n        ((_c = doc.expert) === null || _c === void 0 ? void 0 : _c.$oid) || doc.expert, // Extraction de l'ID de l'expert\n        doc.gouvernorat);\n      });\n      console.log(\"Documents après mapping :\", this.documents); // Vérification\n\n      this.documents.forEach(doc => {\n        this.selectedStatuses[doc.Id] = doc.Status; // Vérification et extraction correcte de l'ID de l'expert\n\n        const expertId = doc.Expert && typeof doc.Expert === 'object' ? String(doc.Expert.Id) : String(doc.Expert);\n        const clientId = doc.Client && typeof doc.Client === 'object' ? String(doc.Client.Id) : String(doc.Client);\n\n        if (clientId) {\n          this.getClientInfo(clientId, doc.Id); // Passer l'ID extrait\n        }\n\n        if (expertId) {\n          this.getExpertInfo(expertId, doc.Id); // Passer l'ID extrait\n        }\n      });\n    }, error => {\n      console.error('Erreur lors de la récupération des documents :', error);\n    });\n  }\n\n  getAllExperts() {\n    this.expertService.getExpert().subscribe(experts => {\n      this.experts = experts;\n    }, error => {\n      console.error('Erreur lors de la récupération des experts:', error);\n    });\n  }\n\n  onGlobalFilter(table, event) {\n    table.filterGlobal(event.target.value, 'contains');\n  }\n\n  onFileSelect(event) {\n    if (event.files && event.files.length > 0) {\n      this.selectedFile = event.files[0];\n    }\n  }\n\n  onSubmit() {\n    if (this.documentForm.invalid || !this.selectedFile) return;\n    const formData = new FormData();\n    formData.append('doc', this.selectedFile);\n    formData.append('client', this.documentForm.value.client);\n    formData.append('description', this.documentForm.value.description);\n    formData.append('reference', this.documentForm.value.reference);\n    formData.append('gouvernorat', this.documentForm.value.gouvernorat);\n    console.log('Référence envoyée:', this.documentForm.value.reference); // D'abord vérifier si le sinistre existe avec cette référence\n\n    this.sinistreService.getSinistreByReference(this.documentForm.value.reference).pipe(switchMap(sinistre => {\n      if (!sinistre) {\n        throw new Error('Référence sinistre invalide');\n      } // Si le sinistre existe, créer le document\n\n\n      return this.documentService.createDocument(formData).pipe(switchMap(document => {\n        // Ajouter le document au sinistre\n        sinistre.documents = document;\n        console.log('Référence du sinistre pour mise à jour:', sinistre.reference);\n        return this.sinistreService.putSinistre(sinistre.reference, sinistre);\n      }));\n    })).subscribe({\n      next: response => {\n        this.messageService.add({\n          severity: 'success',\n          summary: 'Document ajouté avec succès'\n        });\n        window.location.reload(); // this.getAllDocuments();\n      },\n      error: error => {\n        this.messageService.add({\n          severity: 'error',\n          summary: 'Erreur',\n          detail: 'Référence sinistre invalide ou erreur lors de l\\'ajout du document'\n        });\n      }\n    });\n  }\n\n  getUserId() {\n    return localStorage.getItem('user_id');\n  }\n\n  openPdf(pdfPath) {\n    this.selectedPdfName = pdfPath; // Stocke le nom du PDF\n\n    const fullPath = `http://localhost:9090/pdf/${pdfPath}`; // Remplace par ton chemin correct\n\n    this.selectedPdf = this.sanitizer.bypassSecurityTrustResourceUrl(fullPath);\n    this.displayPdfDialog = true;\n  }\n\n  affecterExpert(documentId, clientId, expertId) {\n    if (!expertId) return; // Ne rien faire si aucun expert sélectionné\n\n    this.expertService.affecterExpert(expertId, clientId, documentId).subscribe(response => {\n      console.log('Affectation réussie :', response);\n      this.messageService.add({\n        severity: 'success',\n        summary: 'Succès',\n        detail: 'Expert affecté avec succès'\n      });\n      window.location.reload();\n    }, error => {\n      console.error('Erreur lors de l\\'affectation :', error);\n      this.messageService.add({\n        severity: 'error',\n        summary: 'Erreur',\n        detail: 'Erreur lors de l\\'affectation'\n      });\n    });\n  }\n\n  onStatusChange(document, event) {\n    const newStatus = event.value;\n\n    if (!document.Id) {\n      console.error(\"Erreur : L'ID du document est manquant\");\n      return;\n    }\n\n    console.log(\"Status changé vers:\", newStatus);\n\n    if (newStatus === \"Non Validé\") {\n      console.log(\"Recherche du sinistre pour le document:\", document.Id);\n      this.sinistreService.getSinistreByDocument(document.Id).subscribe(sinistre => {\n        console.log(\"Résultat de la recherche :\", sinistre);\n\n        if (sinistre && sinistre._id) {\n          console.log(\"Sinistre trouvé, tentative de suppression:\", sinistre._id);\n          this.sinistreService.deleteSinistre(sinistre._id).subscribe( // Utilisation du getter Id\n          () => {\n            console.log(\"Sinistre supprimé avec succès\");\n            this.messageService.add({\n              severity: \"success\",\n              summary: \"Succès\",\n              detail: \"Sinistre supprimé\",\n              life: 1000\n            });\n            this.getAllDocuments();\n          }, error => {\n            console.error(\"Erreur lors de la suppression du sinistre :\", error);\n            this.messageService.add({\n              severity: \"error\",\n              summary: \"Erreur\",\n              detail: \"Erreur lors de la suppression du sinistre\"\n            });\n          });\n        } else {\n          console.log(\"Aucun sinistre trouvé pour ce document\");\n        }\n      }, error => {\n        console.error(\"Erreur lors de la récupération du sinistre :\", error);\n        this.messageService.add({\n          severity: \"error\",\n          summary: \"Erreur\",\n          detail: \"Erreur lors de la récupération du sinistre\"\n        });\n      });\n    }\n\n    this.documentService.updateDocStatus(document.Id, newStatus).subscribe(updatedDocument => {\n      console.log(\"Document mis à jour avec succès :\", updatedDocument);\n      this.messageService.add({\n        severity: \"success\",\n        summary: \"Succès\",\n        detail: \"Statut modifié\",\n        life: 1000\n      });\n      this.getAllDocuments();\n    }, error => {\n      console.error(\"Erreur lors de la mise à jour du statut du document :\", error);\n      this.messageService.add({\n        severity: \"error\",\n        summary: \"Erreur\",\n        detail: \"Erreur lors de la mise à jour du statut\"\n      });\n    });\n  }\n\n  showClientInfo(clientId) {\n    if (!clientId) {\n      console.error(\"Aucun ID client fourni.\");\n      return;\n    }\n\n    this.clientService.getUserProfile(clientId).subscribe(client => {\n      this.selectedClient = client; // Stocker les données du client\n\n      this.displayClientDialog = true; // Ouvrir le dialog\n    }, error => {\n      this.selectedClient = {\n        error: \"Erreur lors du chargement du client\"\n      };\n      this.displayClientDialog = true;\n    });\n  }\n\n  showExpertInfo(expertId) {\n    if (!expertId) {\n      console.error(\"Aucun ID Expert fourni.\");\n      return;\n    }\n\n    this.expertService.getExpertById(expertId).subscribe(expert => {\n      this.selectedExpert = expert; // Stocker les données du client\n\n      this.displayExpertDialog = true; // Ouvrir le dialog\n    }, error => {\n      this.selectedExpert = {\n        error: \"Erreur lors du chargement du client\"\n      };\n      this.displayExpertDialog = true;\n    });\n  }\n\n  getUserRole() {\n    return localStorage.getItem('userRole');\n  }\n\n  modifierReference(documentId) {\n    if (!documentId || !this.referenceSinistres[documentId]) {\n      console.error(\"ID ou référence invalide :\", documentId, this.referenceSinistres[documentId]);\n      return;\n    } // First get the sinistre ID from the document ID\n\n\n    this.sinistreService.getSinistreByDocument(documentId).subscribe(sinistre => {\n      // Use _id from the response directly, not the getter method\n      const sinistreId = sinistre._id;\n\n      if (!sinistreId) {\n        console.error(\"ID du sinistre non trouvé dans la réponse\", sinistre);\n        alert(\"Impossible de trouver l'ID du sinistre\");\n        return;\n      } // Then update the reference using the sinistre ID\n\n\n      this.sinistreService.updateReference(sinistreId, this.referenceSinistres[documentId]).subscribe(response => {\n        console.log(\"Référence mise à jour avec succès :\", response);\n        this.messageService.add({\n          severity: \"success\",\n          summary: \"Succès\",\n          detail: \"Référence Phoenix mise à jour avec succès\",\n          life: 1000\n        });\n      }, error => {\n        console.error(\"Erreur lors de la mise à jour de la référence\", error);\n        this.messageService.add({\n          severity: \"error\",\n          summary: \"Erreur\",\n          detail: \"Erreur lors de la mise à jour de la référence\"\n        });\n      });\n    }, error => {\n      console.error(\"Erreur lors de la récupération du sinistre\", error);\n      alert('Erreur lors de la récupération du sinistre');\n    });\n  }\n\n  updateSinistreReference(sinistreId, newReference) {\n    this.sinistreService.updateReference(sinistreId, newReference).subscribe({\n      next: updatedSinistre => {\n        console.log('Sinistre mis à jour :', updatedSinistre);\n        alert('Référence mise à jour avec succès');\n      },\n      error: error => {\n        console.error('Erreur lors de la mise à jour du sinistre', error);\n        alert('Erreur lors de la mise à jour');\n      }\n    });\n  }\n\n  generateOrdreMission(documentId, docName) {\n    if (!documentId) {\n      console.error('ID du document non défini');\n      return;\n    }\n\n    console.log('Génération de l\\'ordre de mission pour le document ID:', documentId);\n    this.expertService.generateOrdeMission(documentId).subscribe({\n      next: blob => {\n        if (blob.size === 0) {\n          console.error('Le fichier PDF reçu est vide');\n          return;\n        } // Vérifie que c'est un PDF\n\n\n        if (blob.type !== 'application/pdf') {\n          console.warn('Le fichier reçu n\\'est pas un PDF', blob.type);\n        }\n\n        const url = window.URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = `Ordre_de_mission-${docName}`; // ✅ ici on utilise le nom reçu\n\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        window.URL.revokeObjectURL(url);\n      },\n      error: error => {\n        console.error('Erreur lors du téléchargement du PDF:', error);\n      }\n    });\n  }\n\n  getGouvernaurat() {\n    this.gouvernoratOptions = Object.values(Gouvernorat).map(gouv => ({\n      label: gouv,\n      value: gouv // La valeur stockée dans `agence.Gouvernorat`\n\n    }));\n  }\n\n};\nDocumentsComponent = __decorate([Component({\n  selector: 'app-documents',\n  templateUrl: './documents.component.html',\n  styleUrls: ['./documents.component.scss']\n})], DocumentsComponent);\nexport { DocumentsComponent };","map":null,"metadata":{},"sourceType":"module"}