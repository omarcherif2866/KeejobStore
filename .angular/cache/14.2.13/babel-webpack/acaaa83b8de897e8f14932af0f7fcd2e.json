{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { forkJoin } from 'rxjs';\nimport { Clients } from 'src/app/components/models/clients';\nimport { DevisSinistre } from 'src/app/components/models/devis-sinistre';\nimport { Documents } from 'src/app/components/models/documents';\nimport { Expert } from 'src/app/components/models/expert';\nlet DevisSinistreComponent = class DevisSinistreComponent {\n  constructor(expertService, authservice, documentService, sanitizer, devisService) {\n    this.expertService = expertService;\n    this.authservice = authservice;\n    this.documentService = documentService;\n    this.sanitizer = sanitizer;\n    this.devisService = devisService;\n    this.displayModal = false; // Contrôle la visibilité du modal\n\n    this.selectedPdfName = ''; // Stocke le nom du PDF\n\n    this.selectedPdf = null;\n    this.displayPdfDialog = false;\n    this.devisSinistreDialog = false;\n    this.actionLabel = 'Enregistrer';\n    this.deleteDevisDialog = false;\n    this.devisSinistres = [];\n    this.submitted = false;\n    this.selectedDevis = [];\n    this.displayDialog = false;\n    this.selectedFiles = [];\n    this.expertId = null;\n    this.clientId = null;\n    this.clients = [];\n    this.experts = [];\n    this.selectedExpertId = null;\n    this.documentsCommun = []; // ✅ Correction du type\n\n    this.selectedDocument = null;\n    this.cols = [];\n    this.rowsPerPageOptions = [5, 10, 20];\n    this.expertInfos = {}; // Stocke les infos par document ID\n\n    this.selectedExpert = null;\n    this.displayExpertDialog = false;\n    this.displayClientDialog = false;\n    this.selectedClient = null;\n  }\n\n  ngOnInit() {\n    const userRole = this.getUserRole();\n    this.clientId = this.getUserId();\n    console.log(\"client ID récupéré :\", this.clientId); // Vérifier l'ID récupéré\n\n    if (userRole === \"PersonnePhysique\" || userRole === \"PersonneMorale\") {\n      if (this.clientId) {\n        this.getExpertByClient(this.clientId);\n      }\n    }\n\n    this.getAllDevis();\n  }\n\n  getUserRole() {\n    return localStorage.getItem('userRole');\n  }\n\n  openNew() {\n    this.devisSinistre = new DevisSinistre([], new Expert('', '', '', '', '', '', 0, '', ''), // Fournir des valeurs par défaut\n    new Clients('', '', '', '', '', '', 'PersonneMorale'), // Fournir des valeurs par défaut\n    new Date(), new Documents('', '', '') // Fournir des valeurs par défaut\n    );\n    this.submitted = false;\n    this.devisSinistreDialog = true;\n    this.actionLabel = 'Enregistrer';\n  }\n\n  getUserId() {\n    return localStorage.getItem('user_id');\n  } // Récupérer la liste des clients liés à l'expert\n\n\n  getExpertByClient(clientId) {\n    this.authservice.getUserProfile(clientId).subscribe(client => {\n      console.log(\"Réponse API Client :\", client);\n\n      if (client && client.experts && Array.isArray(client.experts) && client.experts.length > 0) {\n        // Réinitialiser la liste des experts\n        this.experts = []; // Récupérer chaque expert associé\n\n        client.experts.forEach(expertId => {\n          this.expertService.getExpertById(expertId).subscribe(expertData => {\n            this.experts.push(expertData);\n            console.log(\"Expert récupéré :\", expertData);\n          }, error => {\n            console.error(`Erreur lors de la récupération de l'expert ${expertId} :`, error);\n          });\n        });\n      } else {\n        console.warn(\"Aucun expert trouvé pour ce client.\");\n        this.experts = [];\n      }\n    }, error => {\n      console.error(\"Erreur lors de la récupération du client :\", error);\n    });\n  } // Récupérer les documents communs entre le client et l'expert\n  // Récupérer les documents communs entre le client et l'expert\n\n\n  getDocumentsCommunByClient() {\n    if (!this.selectedExpertId || !this.clientId) return;\n    this.authservice.getUserProfile(this.clientId).subscribe(client => {\n      this.expertService.getExpertById(this.selectedExpertId).subscribe(expert => {\n        const clientDocs = client.documents || [];\n        const expertDocs = expert.documents || []; // Trouver les documents en commun (IDs)\n\n        const documentsCommunIds = clientDocs.filter(doc => expertDocs.includes(doc));\n\n        if (documentsCommunIds.length === 0) {\n          this.documentsCommun = [];\n          console.warn(\"Aucun document commun trouvé.\");\n          return;\n        } // Récupérer les objets `Documents` complets\n\n\n        const requests = documentsCommunIds.map(id => this.documentService.getDocById(id));\n        forkJoin(requests).subscribe(documents => {\n          // ✅ Convertir en objets pour forcer la détection des changements\n          this.documentsCommun = documents.map(d => Object.assign(new Documents(\"\", \"\", \"\"), d));\n          console.log(\"Documents communs :\", this.documentsCommun);\n        }, error => {\n          console.error(\"Erreur lors de la récupération des documents :\", error);\n        });\n      }, error => {\n        console.error(\"Erreur lors de la récupération des documents de l'expert :\", error);\n      });\n    }, error => {\n      console.error(\"Erreur lors de la récupération des documents du client :\", error);\n    });\n  }\n\n  onFileSelected(event) {\n    this.selectedFiles = Array.from(event.target.files);\n    console.log(\"Fichiers PDF sélectionnés :\", this.selectedFiles);\n  }\n\n  uploadDevis() {\n    if (!this.clientId || !this.selectedExpertId || !this.selectedDocument) {\n      console.error(\"Veuillez sélectionner un expert et un document avant l'envoi !\");\n      return;\n    }\n\n    if (!this.selectedFiles || this.selectedFiles.length === 0) {\n      console.error(\"Erreur : Aucun fichier sélectionné !\");\n      return;\n    }\n\n    console.log(\"Document ID sélectionné :\", this.selectedDocument.Id);\n    const formData = new FormData();\n    this.selectedFiles.forEach(file => {\n      if (file instanceof File) {\n        if (file.type !== \"application/pdf\") {\n          console.error(\"Fichier non valide (doit être un PDF) :\", file.name);\n          return;\n        }\n\n        formData.append('devis', file);\n      } else {\n        console.error(\"Fichier invalide détecté :\", file);\n      }\n    }); // Vérification que les fichiers sont bien ajoutés\n\n    if (!formData.has('devis')) {\n      console.error(\"Aucun fichier PDF ajouté à FormData !\");\n      return;\n    }\n\n    formData.append('clientId', this.clientId);\n    formData.append('expertId', this.selectedExpertId);\n    formData.append('documentId', this.selectedDocument.Id);\n    console.log(\"Données envoyées :\");\n    formData.forEach((value, key) => console.log(`${key}:`, value));\n    this.authservice.addDevisSinistre(formData).subscribe(response => {\n      console.log(\"PDF envoyé avec succès :\", response);\n      this.selectedFiles = [];\n      this.selectedDocument = null;\n    }, error => {\n      console.error(\"Erreur lors de l'envoi du PDF :\", error);\n    });\n  }\n\n  removeFile(file) {\n    this.selectedFiles = this.selectedFiles.filter(f => f !== file);\n  }\n\n  openDialog(devis, index) {\n    this.displayDialog = true;\n  }\n\n  onGlobalFilter(table, event) {\n    table.filterGlobal(event.target.value, 'contains');\n  }\n\n  getAllDevis() {\n    if (!this.clientId) {\n      console.error('Aucun ID expert trouvé dans localStorage');\n      return;\n    }\n\n    if (this.getUserRole() === 'expert') {\n      this.expertService.getDevisByExpert(this.clientId).subscribe(devisList => {\n        this.devisSinistres = devisList;\n        console.log(\"devisSinistres convertis:\", this.devisSinistres); // Pour chaque devis, récupérer les détails complets de l'expert\n\n        this.devisSinistres.forEach((devis, index) => {\n          const expertId = typeof devis.Expert === 'string' ? devis.Expert : devis.Expert.Id;\n          this.expertService.getExpertById(expertId).subscribe(expertData => {\n            this.devisSinistres[index].Expert = expertData;\n          }, error => {\n            console.error(`Erreur lors de la récupération de l'expert:`, error);\n          });\n        });\n      }, error => {\n        console.error('Erreur lors de la récupération des devis:', error);\n      });\n    } else if (this.getUserRole() === 'PersonnePhysique' || this.getUserRole() === 'PersonneMorale') {\n      this.authservice.getDevisByClient(this.clientId).subscribe(devisList => {\n        this.devisSinistres = devisList;\n        console.log(\"devisSinistres convertis:\", this.devisSinistres); // Pour chaque devis, récupérer les détails complets de l'expert\n\n        this.devisSinistres.forEach((devis, index) => {\n          const clientId = typeof devis.Client === 'string' ? devis.Client : devis.Client.Id;\n          this.authservice.getUserProfile(clientId).subscribe(clientData => {\n            this.devisSinistres[index].Client = clientData;\n          }, error => {\n            console.error(`Erreur lors de la récupération du client:`, error);\n          });\n        });\n      }, error => {\n        console.error('Erreur lors de la récupération des devis:', error);\n      });\n    } else if (this.getUserRole() === 'admin' || this.getUserRole() === 'gestionnaire_sinistre') {\n      this.devisService.getDevisSinistres().subscribe(devis => {\n        console.log(\"Raw API response:\", JSON.stringify(devis));\n        this.devisSinistres = devis;\n        console.log(\"devisSinistres: \", this.devisSinistres);\n      }, error => {\n        console.error('Erreur lors de la récupération des devis:', error);\n      });\n    }\n  }\n\n  openPdf(pdfPath) {\n    if (!pdfPath) {\n      console.error(\"Aucun chemin de PDF fourni !\");\n      return;\n    }\n\n    const fullPath = `http://localhost:9090/pdf/${pdfPath}`;\n    this.selectedPdf = this.sanitizer.bypassSecurityTrustResourceUrl(fullPath);\n    this.selectedPdfName = pdfPath;\n    this.displayPdfDialog = true;\n  }\n\n  getExpertInfo(expertId, docId) {\n    if (!expertId) {\n      console.error(\"Aucun ID d'expert fourni.\");\n      this.expertInfos[docId] = \"Il n'y a pas encore un expert affecté\";\n      return;\n    }\n\n    this.expertService.getExpertById(expertId).subscribe(expert => {\n      if (expert) {\n        this.expertInfos[docId] = `${expert.nom} ${expert.prenom} `;\n      } else {\n        this.expertInfos[docId] = \"Expert introuvable\";\n      }\n    }, error => {\n      this.expertInfos[docId] = \"Il n'y a pas d'expert affecté pour le moment\";\n    });\n  }\n\n  showExpertInfo(expertId) {\n    console.log(\"ID de l'expert reçu :\", expertId); // Vérification\n\n    if (!expertId) {\n      console.error(\"Aucun ID Expert fourni.\");\n      return;\n    }\n\n    this.expertService.getExpertById(expertId).subscribe(expert => {\n      console.log(\"Données de l'expert reçues :\", expert); // Vérification\n\n      this.selectedExpert = expert;\n      this.displayExpertDialog = true;\n    }, error => {\n      console.error(\"Erreur lors du chargement de l'expert :\", error);\n      this.selectedExpert = {\n        error: \"Erreur lors du chargement du client\"\n      };\n      this.displayExpertDialog = true;\n    });\n  }\n\n  showClientInfo(clientId) {\n    if (!clientId) {\n      console.error(\"Aucun ID client fourni.\");\n      return;\n    }\n\n    this.authservice.getUserProfile(clientId).subscribe(client => {\n      this.selectedClient = client; // Stocker les données du client\n\n      this.displayClientDialog = true; // Ouvrir le dialog\n    }, error => {\n      this.selectedClient = {\n        error: \"Erreur lors du chargement du client\"\n      };\n      this.displayClientDialog = true;\n    });\n  }\n\n};\nDevisSinistreComponent = __decorate([Component({\n  selector: 'app-devis-sinistre',\n  templateUrl: './devis-sinistre.component.html',\n  styleUrl: './devis-sinistre.component.scss'\n})], DevisSinistreComponent);\nexport { DevisSinistreComponent };","map":null,"metadata":{},"sourceType":"module"}